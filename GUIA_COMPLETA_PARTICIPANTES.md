# üìö Gu√≠a Completa: Participantes en Producci√≥n

## üéØ C√≥mo Usar el Sistema (Paso a Paso)

### 1Ô∏è‚É£ Seleccionar Participantes en la P√°gina de Recetas

1. **Navegar a Recetas:**
   - Desde inicio, click en "Ventas"
   - Selecciona una fecha en el calendario (ej: 30 Nov 2024)
   - Click en "Ingredientes necesarios"
   - Click en "Receta"

2. **Ver√°s una nueva secci√≥n rosa en la parte superior:**
   ```
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ üìÖ Fecha de producci√≥n: [30/11/2024]            ‚îÇ
   ‚îÇ      [üíæ Guardar Todo]  [üìã Ver Registros]      ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
   ```

3. **La fecha se pre-llena autom√°ticamente** con la fecha que seleccionaste en el calendario

4. **Seleccionar participantes:**
   - Despl√°zate por cada tipo de postre (Arco, Melo, Mara, Oreo, Nute)
   - A la derecha de cada postre ver√°s botones de usuarios
   - Click en los nombres de las personas que participaron
   - Los botones se ponen rosados cuando est√°n seleccionados
   - **IMPORTANTE:** Los cambios NO se guardan autom√°ticamente

5. **Guardar:**
   - Cuando termines de seleccionar todos los participantes
   - Click en el bot√≥n **"üíæ Guardar Todo"** en la parte superior
   - Ver√°s un mensaje verde: "‚úÖ Todo guardado correctamente (X postres)"

6. **Navegaci√≥n:**
   - **üè† Inicio:** Bot√≥n nuevo en el header para volver al inicio
   - **Volver:** Vuelve a la p√°gina anterior (ingredientes)
   - **üìã Ver Registros:** Abre directamente la p√°gina de entregas

### 2Ô∏è‚É£ Ver Participantes en la P√°gina de Entregas

1. **Navegar a Entregas:**
   - Desde inicio, click en "Entregas"
   - O desde Recetas, click en "üìã Ver Registros"

2. **Encontrar los participantes:**
   - Busca la fecha que seleccionaste (ej: 30 Noviembre 2024)
   - Inmediatamente despu√©s de la fecha (fila azul) ver√°s:
   ```
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ  30 Noviembre 2024                             ‚îÇ ‚Üê Azul
   ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
   ‚îÇ  üë• Participantes:  Marcela, Aleja | Jorge | - ‚îÇ ‚Üê Rosa (NUEVA FILA)
   ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
   ‚îÇ  Vendedor           Arco    Melo    Mara  ...  ‚îÇ
   ‚îÇ  Marcela            50      30      25    ...  ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
   ```

3. **Interpretaci√≥n:**
   - Cada columna corresponde a un postre
   - Los nombres separados por comas son los participantes
   - Si no hay participantes, se muestra "-"

## üîß Cambios Implementados

### P√°gina de Recetas (`receta.html`)

#### ‚úÖ Nuevos Elementos UI:
1. **Bot√≥n "üè† Inicio"** en el header (arriba a la izquierda)
2. **Panel de control rosa** con:
   - Selector de fecha de producci√≥n (pre-llenado con fecha seleccionada)
   - Bot√≥n "üíæ Guardar Todo"
   - Bot√≥n "üìã Ver Registros"
3. **Barra de estado** (muestra mensajes de √©xito/error)

#### ‚úÖ Funcionalidad:
- Los participantes se almacenan localmente hasta que des click en "Guardar"
- El selector de fecha usa la fecha que seleccionaste en ventas
- Guardado batch: todos los postres se guardan de una vez
- Feedback visual con mensajes de estado

### API de Entregas (`netlify/functions/deliveries.js`)

#### ‚úÖ Nuevas Queries:
```javascript
// Obtiene participantes de delivery_production_users
SELECT 
    d.day,
    des.short_code,
    u.username
FROM delivery_production_users dpu
JOIN deliveries d ON d.id = dpu.delivery_id
JOIN desserts des ON des.id = dpu.dessert_id
JOIN users u ON u.id = dpu.user_id
ORDER BY d.day, des.short_code, u.username
```

#### ‚úÖ Estructura de Datos:
```json
{
  "day": "2024-11-30",
  "sellers": [...],
  "production_users": {
    "arco": ["Marcela", "Aleja"],
    "melo": ["Jorge"],
    "mara": [],
    "oreo": ["Marcela"],
    "nute": []
  }
}
```

### P√°gina de Entregas (`deliveries.html`)

#### ‚úÖ Nueva Fila:
- Se renderiza despu√©s del encabezado de fecha
- Fondo rosa suave: `rgba(244, 166, 183, 0.08)`
- Solo aparece si hay al menos un participante
- Formato: `üë• Participantes: [nombres por columna]`

## üß™ C√≥mo Verificar que Funciona

### Test 1: Flujo Completo

```
1. Inicio ‚Üí Ventas
2. Seleccionar fecha: 30 Nov 2024
3. Ingredientes ‚Üí Receta
4. Verificar que la fecha muestra "30/11/2024"
5. Seleccionar participantes en cada postre
6. Click en "üíæ Guardar Todo"
7. Mensaje verde: "‚úÖ Todo guardado correctamente"
8. Click en "üìã Ver Registros"
9. Buscar la fecha "30 Noviembre 2024"
10. Ver la fila "üë• Participantes:" con los nombres
```

### Test 2: Consola del Navegador

**En p√°gina de Recetas (despu√©s de seleccionar):**
```javascript
// Deber√≠a mostrar logs como:
// ‚úèÔ∏è Updated selection for arco: [1, 2]
// ‚úèÔ∏è Updated selection for melo: [3]
```

**Despu√©s de guardar:**
```javascript
// Deber√≠a mostrar:
// üíæ Saving users for arco on 2024-11-30: [1, 2]
// ‚úÖ Saved successfully: {ok: true, saved: 2}
```

**En p√°gina de Entregas:**
```javascript
fetch('/api/deliveries?sales_consolidated=true')
  .then(r => r.json())
  .then(d => {
    console.log('Datos:', d);
    console.log('Participantes:', d[0].production_users);
  });
```

### Test 3: Verificaci√≥n Visual

**Recetas:**
- [ ] Hay un bot√≥n "üè† Inicio" en el header
- [ ] Hay un panel rosa con selector de fecha
- [ ] La fecha est√° pre-llenada
- [ ] Los botones de usuarios se ponen rosados al seleccionar
- [ ] Al click en "Guardar" aparece mensaje verde
- [ ] El bot√≥n "Ver Registros" abre entregas

**Entregas:**
- [ ] Hay una fila rosa despu√©s de cada fecha
- [ ] La fila dice "üë• Participantes:"
- [ ] Los nombres aparecen en la columna del postre correcto
- [ ] Los postres sin participantes muestran "-"

## üêõ Soluci√≥n de Problemas

### Problema: "No veo la fila de participantes en Entregas"

**Diagn√≥stico:**
```javascript
// En consola de Entregas
fetch('/api/deliveries?sales_consolidated=true')
  .then(r => r.json())
  .then(d => {
    if (!d[0]?.production_users) {
      console.error('‚ùå production_users no est√° en los datos');
    } else {
      console.log('‚úÖ production_users encontrado:', d[0].production_users);
    }
  });
```

**Soluciones:**
1. Refresca la p√°gina con Ctrl+F5
2. Verifica que guardaste con el bot√≥n "Guardar Todo"
3. Verifica que la fecha coincide con la que seleccionaste
4. Usa `/test_participantes.html` para verificar los datos

### Problema: "La fecha no coincide con la que seleccion√©"

**Causa:** La fecha puede haber sido modificada manualmente

**Soluci√≥n:**
1. Verifica la fecha en el selector rosa de la p√°gina Recetas
2. Cambia la fecha manualmente si es necesario
3. Vuelve a guardar

### Problema: "No aparece el mensaje de guardado"

**Causa:** Error en la API o no hay selecciones

**Diagn√≥stico:**
```javascript
// En consola de Recetas despu√©s de seleccionar
console.log(selectedUsersByDessert);
// Deber√≠a mostrar: { arco: [1, 2], melo: [3], ... }
```

**Soluci√≥n:**
1. Abre la consola del navegador (F12)
2. Busca errores en rojo
3. Verifica que seleccionaste al menos un participante
4. Intenta guardar de nuevo

### Problema: "No veo usuarios para seleccionar"

**Causa:** No hay usuarios en la base de datos

**Soluci√≥n:**
1. Abre `/diagnostico-usuarios.html`
2. Click en "Test Get Users"
3. Si no hay usuarios, se usar√°n los "sellers" autom√°ticamente
4. Verifica que existan registros en la tabla `sellers`

## üìä Estructura de Datos

### Base de Datos

**Tabla `recipe_production_users`:**
```sql
CREATE TABLE recipe_production_users (
    id SERIAL PRIMARY KEY,
    dessert TEXT NOT NULL,
    user_id INTEGER NOT NULL REFERENCES users(id),
    session_date DATE NOT NULL DEFAULT CURRENT_DATE,
    created_at TIMESTAMPTZ DEFAULT now(),
    UNIQUE (dessert, user_id, session_date)
);
```

**Tabla `delivery_production_users`:**
```sql
CREATE TABLE delivery_production_users (
    id SERIAL PRIMARY KEY,
    delivery_id INTEGER NOT NULL REFERENCES deliveries(id),
    dessert_id INTEGER NOT NULL REFERENCES desserts(id),
    user_id INTEGER NOT NULL REFERENCES users(id),
    created_at TIMESTAMPTZ DEFAULT now(),
    UNIQUE (delivery_id, dessert_id, user_id)
);
```

### Sincronizaci√≥n Autom√°tica

Cuando guardas participantes en Recetas, el sistema:

1. **Guarda en `recipe_production_users`:**
   - dessert: "arco", "melo", etc.
   - user_id: IDs de usuarios seleccionados
   - session_date: Fecha del selector

2. **Busca o crea delivery:**
   - Busca un delivery con `day = session_date`
   - Si no existe, crea uno nuevo

3. **Guarda en `delivery_production_users`:**
   - delivery_id: ID del delivery encontrado/creado
   - dessert_id: ID del dessert en la tabla `desserts`
   - user_id: IDs de usuarios seleccionados

## üöÄ Mejoras Futuras Sugeridas

1. **Edici√≥n en Entregas:**
   - Permitir editar participantes directamente en la p√°gina de entregas
   - Bot√≥n "‚úèÔ∏è Editar" junto a "üë• Participantes:"

2. **Historial:**
   - Modal con historial de participaciones por usuario
   - Estad√≠sticas de participaci√≥n

3. **Auto-sugerencias:**
   - Pre-seleccionar participantes basado en historial
   - "Usar participantes de la √∫ltima vez"

4. **Notificaciones:**
   - Recordatorio si no se han registrado participantes
   - Confirmaci√≥n por WhatsApp/email a los participantes

## üìû Soporte

Si encuentras problemas:

1. **Verifica la consola del navegador (F12)**
2. **Usa las p√°ginas de diagn√≥stico:**
   - `/test_participantes.html`
   - `/diagnostico-usuarios.html`
3. **Revisa este documento**
4. **Verifica los datos en la base de datos** con las queries SQL de arriba

---

‚úÖ **Sistema completamente funcional y probado**
üìÖ Implementado: 30 Noviembre 2024

<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Contabilidad</title>
	<link rel="stylesheet" href="/styles.css?v=2025-09-17-1" />
	<style>
		/* Oculta el √≠cono/calendario nativo del input de fecha para evitar duplicado */
		#acc-date { -webkit-appearance: none; -moz-appearance: none; appearance: none; }
		#acc-date::-webkit-calendar-picker-indicator { display: none; }
		/* Mismo borde redondeado y fondo para los campos del formulario */
		#acc-form .input-cell { border: 1px solid var(--border); background: var(--card); }
		/* Quitar flechas en input number (Valor) */
		#acc-value { -moz-appearance: textfield; }
		#acc-value::-webkit-outer-spin-button, #acc-value::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
		/* Bot√≥n de adjunto por fila */
		.attach-btn { width: 22px; height: 22px; border-radius: 50%; border: 1px solid var(--border); background: transparent; color: var(--foreground); font-weight: 700; line-height: 1; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; }
		.attach-btn.has { background: #ad1457; color: #fff; border-color: #ad1457; }
		/* Celdas editables */
		.editable { 
			cursor: pointer; 
			transition: background-color 0.2s ease, transform 0.1s ease;
			padding: 4px 8px;
			border-radius: 4px;
		}
		.editable:hover {
			background-color: rgba(244, 166, 183, 0.15);
			transform: scale(1.02);
		}
		.editable:active {
			transform: scale(0.98);
		}
		/* Estilos para los botones de meses */
		.month-buttons {
			display: flex;
			gap: 8px;
			justify-content: center;
			flex-wrap: wrap;
			margin: 16px 12px;
			padding: 12px;
		}
		.month-btn {
			padding: 10px 18px;
			border: 1px solid var(--border);
			background: var(--card);
			color: var(--foreground);
			border-radius: 6px;
			cursor: pointer;
			font-size: 14px;
			font-weight: 500;
			transition: all 0.2s ease;
			min-width: 100px;
		}
		.month-btn:hover {
			background: var(--hover-primary-pink, #e27a90);
			color: white;
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(244, 166, 183, 0.3);
			border-color: var(--primary);
		}
		.month-btn:active {
			transform: translateY(0);
		}
		.month-btn.active {
			background: var(--primary, #f4a6b7);
			color: white;
			border-color: var(--primary);
			box-shadow: 0 4px 12px rgba(244, 166, 183, 0.2);
		}
	</style>
</head>
<body>
	<header class="app-header">
		<div class="header-row">
			<div class="header-left">
				<img src="/logo.png" alt="Lulitas Logo" class="app-logo" />
				<h1>Contabilidad</h1>
			</div>
			<div class="header-actions">
				<button id="back-btn" class="press-btn">Volver</button>
			</div>
		</div>
	</header>

	<main class="sales-panel">
			<div class="panel-header">
			<h3>Nuevo registro</h3>
			<div class="panel-actions">
					<button id="download-range" class="press-btn">Descargar adjuntos</button>
					<button id="change-range" class="press-btn">Cambiar fechas</button>
			</div>
		</div>
		<div class="panel-body">
			<div class="month-buttons" id="month-buttons">
				<!-- Los botones de meses se generar√°n din√°micamente -->
			</div>
			<div style="display:flex; justify-content:space-between; align-items:center; margin:0 12px 8px 12px">
				<strong id="range-label"></strong>
				<small id="count-label" style="opacity:.8"></small>
			</div>
			<div style="margin:0 12px 12px 12px; padding:8px 12px; background-color:rgba(244, 166, 183, 0.1); border-left:3px solid var(--primary); border-radius:4px;">
				<small style="opacity:.85">üí° <strong>Consejo:</strong> Haz clic en las celdas de Fecha, Descripci√≥n, Ingreso o Salida para editarlas</small>
			</div>
			<div class="table-wrapper" style="padding:12px;">
				<form id="acc-form" style="display:flex; flex-direction:column; gap:12px; max-width:520px; margin:0 auto;">
					<div style="display:flex; gap:12px; justify-content:center; width:300px; margin:40px auto 20px auto;">
						<button id="btn-ingreso" type="button" class="press-btn btn-primary" aria-pressed="true" style="flex:1 1 0; padding:14px 22px; font-size:16px; border-radius:12px;">Ingreso</button>
						<button id="btn-salida" type="button" class="press-btn btn-primary" aria-pressed="false" style="flex:1 1 0; padding:14px 22px; font-size:16px; border-radius:12px;">Salida</button>
					</div>
					<label style="display:flex; gap:8px; align-items:center; justify-content:center;">
						<span style="min-width:92px;">Fecha</span>
						<div style="position:relative; width:auto; min-width:200px;">
							<input id="acc-date" type="date" class="input-cell" required style="width:200px; padding-right:42px;" />
							<button id="acc-date-icon" type="button" title="Calendario" aria-label="Abrir calendario" style="position:absolute; right:4px; top:50%; transform: translateY(-50%); padding:6px 8px; border:none; background:transparent; box-shadow:none;">üìÖ</button>
						</div>
					</label>
					<label style="display:flex; gap:8px; align-items:center; justify-content:center;">
						<span style="min-width:92px;">Descripci√≥n</span>
						<input id="acc-desc" type="text" class="input-cell" placeholder="Descripci√≥n" required style="width:200px" />
					</label>
					<label style="display:flex; gap:8px; align-items:center; justify-content:center;">
						<span style="min-width:92px;">Valor</span>
						<input id="acc-value" type="number" inputmode="numeric" class="input-cell" placeholder="0" required style="width:200px" />
					</label>
					<div style="display:flex; gap:8px; justify-content:flex-end; width:300px; margin:20px auto 50px auto;">
						<button id="acc-cancel" type="button" class="press-btn">Cancelar</button>
						<button id="acc-save" type="submit" class="press-btn btn-primary">Guardar</button>
					</div>
				</form>
			</div>
					<div class="table-wrapper" id="acc-wrapper" style="margin-top:12px;">
				<table id="acc-table">
					<thead>
						<tr>
							<th></th>
									<th>Fecha</th>
									<th>Descripci√≥n</th>
									<th class="col-total">Ingreso</th>
									<th class="col-total">Salida</th>
									<th class="col-total">Saldo</th>
							<th></th>
							<th></th>
							<th></th>
						</tr>
					</thead>
						<tbody id="acc-tbody"></tbody>
						<tfoot>
								<tr><td colspan="8" style="height:30px; border-bottom:none; background:transparent;"></td></tr>
								<tr>
									<td></td>
									<td></td>
									<td class="label">Ingresos</td>
									<td class="col-total" id="t-ingresos"></td>
									<td></td>
									<td></td>
									<td></td>
									<td></td>
								</tr>
								<tr>
									<td></td>
									<td></td>
									<td class="label">Salidas</td>
									<td></td>
									<td class="col-total" id="t-gastos"></td>
									<td></td>
									<td></td>
									<td></td>
								</tr>
								<tr>
									<td></td>
									<td></td>
									<td class="label">Saldo</td>
									<td></td>
									<td></td>
									<td class="col-total" id="t-balance" style="color: var(--accent); font-weight: 700;"></td>
									<td></td>
									<td></td>
								</tr>
						</tfoot>
				</table>
			</div>
		</div>
	</main>

	<script type="module">
	(function(){
		// Gate: only superadmin
		let currentUser = null;
		try { const saved = localStorage.getItem('authUser'); if (saved) currentUser = JSON.parse(saved); } catch {}
		const isSuper = currentUser && (currentUser.role === 'superadmin' || !!currentUser.isSuperAdmin);
		if (!isSuper) { alert('Solo el superadministrador'); location.href = '/'; return; }

		// Default fecha = hoy (UTC)
		const dateInput = document.getElementById('acc-date');
		const today = new Date();
		const iso = new Date(Date.UTC(today.getFullYear(), today.getMonth(), today.getDate())).toISOString().slice(0,10);
		dateInput.value = iso;

		const rangeLabel = document.getElementById('range-label');
		const countLabel = document.getElementById('count-label');
		const tbody = document.getElementById('acc-tbody');
		const tIng = document.getElementById('t-ingresos');
		const tGas = document.getElementById('t-gastos');
		const tBal = document.getElementById('t-balance');
		const changeBtn = document.getElementById('change-range');
		const downloadBtn = document.getElementById('download-range');
		const btnIngreso = document.getElementById('btn-ingreso');
		const btnSalida = document.getElementById('btn-salida');
		let currentKind = 'ingreso';

		function setKind(kind){
			currentKind = kind === 'salida' ? 'gasto' : 'ingreso';
			const isIngreso = currentKind === 'ingreso';
			btnIngreso.setAttribute('aria-pressed', isIngreso ? 'true' : 'false');
			btnSalida.setAttribute('aria-pressed', isIngreso ? 'false' : 'true');
			// Selected retains hover appearance permanently
			const activeStyles = (el, active) => {
				if (active) {
					el.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--hover-primary-pink') || '#e27a90';
					el.style.boxShadow = '0 8px 24px var(--hover-shadow-pink)';
				} else {
					el.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--primary') || '#f4a6b7';
					el.style.boxShadow = '';
				}
			};
			activeStyles(btnIngreso, isIngreso);
			activeStyles(btnSalida, !isIngreso);
		}
		btnIngreso.addEventListener('click', () => setKind('ingreso'));
		btnSalida.addEventListener('click', () => setKind('salida'));

		function formatDay(diso){ if (!diso) return ''; const d=new Date(diso+'T00:00:00Z'); const m=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre']; return `${d.getUTCDate()} ${m[d.getUTCMonth()]} ${d.getUTCFullYear()}`; }

		// Range: current month by default
		let start = new Date(Date.UTC(today.getFullYear(), today.getMonth(), 1)).toISOString().slice(0,10);
		let end = new Date(Date.UTC(today.getFullYear(), today.getMonth()+1, 0)).toISOString().slice(0,10);

		// Generate last 6 months buttons
		const monthButtons = document.getElementById('month-buttons');
		const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
		
		function generateMonthButtons() {
			monthButtons.innerHTML = '';
			const now = new Date();
			const currentYear = now.getFullYear();
			const currentMonth = now.getMonth();
			const months = [];
			
			// Generate last 6 months including current month
			for (let i = 5; i >= 0; i--) {
				const targetYear = currentYear;
				const targetMonth = currentMonth - i;
				const date = new Date(Date.UTC(targetYear, targetMonth, 1));
				const monthStart = new Date(Date.UTC(date.getFullYear(), date.getMonth(), 1)).toISOString().slice(0,10);
				const monthEnd = new Date(Date.UTC(date.getFullYear(), date.getMonth() + 1, 0)).toISOString().slice(0,10);
				
				months.push({
					name: monthNames[date.getMonth()],
					year: date.getFullYear(),
					start: monthStart,
					end: monthEnd,
					isCurrent: i === 0
				});
			}
			
			// Create buttons
			months.forEach((month, index) => {
				const btn = document.createElement('button');
				btn.className = 'month-btn';
				btn.textContent = `${month.name} ${month.year}`;
				btn.dataset.start = month.start;
				btn.dataset.end = month.end;
				
				// Mark current month as active by default
				if (month.isCurrent) {
					btn.classList.add('active');
				}
				
				// Click handler
				btn.addEventListener('click', () => {
					// Remove active class from all buttons
					monthButtons.querySelectorAll('.month-btn').forEach(b => b.classList.remove('active'));
					// Add active class to clicked button
					btn.classList.add('active');
					// Update range and reload data
					start = month.start;
					end = month.end;
					load();
				});
				
				monthButtons.appendChild(btn);
			});
			
			console.log('Meses generados:', months.map(m => `${m.name} ${m.year}`).join(', '));
		}
		
		// Initialize month buttons
		generateMonthButtons();

		async function fetchJSON(u, opts){ const r = await fetch(u, opts); if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); }
		function fmtMoney(n){ const v = Number(n||0); try { return new Intl.NumberFormat('es-CO').format(v); } catch { return String(v); } }

		function renderRows(rows){
			tbody.innerHTML = '';
			let sumIng = 0, sumGas = 0, running = 0;
			for (const r of (rows||[])){
				const tr = document.createElement('tr');
				const v = Number(r.amount_cents||0);
				const isIng = (r.kind||'') === 'ingreso';
				if (isIng) { sumIng += v; running += v; } else { sumGas += v; running -= v; }
				const colIng = isIng ? fmtMoney(v) : '';
				const colSal = !isIng ? fmtMoney(v) : '';
				const hasAtt = !!(r.has_attachment);
				tr.innerHTML = `
					<td style="text-align:center; width:28px"><button class="attach-btn${hasAtt ? ' has' : ''}" data-id="${r.id}" title="Adjuntar archivo" aria-label="Adjuntar">${hasAtt ? '‚óè' : '-'}</button></td>
					<td class="editable" data-field="entry_date" title="Clic para editar fecha">${String(r.entry_date||'').slice(0,10)}</td>
					<td class="editable" data-field="description" title="Clic para editar descripci√≥n">${r.description||''}</td>
					<td class="col-total editable" data-field="amount_cents" data-kind="ingreso" title="${isIng ? 'Clic para editar ingreso' : ''}">${colIng}</td>
					<td class="col-total editable" data-field="amount_cents" data-kind="gasto" title="${!isIng ? 'Clic para editar salida' : ''}">${colSal}</td>
					<td class="col-total">${fmtMoney(running)}</td>
				<td style="padding-right:2px;"><button class="row-duplicate" data-dup="${r.id}" title="Duplicar" aria-label="Duplicar"></button></td>
				<td style="padding-left:2px;"><button class="row-delete" data-del="${r.id}" title="Eliminar" aria-label="Eliminar"></button></td>
				`;
				// removed per-row download
				tbody.appendChild(tr);
				// Wire attachment upload or view
				const attBtn = tr.querySelector('.attach-btn');
				attBtn.addEventListener('click', async () => {
					// If already has attachment, fetch and preview
					if (attBtn.classList.contains('has')) {
						try {
							const res = await fetch(`/api/accounting?attachment_for=${encodeURIComponent(r.id)}`);
							if (!res.ok) { alert('No se pudo cargar el adjunto'); return; }
							const obj = await res.json();
							const src = obj.file_base64;
							// Simple lightbox
							const backdrop = document.createElement('div'); backdrop.className = 'lightbox-backdrop';
							const box = document.createElement('div'); box.className = 'lightbox';
							const img = document.createElement('img'); img.src = src; img.alt = 'Adjunto';
							const actions = document.createElement('div'); actions.className = 'lightbox-actions';
							const closeBtn = document.createElement('button'); closeBtn.className = 'press-btn'; closeBtn.textContent = 'Cerrar';
							const downBtn = document.createElement('button'); downBtn.className = 'press-btn'; downBtn.textContent = 'Descargar';
							actions.append(closeBtn, downBtn); box.append(img, actions);
							backdrop.appendChild(box); document.body.appendChild(backdrop);
							function cleanup(){ document.removeEventListener('keydown', onKey); if (backdrop.parentNode) backdrop.parentNode.removeChild(backdrop); }
							function onKey(e){ if (e.key === 'Escape') cleanup(); }
							backdrop.addEventListener('click', (e) => { if (e.target === backdrop) cleanup(); });
							closeBtn.addEventListener('click', cleanup);
							downBtn.addEventListener('click', () => { const a=document.createElement('a'); a.href = src; a.download = obj.file_name || `adjunto_${r.id}.bin`; document.body.appendChild(a); a.click(); a.remove(); });
						} catch (e) { console.error(e); alert('Error al abrir adjunto'); }
						return;
					}
					// Else upload new
					try {
						const input = document.createElement('input'); input.type = 'file'; input.accept = '*/*';
						input.addEventListener('change', async () => {
							if (!input.files || !input.files[0]) return;
							const file = input.files[0];
							const reader = new FileReader();
							reader.onload = async () => {
								const dataUrl = String(reader.result || '');
								try {
									attBtn.disabled = true;
									const res = await fetch('/api/accounting', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Actor-Name': currentUser?.name || '' }, body: JSON.stringify({ _upload_attachment_for: r.id, file_base64: dataUrl, file_name: file.name, mime_type: file.type }) });
									if (!res.ok) { alert('Error al subir archivo'); attBtn.disabled = false; return; }
									attBtn.disabled = false;
									attBtn.classList.add('has'); attBtn.textContent = '‚óè';
								} catch (e) { console.error(e); alert('Error al subir archivo'); attBtn.disabled = false; }
							};
							reader.readAsDataURL(file);
						});
						input.click();
					} catch {}
				});
				// Wire inline edits
				const tds = tr.querySelectorAll('td');
				const tdDate = tds[1];
				const tdDesc = tds[2];
				const tdIng = tds[3];
				const tdSal = tds[4];
				tdDesc.addEventListener('click', async () => {
					const val = prompt('Descripci√≥n', r.description || '');
					if (val == null) return;
					try {
						const res = await fetch('/api/accounting', { method: 'PUT', headers: { 'Content-Type': 'application/json', 'X-Actor-Name': currentUser?.name || '' }, body: JSON.stringify({ id: r.id, description: String(val) }) });
						if (!res.ok) {
							const err = await res.json().catch(() => ({}));
							alert('Error al guardar: ' + (err.error || res.status));
							return;
						}
						await load();
					} catch (e) { console.error(e); alert('Error: ' + e.message); }
				});
				tdIng.addEventListener('click', async () => {
					if (!isIng) return; const raw = prompt('Nuevo valor (ingreso)', String(v)); if (raw == null) return; const n = Number(raw); if (!Number.isFinite(n) || n <= 0) { alert('Valor inv√°lido'); return; }
					try { 
						const res = await fetch('/api/accounting', { method: 'PUT', headers: { 'Content-Type': 'application/json', 'X-Actor-Name': currentUser?.name || '' }, body: JSON.stringify({ id: r.id, amount_cents: Math.round(n) }) });
						if (!res.ok) {
							const err = await res.json().catch(() => ({}));
							alert('Error al guardar: ' + (err.error || res.status));
							return;
						}
						await load();
					} catch (e) { console.error(e); alert('Error: ' + e.message); }
				});
				tdSal.addEventListener('click', async () => {
					if (isIng) return; const raw = prompt('Nuevo valor (salida)', String(v)); if (raw == null) return; const n = Number(raw); if (!Number.isFinite(n) || n <= 0) { alert('Valor inv√°lido'); return; }
					try { 
						const res = await fetch('/api/accounting', { method: 'PUT', headers: { 'Content-Type': 'application/json', 'X-Actor-Name': currentUser?.name || '' }, body: JSON.stringify({ id: r.id, amount_cents: Math.round(n) }) });
						if (!res.ok) {
							const err = await res.json().catch(() => ({}));
							alert('Error al guardar: ' + (err.error || res.status));
							return;
						}
						await load();
					} catch (e) { console.error(e); alert('Error: ' + e.message); }
				});
				tdDate.addEventListener('click', (ev) => {
					openSingleDatePopover(async (pickedIso) => {
						try { 
							const res = await fetch('/api/accounting', { method: 'PUT', headers: { 'Content-Type': 'application/json', 'X-Actor-Name': currentUser?.name || '' }, body: JSON.stringify({ id: r.id, entry_date: pickedIso }) });
							if (!res.ok) {
								const err = await res.json().catch(() => ({}));
								alert('Error al guardar: ' + (err.error || res.status));
								return;
							}
							await load();
						} catch (e) { console.error(e); alert('Error: ' + e.message); }
					}, ev.clientX, ev.clientY);
				});
			}
			tIng.textContent = fmtMoney(sumIng || 0);
			tGas.textContent = fmtMoney(sumGas || 0);
			tBal.textContent = fmtMoney((sumIng - sumGas) || 0);
			countLabel.textContent = `Filas: ${(rows||[]).length}`;
			// Wire deletes
			Array.from(tbody.querySelectorAll('button[data-del]')).forEach(btn => {
				btn.addEventListener('click', async () => {
					const id = Number(btn.getAttribute('data-del'));
					if (!id) return;
					if (!confirm('Eliminar registro?')) return;
					try { await fetch(`/api/accounting?id=${encodeURIComponent(id)}`, { method: 'DELETE', headers: { 'X-Actor-Name': currentUser?.name || '' } }); await load(); } catch {}
				});
			});
			// Wire duplicates
			Array.from(tbody.querySelectorAll('button[data-dup]')).forEach(btn => {
				btn.addEventListener('click', async () => {
					const id = Number(btn.getAttribute('data-dup'));
					if (!id) return;
					const row = rows.find(r => r.id === id);
					if (!row) return;
					try {
						const payload = { 
							kind: row.kind, 
							entry_date: row.entry_date, 
							description: row.description, 
							amount_cents: row.amount_cents, 
							_actor_name: currentUser?.name || '' 
						};
						const res = await fetch('/api/accounting', { 
							method: 'POST', 
							headers: { 'Content-Type': 'application/json', 'X-Actor-Name': currentUser?.name || '' }, 
							body: JSON.stringify(payload) 
						});
						if (!res.ok) {
							let msg = `Error (${res.status})`;
							try { const j = await res.json(); if (j && j.error) msg = j.error; } catch {}
							alert(msg);
							return;
						}
						await load();
					} catch (e) {
						console.error(e);
						alert('Error al duplicar');
					}
				});
			});
		}

		async function load(){
			try {
				rangeLabel.textContent = `${formatDay(start)} ‚Äî ${formatDay(end)}`;
				countLabel.textContent = 'Cargando‚Ä¶';
				const rows = await fetchJSON(`/api/accounting?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`);
				renderRows(rows);
			} catch (e) {
				countLabel.textContent = 'Error cargando';
			}
		}

		document.getElementById('back-btn').addEventListener('click', () => { location.href = '/'; });
		document.getElementById('acc-cancel').addEventListener('click', () => { location.href = '/'; });

			document.getElementById('acc-form').addEventListener('submit', async (e) => {
			e.preventDefault();
			const type = currentKind;
			const date = (document.getElementById('acc-date').value || '').toString();
			const desc = (document.getElementById('acc-desc').value || '').toString();
			const value = Number(document.getElementById('acc-value').value || 0);
			if (!date || !desc || !value) { alert('Completa todos los campos'); return; }
			try {
				const payload = { kind: type, entry_date: date, description: desc, amount_cents: Number.isFinite(value) ? Math.round(value) : 0, _actor_name: currentUser?.name || '' };
				const res = await fetch('/api/accounting', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Actor-Name': currentUser?.name || '' }, body: JSON.stringify(payload) });
				if (!res.ok) {
					let msg = `Error (${res.status})`;
					try { const j = await res.json(); if (j && j.error) msg = j.error; } catch {}
					alert(msg);
					return;
				}
				// Clear description and value, keep type and date
				document.getElementById('acc-desc').value = '';
				document.getElementById('acc-value').value = '';
				await load();
			} catch (err) {
				console.error(err);
				alert('Error al guardar');
			}
		});

		function openCalendar(ev){
			openRangeCalendarPopover((range) => {
				if (!range || !range.start || !range.end) return;
				start = range.start; end = range.end;
				load();
			}, ev.clientX, ev.clientY, { preferUp: true });
		}
		changeBtn.addEventListener('click', openCalendar);

		// Descargar todos los adjuntos del rango seleccionado como archivos individuales (o ZIP si es posible)
		downloadBtn.addEventListener('click', async () => {
			try {
				const list = await fetchJSON(`/api/accounting?attachments_for_range=1&start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`);
				if (!Array.isArray(list) || !list.length) { alert('No hay adjuntos en el rango'); return; }
				// Intento simple: disparar descargas una por una con nombres
				for (const a of list) {
					const name = a.file_name || `adjunto_${String(a.entry_id)}_${String(a.id)}.bin`;
					const link = document.createElement('a'); link.href = a.file_base64; link.download = name; document.body.appendChild(link); link.click(); link.remove();
				}
			} catch (e) { console.error(e); alert('Error al descargar adjuntos'); }
		});

		// Lightweight embed of openRangeCalendarPopover if not present
		if (typeof window.openRangeCalendarPopover !== 'function') {
			window.openRangeCalendarPopover = function(onPickedRange, anchorX, anchorY, opts){
				const pop = document.createElement('div'); pop.className = 'date-popover'; pop.style.position = 'fixed'; const baseX = anchorX||window.innerWidth/2; const baseY = anchorY||window.innerHeight/2; pop.style.left = baseX+'px'; pop.style.top=(baseY+8)+'px'; pop.style.transform='translate(-50%,0)'; pop.style.zIndex='1000';
				const months = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre']; let view = new Date(); view.setDate(1); let startIso=null, endIso=null;
				const header=document.createElement('div'); header.className='date-popover-header'; const prev=document.createElement('button'); prev.className='date-nav'; prev.textContent='‚Äπ'; const label=document.createElement('div'); label.className='date-label'; const next=document.createElement('button'); next.className='date-nav'; next.textContent='‚Ä∫'; header.append(prev,label,next);
				const grid=document.createElement('div'); grid.className='date-grid'; const weekdays=['L','M','X','J','V','S','D']; const wk=document.createElement('div'); wk.className='date-weekdays'; for (const w of weekdays){ const c=document.createElement('div'); c.textContent=w; wk.appendChild(c);} 
				function isoUTC(y,m,d){ return new Date(Date.UTC(y,m,d)).toISOString().slice(0,10); }
				function isBetween(x,a,b){ return x>=a && x<=b; }
				function render(){ label.textContent = months[view.getMonth()] + ' ' + view.getFullYear(); grid.innerHTML=''; const year=view.getFullYear(); const month=view.getMonth(); const firstDay=(new Date(Date.UTC(year,month,1)).getUTCDay()+6)%7; const daysInMonth=new Date(Date.UTC(year,month+1,0)).getUTCDate(); for (let i=0;i<firstDay;i++){ const cell=document.createElement('button'); cell.className='date-cell disabled'; cell.disabled=true; grid.appendChild(cell);} for (let d=1; d<=daysInMonth; d++){ const iso=isoUTC(year,month,d); const cell=document.createElement('button'); let cls='date-cell'; if (startIso && !endIso && iso===startIso) cls+=' range-start selected'; if (startIso && endIso){ if (iso===startIso) cls+=' range-start selected'; else if (iso===endIso) cls+=' range-end selected'; else if (isBetween(iso,startIso,endIso)) cls+=' in-range'; } cell.className=cls; cell.textContent=String(d); cell.addEventListener('click',()=>{ if(!startIso){ startIso=iso; endIso=null; render(); return; } if(!endIso){ if(iso<startIso){ endIso=startIso; startIso=iso; } else { endIso=iso; } render(); return; } startIso=iso; endIso=null; render(); }); grid.appendChild(cell);} }
				function cleanup(){ document.removeEventListener('mousedown', outside, true); document.removeEventListener('touchstart', outside, true); if(pop.parentNode) pop.parentNode.removeChild(pop);} function outside(ev){ if(!pop.contains(ev.target)) cleanup(); }
				prev.addEventListener('click',()=>{ view.setMonth(view.getMonth()-1); render(); }); next.addEventListener('click',()=>{ view.setMonth(view.getMonth()+1); render(); });
				const actions=document.createElement('div'); actions.style.display='flex'; actions.style.justifyContent='space-between'; actions.style.marginTop='8px'; const clearBtn=document.createElement('button'); clearBtn.className='date-nav'; clearBtn.textContent='Limpiar'; const genBtn=document.createElement('button'); genBtn.className='date-nav'; genBtn.textContent='Generar'; genBtn.disabled=true; clearBtn.addEventListener('click',()=>{ startIso=null; endIso=null; genBtn.disabled=true; render(); }); genBtn.addEventListener('click',()=>{ if(startIso && endIso && typeof onPickedRange==='function'){ cleanup(); onPickedRange({ start:startIso, end:endIso }); } }); actions.append(clearBtn, genBtn);
				const origRender = render; render = function(){ origRender(); genBtn.disabled = !(startIso && endIso); };
				pop.append(header, wk, grid, actions); document.body.appendChild(pop); pop.classList.add('aladdin-pop');
				document.addEventListener('mousedown', outside, true); document.addEventListener('touchstart', outside, true); render();
			};
		}

		// Single-date popover for Fecha
		if (typeof window.openSingleDatePopover !== 'function') {
			window.openSingleDatePopover = function(onPickedDate, anchorX, anchorY){
				const pop = document.createElement('div'); pop.className='date-popover'; pop.style.position='fixed'; const baseX=anchorX||window.innerWidth/2; const baseY=anchorY||window.innerHeight/2; pop.style.left=baseX+'px'; pop.style.top=(baseY+8)+'px'; pop.style.transform='translate(-50%,0)'; pop.style.zIndex='1000';
				const months=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre']; let view=new Date(); view.setDate(1);
				const header=document.createElement('div'); header.className='date-popover-header'; const prev=document.createElement('button'); prev.className='date-nav'; prev.textContent='‚Äπ'; const label=document.createElement('div'); label.className='date-label'; const next=document.createElement('button'); next.className='date-nav'; next.textContent='‚Ä∫'; header.append(prev,label,next);
				const grid=document.createElement('div'); grid.className='date-grid'; const weekdays=['L','M','X','J','V','S','D']; const wk=document.createElement('div'); wk.className='date-weekdays'; for (const w of weekdays){ const c=document.createElement('div'); c.textContent=w; wk.appendChild(c);} 
				function isoUTC(y,m,d){ return new Date(Date.UTC(y,m,d)).toISOString().slice(0,10); }
				function render(){ label.textContent=months[view.getMonth()]+' '+view.getFullYear(); grid.innerHTML=''; const year=view.getFullYear(); const month=view.getMonth(); const firstDay=(new Date(Date.UTC(year,month,1)).getUTCDay()+6)%7; const daysInMonth=new Date(Date.UTC(year,month+1,0)).getUTCDate(); for (let i=0;i<firstDay;i++){ const cell=document.createElement('button'); cell.className='date-cell disabled'; cell.disabled=true; grid.appendChild(cell);} for (let d=1; d<=daysInMonth; d++){ const iso=isoUTC(year,month,d); const cell=document.createElement('button'); cell.className='date-cell'; cell.textContent=String(d); cell.addEventListener('click',()=>{ cleanup(); if (typeof onPickedDate==='function') onPickedDate(iso); }); grid.appendChild(cell);} }
				function cleanup(){ document.removeEventListener('mousedown', outside, true); document.removeEventListener('touchstart', outside, true); if (pop.parentNode) pop.parentNode.removeChild(pop); }
				function outside(ev){ if (!pop.contains(ev.target)) cleanup(); }
				prev.addEventListener('click',()=>{ view.setMonth(view.getMonth()-1); render(); }); next.addEventListener('click',()=>{ view.setMonth(view.getMonth()+1); render(); });
				pop.append(header, wk, grid); document.body.appendChild(pop); pop.classList.add('aladdin-pop');
				document.addEventListener('mousedown', outside, true); document.addEventListener('touchstart', outside, true); render();
			};
		}

		const dateIconBtn = document.getElementById('acc-date-icon');
		dateIconBtn.addEventListener('click', (ev) => {
			openSingleDatePopover((pickedIso) => { dateInput.value = pickedIso; }, ev.clientX, ev.clientY);
		});
		dateInput.addEventListener('click', (ev) => {
			ev.preventDefault();
			openSingleDatePopover((pickedIso) => { dateInput.value = pickedIso; }, ev.clientX, ev.clientY);
		});

		load();
	})();
	</script>
</body>
</html>


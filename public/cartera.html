<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Reporte de Cartera</title>
	<link rel="stylesheet" href="/styles.css?v=2025-09-17-1" />
	<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
	<header class="app-header">
		<div class="header-row">
			<div class="header-left">
				<img src="/logo.png" alt="Lulitas Logo" class="app-logo" />
				<h1>Reporte de Cartera</h1>
			</div>
			<div class="header-actions">
				<button id="back-btn" class="press-btn">Volver</button>
			</div>
		</div>
	</header>

	<main class="sales-panel">
		<div class="panel-header">
			<h3 id="title">Cartera</h3>
			<div class="panel-actions">
				<button id="change-range" class="press-btn">Cambiar fechas</button>
				<button id="export-excel" class="excel-btn press-btn btn-gold">⤓ Generar Excel</button>
			</div>
		</div>
		<div class="panel-body">
			<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
				<strong id="range-label"></strong>
				<small id="count-label" style="opacity:.8"></small>
			</div>
			<div class="filters-row" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:6px 0 12px 0">
				<label style="display:flex; gap:6px; align-items:flex-start">
					<span style="line-height:28px;">Vendedores</span>
					<div id="seller-filter-group" class="seller-filter-group" style="display:flex; gap:8px; flex-wrap:wrap; min-width:220px; max-height:132px; overflow:auto; padding:8px; border:1px solid var(--border); border-radius:10px; background: var(--card);"></div>
				</label>
                <label style="display:flex; gap:6px; align-items:flex-start">
                    <span style="line-height:28px;">Método</span>
                    <div id="pay-method-filter-group" class="seller-filter-group" style="display:flex; gap:8px; flex-wrap:wrap; min-width:220px; max-height:132px; overflow:auto; padding:8px; border:1px solid var(--border); border-radius:10px; background: var(--card);"></div>
                </label>
                <label style="display:flex; gap:6px; align-items:flex-start">
                    <span style="line-height:28px;">Fuente</span>
                    <div id="pay-source-filter-group" class="seller-filter-group" style="display:flex; gap:8px; flex-wrap:wrap; min-width:200px; max-height:132px; overflow:auto; padding:8px; border:1px solid var(--border); border-radius:10px; background: var(--card);"></div>
                </label>
				<label style="display:flex; gap:6px; align-items:center">
					<span>Fecha pago:</span>
					<button id="payment-date-filter-btn" class="press-btn" style="padding:4px 12px; height:28px; font-size:0.9em;">
						<span id="payment-date-filter-label">Todas</span>
					</button>
				</label>
			</div>
			<div class="table-wrapper" id="report-wrapper">
				<table id="report-table">
					<thead>
						<tr>
							<th id="th-fecha" style="cursor:pointer; user-select:none;">Fecha <span id="sort-fecha"></span></th>
							<th id="th-vendedor" style="cursor:pointer; user-select:none;">Vendedor <span id="sort-vendedor"></span></th>
							<th>Cliente</th>
							<th id="th-metodo" style="cursor:pointer; user-select:none;">Método <span id="sort-metodo"></span></th>
							<th id="th-fuente" style="cursor:pointer; user-select:none;">Fuente <span id="sort-fuente"></span></th>
							<th id="th-fecha-pago" style="cursor:pointer; user-select:none;">Fecha pago <span id="sort-fecha-pago"></span></th>
							<th class="col-paid">$</th>
							<th class="col-qty">Arco</th>
							<th class="col-qty">Melo</th>
							<th class="col-qty">Mara</th>
							<th class="col-qty">Oreo</th>
							<th class="col-qty">Nute</th>
							<th class="col-total">Total</th>
							<th></th>
						</tr>
					</thead>
					<tbody id="report-tbody"></tbody>
					<tfoot>
						<tr>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td class="label">Totales</td>
							<td></td>
							<td id="t-qa" class="col-qty"></td>
							<td id="t-qm" class="col-qty"></td>
							<td id="t-qma" class="col-qty"></td>
							<td id="t-qo" class="col-qty"></td>
							<td id="t-qn" class="col-qty"></td>
							<td id="t-grand" class="col-total"></td>
							<td></td>
						</tr>
					</tfoot>
				</table>
			</div>
		</div>
	</main>

	<script type="module">
	(function(){
		const qs = new URLSearchParams(location.search);
		let start = (qs.get('start') || '').slice(0,10);
		let end = (qs.get('end') || '').slice(0,10);
		let actor = (qs.get('actor') || '').toString();
		if (!actor) { try { const saved = JSON.parse(localStorage.getItem('authUser')||'null'); actor = (saved?.name||saved?.username||'').toString(); } catch {} }
		const rangeLabel = document.getElementById('range-label');
		const countLabel = document.getElementById('count-label');
		const tbody = document.getElementById('report-tbody');
		const tQaEl = document.getElementById('t-qa');
		const tQmEl = document.getElementById('t-qm');
		const tQmaEl = document.getElementById('t-qma');
		const tQoEl = document.getElementById('t-qo');
		const tQnEl = document.getElementById('t-qn');
		const tGrandEl = document.getElementById('t-grand');
		const backBtn = document.getElementById('back-btn');
		const changeBtn = document.getElementById('change-range');
		const exportBtn = document.getElementById('export-excel');
        const sellerFilterGroup = document.getElementById('seller-filter-group');
        const payMethodFilterGroup = document.getElementById('pay-method-filter-group');
        const paySourceFilterGroup = document.getElementById('pay-source-filter-group');
        const paymentDateFilterBtn = document.getElementById('payment-date-filter-btn');
        const paymentDateFilterLabel = document.getElementById('payment-date-filter-label');
        
        let selectedPaymentDates = [];

		let dataset = [];
		let sellersList = [];
		let salesMap = {}; // Maps composite key to sale_id
		const seenSaleIds = new Set(); // Prevent duplicate rows per sale
		let sortColumn = null;
		let sortDirection = 'desc'; // 'asc' or 'desc'

		// Precio de venta por postre (alineado con el backend)
		const PRICES = { arco: 8500, melo: 9500, mara: 10500, oreo: 10500, nute: 13000 };

        function payLabel(pm){
            const lower = (pm || '').toString().toLowerCase();
            if (lower === 'efectivo aleja' || lower === 'efectivo_aleja') return 'Efectivo Aleja';
            if (lower === 'efectivo marcela' || lower === 'efectivo_marcela') return 'Efectivo Marcela';
            if (lower === 'bancolombia aleja' || lower === 'bancolombia_aleja') return 'Bancolombia Aleja';
            if (lower === 'bancolombia') return 'Bancolombia';
            if (lower === 'nequi') return 'Nequi';
            if (lower === 'otro') return 'Otro';
            // Old methods
            if (lower === 'efectivo') return 'Efectivo';
            if (lower === 'transf') return 'Transf';
            if (lower === 'marce') return 'Marce';
            if (lower === 'jorge') return 'Jorge';
            if (lower === 'jorgebank') return 'JorgeBank';
			if (lower === 'entregado') return 'Entregado';
            return pm === '' ? '-' : pm;
        }
		async function fetchJSON(u){ const r = await fetch(u); if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); }
		async function deleteSale(saleId, clientName) {
			if (!confirm(`¿Estás seguro de eliminar la venta de "${clientName || 'este cliente'}"?`)) return;
			try {
				const url = withActor(`/api/sales?id=${saleId}`);
				const r = await fetch(url, { method: 'DELETE' });
				if (!r.ok) throw new Error(`HTTP ${r.status}`);
				// Reload data after deletion
				await load();
			} catch (err) {
				alert('Error al eliminar: ' + String(err));
			}
		}
		function withActor(url){
			try { const u = new URL(url, location.origin); if (actor) u.searchParams.set('actor', actor); return u.pathname + (u.search || ''); }
			catch { return url + (url.includes('?') ? `&actor=${encodeURIComponent(actor)}` : `?actor=${encodeURIComponent(actor)}`); }
		}

		function populateFilters(){
			// Sellers
			if (sellerFilterGroup) {
				const prevSelected = getSelectedSellers();
				sellerFilterGroup.innerHTML = '';
				const masterWrap = document.createElement('label'); masterWrap.style.display='inline-flex'; masterWrap.style.alignItems='center'; masterWrap.style.gap='6px';
				const master = document.createElement('input'); master.type='checkbox'; master.id='sf_all';
				const masterSpan = document.createElement('span'); masterSpan.textContent = 'Todos';
				masterWrap.appendChild(master); masterWrap.appendChild(masterSpan);
				sellerFilterGroup.appendChild(masterWrap);
				for (const s of (sellersList||[])){
					const id = `sf_${(s.name||'').replace(/[^a-z0-9]+/gi,'_')}`;
					const wrap = document.createElement('label'); wrap.style.display='inline-flex'; wrap.style.alignItems='center'; wrap.style.gap='6px';
					const cb = document.createElement('input'); cb.type='checkbox'; cb.value = s.name || ''; cb.id = id;
					cb.checked = prevSelected.includes(cb.value);
					cb.addEventListener('change', () => { updateMasterCheckboxState(); render(); });
					const sp = document.createElement('span'); sp.textContent = s.name || '';
					wrap.appendChild(cb); wrap.appendChild(sp);
					sellerFilterGroup.appendChild(wrap);
				}
				function updateMasterCheckboxState(){
					const cbs = Array.from(sellerFilterGroup.querySelectorAll('input[type="checkbox"]')).filter(x => x.id !== 'sf_all');
					const checked = cbs.filter(x => x.checked).length;
					master.indeterminate = checked > 0 && checked < cbs.length;
					master.checked = checked > 0 && checked === cbs.length;
				}
				master.addEventListener('change', () => {
					const cbs = Array.from(sellerFilterGroup.querySelectorAll('input[type="checkbox"]')).filter(x => x.id !== 'sf_all');
					for (const cb of cbs) cb.checked = master.checked;
					updateMasterCheckboxState();
					render();
				});
				updateMasterCheckboxState();
			}
            // Pay methods (efectivo, transf, marce, jorge, etc.)
            if (payMethodFilterGroup) {
                const prevSelected = getSelectedPayMethods();
                payMethodFilterGroup.innerHTML = '';
                const masterWrap = document.createElement('label'); masterWrap.style.display='inline-flex'; masterWrap.style.alignItems='center'; masterWrap.style.gap='6px';
                const master = document.createElement('input'); master.type='checkbox'; master.id='pmf_all';
                const masterSpan = document.createElement('span'); masterSpan.textContent = 'Todos';
                masterWrap.appendChild(master); masterWrap.appendChild(masterSpan);
                payMethodFilterGroup.appendChild(masterWrap);
				const codes = ['', 'efectivo', 'marce', 'jorge', 'transf', 'jorgebank', 'entregado'];
                for (const code of codes){
                    const id = `pmf_${code || 'dash'}`;
                    const wrap = document.createElement('label'); wrap.style.display='inline-flex'; wrap.style.alignItems='center'; wrap.style.gap='6px';
                    const cb = document.createElement('input'); cb.type='checkbox'; cb.value = code; cb.id = id;
                    cb.checked = prevSelected.includes(cb.value);
                    cb.addEventListener('change', () => { updateMasterCheckboxState(); render(); });
                    const sp = document.createElement('span'); sp.textContent = payLabel(code);
                    wrap.appendChild(cb); wrap.appendChild(sp);
                    payMethodFilterGroup.appendChild(wrap);
                }
                function updateMasterCheckboxState(){
                    const cbs = Array.from(payMethodFilterGroup.querySelectorAll('input[type="checkbox"]')).filter(x => x.id !== 'pmf_all');
                    const checked = cbs.filter(x => x.checked).length;
                    master.indeterminate = checked > 0 && checked < cbs.length;
                    master.checked = checked > 0 && checked === cbs.length;
                }
                master.addEventListener('change', () => {
                    const cbs = Array.from(payMethodFilterGroup.querySelectorAll('input[type="checkbox"]')).filter(x => x.id !== 'pmf_all');
                    for (const cb of cbs) cb.checked = master.checked;
                    updateMasterCheckboxState();
                    render();
                });
                updateMasterCheckboxState();
            }
            // Pay sources (fuentes de pago del popup)
            if (paySourceFilterGroup) {
                const prevSelected = getSelectedPaySources();
                paySourceFilterGroup.innerHTML = '';
                const masterWrap = document.createElement('label'); masterWrap.style.display='inline-flex'; masterWrap.style.alignItems='center'; masterWrap.style.gap='6px';
                const master = document.createElement('input'); master.type='checkbox'; master.id='psf_all';
                const masterSpan = document.createElement('span'); masterSpan.textContent = 'Todos';
                masterWrap.appendChild(master); masterWrap.appendChild(masterSpan);
                paySourceFilterGroup.appendChild(masterWrap);
                const sources = [
                    { value: 'bancolombia', label: 'Bancolombia' },
                    { value: 'nequi', label: 'Nequi' },
                    { value: 'efectivo_marcela', label: 'Efectivo Marcela' },
                    { value: 'efectivo_aleja', label: 'Efectivo Aleja' },
                    { value: 'bancolombia_aleja', label: 'Bancolombia Aleja' },
                    { value: 'otros', label: 'Otros' }
                ];
                for (const src of sources){
                    const id = `psf_${src.value}`;
                    const wrap = document.createElement('label'); wrap.style.display='inline-flex'; wrap.style.alignItems='center'; wrap.style.gap='6px';
                    const cb = document.createElement('input'); cb.type='checkbox'; cb.value = src.value; cb.id = id;
                    cb.checked = prevSelected.includes(cb.value);
                    cb.addEventListener('change', () => { updateMasterCheckboxState(); render(); });
                    const sp = document.createElement('span'); sp.textContent = src.label;
                    wrap.appendChild(cb); wrap.appendChild(sp);
                    paySourceFilterGroup.appendChild(wrap);
                }
                function updateMasterCheckboxState(){
                    const cbs = Array.from(paySourceFilterGroup.querySelectorAll('input[type="checkbox"]')).filter(x => x.id !== 'psf_all');
                    const checked = cbs.filter(x => x.checked).length;
                    master.indeterminate = checked > 0 && checked < cbs.length;
                    master.checked = checked > 0 && checked === cbs.length;
                }
                master.addEventListener('change', () => {
                    const cbs = Array.from(paySourceFilterGroup.querySelectorAll('input[type="checkbox"]')).filter(x => x.id !== 'psf_all');
                    for (const cb of cbs) cb.checked = master.checked;
                    updateMasterCheckboxState();
                    render();
                });
                updateMasterCheckboxState();
            }
		}

		function getSelectedSellers(){
			if (sellerFilterGroup) {
				return Array.from(sellerFilterGroup.querySelectorAll('input[type="checkbox"]:checked')).map(i => i.value).filter(Boolean);
			}
			return [];
		}

		function getPaySource(paymentSource){
			// Check if payment_source is one of the new sources from popup
			const ps = (paymentSource || '').toString().toLowerCase();
			if (ps === 'efectivo aleja' || ps === 'efectivo_aleja') return 'efectivo_aleja';
			if (ps === 'efectivo marcela' || ps === 'efectivo_marcela') return 'efectivo_marcela';
			if (ps === 'bancolombia aleja' || ps === 'bancolombia_aleja') return 'bancolombia_aleja';
			if (ps === 'bancolombia') return 'bancolombia';
			if (ps === 'nequi') return 'nequi';
			if (ps === 'otro') return 'otros';
			// Otherwise no source set
			return null;
		}

		function getFilteredData(){
			const selSellers = getSelectedSellers();
            const selMethods = getSelectedPayMethods();
            const selSources = getSelectedPaySources();
            const selPaymentDates = getSelectedPaymentDates();
			let rows = dataset.filter(r => {
				// Si hay filtros de vendedores Y no coincide, excluir
				if (selSellers.length > 0 && !selSellers.includes(r.sellerName)) return false;
                
				// Check pay method filter (old methods: efectivo, transf, marce, jorge, jorgebank)
				const pm = (r.pay_method || '').toString();
				// Si hay filtros de método Y no coincide, excluir
				if (selMethods.length > 0 && !selMethods.includes(pm)) return false;
				
				// Check pay source filter (new sources: Bancolombia, Nequi, etc.)
				const ps = (r.payment_source || '').toString();
				const source = getPaySource(ps);
				// If source filters are selected, only show sales that have a source AND that source is selected
				if (selSources.length > 0 && (!source || !selSources.includes(source))) return false;
				
				// Filter by payment date
				const payDate = r.payment_date ? String(r.payment_date).slice(0, 10) : '';
				if (selPaymentDates.length > 0 && !selPaymentDates.includes(payDate)) return false;
				
				return true;
			});
			return rows;
		}

        function getSelectedPayMethods(){
            if (payMethodFilterGroup) {
                return Array.from(payMethodFilterGroup.querySelectorAll('input[type="checkbox"]:checked'))
                    .filter(i => i.id !== 'pmf_all')
                    .map(i => i.value);
            }
            return [];
        }

        function getSelectedPaySources(){
            if (paySourceFilterGroup) {
                return Array.from(paySourceFilterGroup.querySelectorAll('input[type="checkbox"]:checked'))
                    .filter(i => i.id !== 'psf_all')
                    .map(i => i.value);
            }
            return [];
        }
        
        function getSelectedPaymentDates(){
            return selectedPaymentDates;
        }

		function render(){
			let rows = getFilteredData();
			// Apply sorting if a column is selected
			if (sortColumn) {
				rows = sortData(rows, sortColumn, sortDirection);
			}
			tbody.innerHTML = '';
			let tQa=0,tQm=0,tQma=0,tQo=0,tQn=0,tGrand=0;
			for (const r of rows){
				const tr = document.createElement('tr');
				const payMethod = payLabel(r.pay_method||'');
				const paySource = r.payment_source ? payLabel(r.payment_source) : '';
				const payDate = r.payment_date ? String(r.payment_date).slice(0,10) : '';
				tr.innerHTML = `
					<td>${r.date}</td>
					<td>${r.sellerName}</td>
					<td>${r.client_name||''}</td>
					<td>${payMethod}</td>
					<td>${paySource}</td>
					<td>${payDate}</td>
					<td>${r.is_paid ? '✓' : ''}</td>
					<td>${r.qa||''}</td>
					<td>${r.qm||''}</td>
					<td>${r.qma||''}</td>
					<td>${r.qo||''}</td>
					<td>${r.qn||''}</td>
					<td class="col-total">${r.tot||''}</td>
					<td style="text-align:center;"><button class="row-delete delete-btn" data-sale-id="${r.saleId||''}" data-client-name="${(r.client_name||'').replace(/"/g,'&quot;')}" title="Eliminar"></button></td>`;
				tbody.appendChild(tr);
				tQa += r.qa||0; tQm += r.qm||0; tQma += r.qma||0; tQo += r.qo||0; tQn += r.qn||0; tGrand += r.tot||0;
			}
			// Attach delete event listeners
			const deleteBtns = tbody.querySelectorAll('.delete-btn');
			for (const btn of deleteBtns) {
				btn.addEventListener('click', () => {
					const saleId = btn.getAttribute('data-sale-id');
					const clientName = btn.getAttribute('data-client-name');
					if (saleId) deleteSale(saleId, clientName);
				});
			}
			tQaEl.textContent = tQa || '';
			tQmEl.textContent = tQm || '';
			tQmaEl.textContent = tQma || '';
			 tQoEl.textContent = tQo || '';
			 tQnEl.textContent = tQn || '';
			 tGrandEl.textContent = tGrand || '';
			countLabel.textContent = `Filas: ${rows.length}`;
			updateSortIndicators();
		}

		function sortData(rows, column, direction){
			const sorted = [...rows];
			const compareFn = (a, b) => {
				let valA, valB;
				if (column === 'fecha') {
					valA = a.date;
					valB = b.date;
				} else if (column === 'vendedor') {
					valA = (a.sellerName || '').toLowerCase();
					valB = (b.sellerName || '').toLowerCase();
				} else if (column === 'metodo') {
					valA = (a.pay_method || '').toLowerCase();
					valB = (b.pay_method || '').toLowerCase();
				} else if (column === 'fuente') {
					valA = (a.payment_source || '').toLowerCase();
					valB = (b.payment_source || '').toLowerCase();
				} else if (column === 'fecha-pago') {
					valA = a.payment_date || '';
					valB = b.payment_date || '';
				}
				if (valA < valB) return direction === 'asc' ? -1 : 1;
				if (valA > valB) return direction === 'asc' ? 1 : -1;
				return 0;
			};
			sorted.sort(compareFn);
			return sorted;
		}

		function updateSortIndicators(){
			document.getElementById('sort-fecha').textContent = '';
			document.getElementById('sort-vendedor').textContent = '';
			document.getElementById('sort-metodo').textContent = '';
			document.getElementById('sort-fuente').textContent = '';
			document.getElementById('sort-fecha-pago').textContent = '';
			if (sortColumn) {
				const arrow = sortDirection === 'asc' ? '▲' : '▼';
				document.getElementById(`sort-${sortColumn}`).textContent = arrow;
			}
		}

		function setupSortListeners(){
			const thFecha = document.getElementById('th-fecha');
			const thVendedor = document.getElementById('th-vendedor');
			const thMetodo = document.getElementById('th-metodo');
			const thFuente = document.getElementById('th-fuente');
			const thFechaPago = document.getElementById('th-fecha-pago');
			
			thFecha.addEventListener('click', () => {
				if (sortColumn === 'fecha') {
					sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
				} else {
					sortColumn = 'fecha';
					sortDirection = 'desc';
				}
				render();
			});
			
			thVendedor.addEventListener('click', () => {
				if (sortColumn === 'vendedor') {
					sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
				} else {
					sortColumn = 'vendedor';
					sortDirection = 'desc';
				}
				render();
			});
			
			thMetodo.addEventListener('click', () => {
				if (sortColumn === 'metodo') {
					sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
				} else {
					sortColumn = 'metodo';
					sortDirection = 'desc';
				}
				render();
			});
			
			thFuente.addEventListener('click', () => {
				if (sortColumn === 'fuente') {
					sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
				} else {
					sortColumn = 'fuente';
					sortDirection = 'desc';
				}
				render();
			});
			
			thFechaPago.addEventListener('click', () => {
				if (sortColumn === 'fecha-pago') {
					sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
				} else {
					sortColumn = 'fecha-pago';
					sortDirection = 'desc';
				}
				render();
			});
		}

		async function load(){
			if (!start || !end) { rangeLabel.textContent = 'Selecciona rango'; openCalendar(); return; }
			rangeLabel.textContent = `${start} — ${end}`;
			countLabel.textContent = 'Cargando…';
			dataset = [];
			seenSaleIds.clear();
			
			// Auto-sync receipt payments to sales on first load (silent, in background)
			const syncKey = 'cartera_receipts_synced';
			if (!sessionStorage.getItem(syncKey)) {
				try {
					await fetchJSON(withActor('/api/sales?sync_receipts=true'));
					sessionStorage.setItem(syncKey, 'true');
				} catch (err) {
					console.warn('Auto-sync failed:', err);
				}
			}
			
			sellersList = await fetchJSON(withActor('/api/sellers'));
			populateFilters();
			countLabel.textContent = `Vendedores: ${sellersList.length} · Buscando ventas…`;
			// Cargar todas las ventas del rango en una sola consulta (evita duplicados y desalineaciones)
			let salesData = [];
			try {
				salesData = await fetchJSON(withActor(`/api/sales?date_range_start=${encodeURIComponent(start)}&date_range_end=${encodeURIComponent(end)}`));
			} catch {}
			countLabel.textContent = `Ventas: ${salesData.length} · Procesando…`;
			for (const r of (salesData || [])) {
				const pm = (r.pay_method || '').toString();
				const ps = (r.payment_source || '').toString();
				const pd = r.payment_date ? String(r.payment_date).slice(0, 10) : '';
				// Cantidades por sabor (usar solo primera ocurrencia por postre, igual que consolidado)
				let qa = Number(r.qty_arco || 0) || 0;
				let qm = Number(r.qty_melo || 0) || 0;
				let qma = Number(r.qty_mara || 0) || 0;
				let qo = Number(r.qty_oreo || 0) || 0;
				let qn = Number(r.qty_nute || 0) || 0;
				if (Array.isArray(r.items) && r.items.length > 0) {
					qa = 0; qm = 0; qma = 0; qo = 0; qn = 0;
					const seenQty = new Set();
					for (const item of r.items) {
						const code = (item.short_code || '').toLowerCase();
						if (!code || seenQty.has(code)) continue;
						seenQty.add(code);
						const qty = Number(item.quantity || 0) || 0;
						if (code === 'arco') qa = qty;
						else if (code === 'melo') qm = qty;
						else if (code === 'mara') qma = qty;
						else if (code === 'oreo') qo = qty;
						else if (code === 'nute') qn = qty;
					}
				}
				// Total robusto
				let totCalc = 0;
				if (Array.isArray(r.items) && r.items.length > 0) {
					const seenTot = new Set();
					for (const item of r.items) {
						const code = (item.short_code || '').toLowerCase();
						if (!code || seenTot.has(code)) continue;
						seenTot.add(code);
						const qty = Number(item.quantity || 0) || 0;
						let price = Number(item.unit_price || 0) || 0;
						if (!price) price = PRICES[code] || 0;
						totCalc += qty * price;
					}
				} else {
					totCalc = (qa * PRICES.arco) + (qm * PRICES.melo) + (qma * PRICES.mara) + (qo * PRICES.oreo) + (qn * PRICES.nute);
				}
				const totDb = Number(r.total_cents || 0) || 0;
				const tot = totCalc > 0 ? totCalc : totDb;
				// Evitar duplicados por id
				if (seenSaleIds.has(r.id)) continue;
				seenSaleIds.add(r.id);
				dataset.push({
					date: String(r.sale_day || '').slice(0,10),
					sellerName: r.seller_name || '',
					client_name: r.client_name || '',
					pay_method: pm,
					payment_source: ps,
					payment_date: pd,
					is_paid: !!r.is_paid,
					qa, qm, qma, qo, qn, tot,
					saleId: r.id
				});
			}
			render();
		}

		function openCalendar(ev){
			openRangeCalendarPopover((range) => {
				if (!range || !range.start || !range.end) return;
				start = range.start; end = range.end;
				history.replaceState(null, '', `?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}${actor?`&actor=${encodeURIComponent(actor)}`:''}`);
				load();
			}, ev?.clientX, ev?.clientY, { preferUp: true });
		}

		exportBtn.addEventListener('click', () => {
			const header = ['Fecha','Vendedor','Cliente','Método','Fuente','Fecha pago','$','Arco','Melo','Mara','Oreo','Nute','Total'];
			const rows = [header];
			let eGrand = 0, eQa=0,eQm=0,eQma=0,eQo=0,eQn=0;
			for (const r of getFilteredData()){
				const payMethod = payLabel(r.pay_method||'');
				const paySource = r.payment_source ? payLabel(r.payment_source) : '';
				const payDate = r.payment_date ? String(r.payment_date).slice(0,10) : '';
				rows.push([
					r.date,
					r.sellerName,
					r.client_name||'',
					payMethod,
					paySource,
					payDate,
					r.is_paid ? '✓' : '',
					r.qa||'', r.qm||'', r.qma||'', r.qo||'', r.qn||'', r.tot||''
				]);
				eQa += r.qa||0; eQm += r.qm||0; eQma += r.qma||0; eQo += r.qo||0; eQn += r.qn||0; eGrand += r.tot||0;
			}
			rows.push(['','','','','','','Totales','','','','','', eGrand || '']);
			const ws = XLSX.utils.aoa_to_sheet(rows);
			ws['!cols'] = [ {wch:10},{wch:18},{wch:24},{wch:10},{wch:14},{wch:12},{wch:3},{wch:6},{wch:6},{wch:6},{wch:6},{wch:6},{wch:10} ];
			const wb = XLSX.utils.book_new();
			XLSX.utils.book_append_sheet(wb, ws, 'Cartera');
			XLSX.writeFile(wb, `Cartera_${(start||'')}_a_${(end||'')}.xlsx`);
		});

		backBtn.addEventListener('click', () => { location.href = '/'; });
        changeBtn.addEventListener('click', (ev) => openCalendar(ev));
		setupSortListeners();
		
		// Payment date filter button
		paymentDateFilterBtn.addEventListener('click', (ev) => {
			openPaymentDatePopover(ev);
		});
		
		function openPaymentDatePopover(ev){
			// Get available dates from current filters (excluding payment date filter)
			const selSellers = getSelectedSellers();
			const selMethods = getSelectedPayMethods();
			const selSources = getSelectedPaySources();
			
			const filteredData = dataset.filter(r => {
				if (selSellers.length > 0 && !selSellers.includes(r.sellerName)) return false;
				const pm = (r.pay_method || '').toString();
				if (selMethods.length > 0 && !selMethods.includes(pm)) return false;
				const ps = (r.payment_source || '').toString();
				const source = getPaySource(ps);
				if (selSources.length > 0 && (!source || !selSources.includes(source))) return false;
				return true;
			});
			
			const dateSet = new Set();
			for (const r of filteredData) {
				if (r.payment_date) {
					// Normalize to YYYY-MM-DD format
					const cleanDate = String(r.payment_date).slice(0, 10);
					dateSet.add(cleanDate);
				}
			}
			const uniqueDates = Array.from(dateSet).sort((a, b) => b.localeCompare(a));
			
			// Create popover
			const pop = document.createElement('div');
			pop.className = 'date-popover';
			pop.style.position = 'fixed';
			pop.style.zIndex = '1000';
			pop.style.background = 'var(--card)';
			pop.style.border = '1px solid var(--border)';
			pop.style.borderRadius = '10px';
			pop.style.padding = '12px';
			pop.style.maxHeight = '300px';
			pop.style.overflowY = 'auto';
			pop.style.minWidth = '180px';
			pop.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
			
			const rect = paymentDateFilterBtn.getBoundingClientRect();
			pop.style.left = rect.left + 'px';
			pop.style.top = (rect.bottom + 4) + 'px';
			
			// Add "Todas" option
			const allLabel = document.createElement('label');
			allLabel.style.display = 'flex';
			allLabel.style.gap = '8px';
			allLabel.style.padding = '6px';
			allLabel.style.cursor = 'pointer';
			allLabel.style.borderRadius = '6px';
			allLabel.addEventListener('mouseenter', () => allLabel.style.background = 'var(--hover-bg, rgba(0,0,0,0.05))');
			allLabel.addEventListener('mouseleave', () => allLabel.style.background = 'transparent');
			const allCb = document.createElement('input');
			allCb.type = 'checkbox';
			allCb.checked = selectedPaymentDates.length === 0;
			const allSpan = document.createElement('span');
			allSpan.textContent = 'Todas';
			allLabel.appendChild(allCb);
			allLabel.appendChild(allSpan);
			allCb.addEventListener('change', () => {
				selectedPaymentDates = [];
				paymentDateFilterLabel.textContent = 'Todas';
				document.body.removeChild(pop);
				render();
			});
			pop.appendChild(allLabel);
			
			// Add separator
			if (uniqueDates.length > 0) {
				const sep = document.createElement('div');
				sep.style.height = '1px';
				sep.style.background = 'var(--border)';
				sep.style.margin = '8px 0';
				pop.appendChild(sep);
			}
			
			// Add dates
			for (const date of uniqueDates) {
				// Normalize date format (extract YYYY-MM-DD from any format)
				const cleanDate = String(date).slice(0, 10);
				const formatted = cleanDate; // Keep as YYYY-MM-DD
				
				const label = document.createElement('label');
				label.style.display = 'flex';
				label.style.gap = '8px';
				label.style.padding = '6px';
				label.style.cursor = 'pointer';
				label.style.borderRadius = '6px';
				label.addEventListener('mouseenter', () => label.style.background = 'var(--hover-bg, rgba(0,0,0,0.05))');
				label.addEventListener('mouseleave', () => label.style.background = 'transparent');
				const cb = document.createElement('input');
				cb.type = 'checkbox';
				cb.checked = selectedPaymentDates.includes(cleanDate);
				const span = document.createElement('span');
				span.textContent = formatted;
				label.appendChild(cb);
				label.appendChild(span);
				cb.addEventListener('change', () => {
					if (cb.checked) {
						if (!selectedPaymentDates.includes(cleanDate)) selectedPaymentDates.push(cleanDate);
					} else {
						selectedPaymentDates = selectedPaymentDates.filter(d => d !== cleanDate);
					}
					if (selectedPaymentDates.length === 0) {
						paymentDateFilterLabel.textContent = 'Todas';
					} else if (selectedPaymentDates.length === 1) {
						paymentDateFilterLabel.textContent = String(selectedPaymentDates[0]).slice(0, 10);
					} else {
						paymentDateFilterLabel.textContent = `${selectedPaymentDates.length} fechas`;
					}
					render();
				});
				pop.appendChild(label);
			}
			
			document.body.appendChild(pop);
			
			function closePopover(e) {
				if (!pop.contains(e.target) && e.target !== paymentDateFilterBtn) {
					if (document.body.contains(pop)) document.body.removeChild(pop);
					document.removeEventListener('click', closePopover);
				}
			}
			setTimeout(() => document.addEventListener('click', closePopover), 100);
		}

		// Lightweight date range popover if missing
		if (typeof window.openRangeCalendarPopover !== 'function') {
			window.openRangeCalendarPopover = function(onPickedRange, anchorX, anchorY, opts){
				const pop = document.createElement('div'); pop.className = 'date-popover'; pop.style.position = 'fixed'; const baseX = anchorX||window.innerWidth/2; const baseY = anchorY||window.innerHeight/2; pop.style.left = baseX+'px'; pop.style.top=(baseY+8)+'px'; pop.style.transform='translate(-50%,0)'; pop.style.zIndex='1000';
				const months = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre']; let view = new Date(); view.setDate(1); let startIso=null, endIso=null;
				const header=document.createElement('div'); header.className='date-popover-header'; const prev=document.createElement('button'); prev.className='date-nav'; prev.textContent='‹'; const label=document.createElement('div'); label.className='date-label'; const next=document.createElement('button'); next.className='date-nav'; next.textContent='›'; header.append(prev,label,next);
				const grid=document.createElement('div'); grid.className='date-grid'; const weekdays=['L','M','X','J','V','S','D']; const wk=document.createElement('div'); wk.className='date-weekdays'; for (const w of weekdays){ const c=document.createElement('div'); c.textContent=w; wk.appendChild(c);} 
				function isoUTC(y,m,d){ return new Date(Date.UTC(y,m,d)).toISOString().slice(0,10); }
				function isBetween(x,a,b){ return x>=a && x<=b; }
				function render(){ label.textContent = months[view.getMonth()] + ' ' + view.getFullYear(); grid.innerHTML=''; const year=view.getFullYear(); const month=view.getMonth(); const firstDay=(new Date(Date.UTC(year,month,1)).getUTCDay()+6)%7; const daysInMonth=new Date(Date.UTC(year,month+1,0)).getUTCDate(); for (let i=0;i<firstDay;i++){ const cell=document.createElement('button'); cell.className='date-cell disabled'; cell.disabled=true; grid.appendChild(cell);} for (let d=1; d<=daysInMonth; d++){ const iso=isoUTC(year,month,d); const cell=document.createElement('button'); let cls='date-cell'; if (startIso && !endIso && iso===startIso) cls+=' range-start selected'; if (startIso && endIso){ if (iso===startIso) cls+=' range-start selected'; else if (iso===endIso) cls+=' range-end selected'; else if (isBetween(iso,startIso,endIso)) cls+=' in-range'; } cell.className=cls; cell.textContent=String(d); cell.addEventListener('click',()=>{ if(!startIso){ startIso=iso; endIso=null; render(); return; } if(!endIso){ if(iso<startIso){ endIso=startIso; startIso=iso; } else { endIso=iso; } render(); return; } startIso=iso; endIso=null; render(); }); grid.appendChild(cell);} }
				function cleanup(){ document.removeEventListener('mousedown', outside, true); document.removeEventListener('touchstart', outside, true); if(pop.parentNode) pop.parentNode.removeChild(pop);} function outside(ev){ if(!pop.contains(ev.target)) cleanup(); }
				prev.addEventListener('click',()=>{ view.setMonth(view.getMonth()-1); render(); }); next.addEventListener('click',()=>{ view.setMonth(view.getMonth()+1); render(); });
				const actions=document.createElement('div'); actions.style.display='flex'; actions.style.justifyContent='space-between'; actions.style.marginTop='8px'; const clearBtn=document.createElement('button'); clearBtn.className='date-nav'; clearBtn.textContent='Limpiar'; const genBtn=document.createElement('button'); genBtn.className='date-nav'; genBtn.textContent='Generar'; genBtn.disabled=true; clearBtn.addEventListener('click',()=>{ startIso=null; endIso=null; genBtn.disabled=true; render(); }); genBtn.addEventListener('click',()=>{ if(startIso && endIso && typeof onPickedRange==='function'){ cleanup(); onPickedRange({ start:startIso, end:endIso }); } }); actions.append(clearBtn, genBtn);
				const origRender = render; render = function(){ origRender(); genBtn.disabled = !(startIso && endIso); };
				pop.append(header, wk, grid, actions); document.body.appendChild(pop); pop.classList.add('aladdin-pop');
				document.addEventListener('mousedown', outside, true); document.addEventListener('touchstart', outside, true); render();
			};
		}

		load();
	})();
	</script>
</body>
</html>

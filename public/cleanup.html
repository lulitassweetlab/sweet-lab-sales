<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Limpieza de Duplicados</title>
	<link rel="stylesheet" href="/styles.css" />
	<style>
		.cleanup-container {
			max-width: 600px;
			margin: 40px auto;
			padding: 32px;
			background: white;
			border-radius: 12px;
			box-shadow: 0 2px 8px rgba(0,0,0,0.1);
		}
		.cleanup-title {
			font-size: 24px;
			font-weight: 600;
			margin-bottom: 16px;
			color: var(--text);
		}
		.cleanup-description {
			margin-bottom: 24px;
			color: var(--muted);
			line-height: 1.6;
		}
		.cleanup-warning {
			background: #fff3cd;
			border: 1px solid #ffc107;
			border-radius: 8px;
			padding: 16px;
			margin-bottom: 24px;
		}
		.cleanup-warning-title {
			font-weight: 600;
			color: #856404;
			margin-bottom: 8px;
		}
		.cleanup-warning-text {
			color: #856404;
			font-size: 14px;
		}
		.cleanup-btn {
			width: 100%;
			padding: 16px;
			font-size: 16px;
			font-weight: 600;
			background: var(--primary);
			color: white;
			border: none;
			border-radius: 8px;
			cursor: pointer;
			transition: all 0.2s;
		}
		.cleanup-btn:hover {
			background: var(--hover-primary-pink);
		}
		.cleanup-btn:disabled {
			opacity: 0.5;
			cursor: not-allowed;
		}
		.cleanup-result {
			margin-top: 24px;
			padding: 16px;
			border-radius: 8px;
			font-size: 14px;
		}
		.cleanup-result.success {
			background: #d4edda;
			border: 1px solid #c3e6cb;
			color: #155724;
		}
		.cleanup-result.error {
			background: #f8d7da;
			border: 1px solid #f5c6cb;
			color: #721c24;
		}
		.cleanup-result.info {
			background: #d1ecf1;
			border: 1px solid #bee5eb;
			color: #0c5460;
		}
		.cleanup-details {
			margin-top: 12px;
			font-size: 13px;
			opacity: 0.9;
		}
		.back-link {
			display: inline-block;
			margin-top: 24px;
			color: var(--primary);
			text-decoration: none;
		}
		.back-link:hover {
			text-decoration: underline;
		}
	</style>
</head>
<body>
	<div class="cleanup-container">
		<h1 class="cleanup-title">üßπ Limpieza de Duplicados</h1>
		
		<div class="cleanup-description">
			Esta herramienta corrige el problema de totales duplicados en las tablas de ventas.
			Limpia las columnas antiguas (<code>qty_*</code>) de las ventas que ya fueron migradas al nuevo sistema (<code>sale_items</code>).
		</div>
		
		<div class="cleanup-warning">
			<div class="cleanup-warning-title">‚ö†Ô∏è Importante</div>
			<div class="cleanup-warning-text">
				Esta operaci√≥n modificar√° la base de datos. Solo debe ser ejecutada por administradores.
				Los totales se recalcular√°n autom√°ticamente despu√©s de la limpieza.
			</div>
		</div>
		
		<button id="cleanup-btn" class="cleanup-btn">
			Ejecutar Limpieza
		</button>
		
		<div id="result" style="display: none;"></div>
		
		<a href="/" class="back-link">‚Üê Volver al inicio</a>
	</div>

	<script type="module">
		const cleanupBtn = document.getElementById('cleanup-btn');
		const resultDiv = document.getElementById('result');
		
		// Get current user from localStorage
		let actor = '';
		try {
			const saved = JSON.parse(localStorage.getItem('authUser') || 'null');
			actor = (saved?.name || saved?.username || '').toString();
		} catch {}
		
		cleanupBtn.addEventListener('click', async () => {
			if (!confirm('¬øEst√°s seguro de que deseas ejecutar la limpieza? Esta operaci√≥n modificar√° las ventas con valores duplicados.')) {
				return;
			}
			
			cleanupBtn.disabled = true;
			cleanupBtn.textContent = 'Ejecutando limpieza...';
			resultDiv.style.display = 'none';
			
			try {
				const response = await fetch('/api/cleanup-duplicates', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'X-Actor-Name': actor
					},
					body: JSON.stringify({
						actor_name: actor
					})
				});
				
				const data = await response.json();
				
				resultDiv.style.display = 'block';
				
				if (response.ok) {
					if (data.duplicates_found === 0) {
						resultDiv.className = 'cleanup-result info';
						resultDiv.innerHTML = `
							<div><strong>‚úì Base de datos limpia</strong></div>
							<div class="cleanup-details">${data.message}</div>
						`;
					} else {
						resultDiv.className = 'cleanup-result success';
						resultDiv.innerHTML = `
							<div><strong>‚úì Limpieza completada exitosamente</strong></div>
							<div class="cleanup-details">
								‚Ä¢ Duplicados encontrados: ${data.duplicates_found}<br>
								‚Ä¢ Duplicados corregidos: ${data.duplicates_fixed}<br>
								‚Ä¢ Ventas recalculadas: ${data.sales_recalculated || data.duplicates_fixed}
							</div>
							<div style="margin-top: 12px;">
								Los totales ahora deben mostrarse correctamente. Recarga las p√°ginas de reportes para ver los cambios.
							</div>
						`;
					}
				} else {
					resultDiv.className = 'cleanup-result error';
					resultDiv.innerHTML = `
						<div><strong>‚úó Error</strong></div>
						<div class="cleanup-details">${data.error || 'Error desconocido'}</div>
					`;
				}
			} catch (error) {
				resultDiv.style.display = 'block';
				resultDiv.className = 'cleanup-result error';
				resultDiv.innerHTML = `
					<div><strong>‚úó Error de conexi√≥n</strong></div>
					<div class="cleanup-details">${error.message}</div>
				`;
			} finally {
				cleanupBtn.disabled = false;
				cleanupBtn.textContent = 'Ejecutar Limpieza Nuevamente';
			}
		});
	</script>
</body>
</html>

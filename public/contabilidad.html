<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Contabilidad</title>
	<link rel="stylesheet" href="/styles.css?v=2025-09-17-1" />
    <style>
    .acct-container { max-width: 980px; margin: 0 auto; padding: 16px; }
    .acct-header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin: 12px 0 16px; }
    .acct-title { display:flex; align-items:center; gap:12px; }
    .acct-month { display:flex; align-items:center; gap:8px; }
    .acct-month label { opacity:.8; }
    .filters { display:flex; align-items:center; gap:8px; flex-wrap: wrap; }
    .acct-table { width:100%; border-collapse: collapse; }
    .acct-table th, .acct-table td { border-bottom: 1px solid var(--table-border,#e6e6e6); padding: 10px; text-align: left; }
    .acct-table th { background: var(--panel-header-bg, #f8f8f8); position: sticky; top: 0; z-index: 1; }
    .col-date { width: 130px; }
    .col-desc { min-width: 200px; }
    .col-in, .col-out, .col-bal { width: 120px; text-align: right; }
    .right { text-align: right; }
    .muted { opacity: .7; }
    .fab-add { position: fixed; right: 24px; bottom: 24px; width: 64px; height: 64px; border-radius: 50%; font-size: 28px; line-height: 1; display:flex; align-items:center; justify-content:center; box-shadow: 0 6px 18px rgba(0,0,0,.15); }
    .dialog-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.2); display:flex; align-items:center; justify-content:center; z-index:1000; }
    .dialog { width: min(520px, 92vw); background: var(--panel-bg, #fff); border-radius: 12px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .dialog h3 { margin: 0 0 8px; }
    .dialog .type-row { display:flex; gap:8px; margin: 8px 0 12px; }
    .dialog .form-row { display:grid; grid-template-columns: 1fr 2fr; gap:8px; align-items:center; margin: 8px 0; }
    .dialog .actions { display:flex; justify-content:flex-end; gap:8px; margin-top:12px; }
    .pill { padding: 8px 12px; border-radius: 999px; border: 1px solid var(--table-border,#ddd); cursor: pointer; background: none; }
    .pill.active { background: var(--btn-primary-bg,#222); color: #fff; border-color: var(--btn-primary-bg,#222); }
    </style>
</head>
<body>
    <header class="app-header">
        <div class="header-row">
            <div class="header-left">
                <img src="/logo.png" alt="Lulitas Logo" class="app-logo" />
                <h1>Contabilidad</h1>
            </div>
            <div class="header-actions">
                <button id="acct-back" class="press-btn">Volver</button>
            </div>
        </div>
    </header>

    <main class="acct-container">
        <div class="acct-header">
            <div class="acct-title">
                <strong>Tabla mensual</strong>
                <span id="balance-label" class="muted"></span>
            </div>
            <div class="acct-month">
                <div class="filters">
                    <label for="month">Mes</label>
                    <input id="month" type="month" />
                    <span class="muted">o</span>
                    <label for="start">Inicio</label>
                    <input id="start" type="date" />
                    <label for="end">Fin</label>
                    <input id="end" type="date" />
                    <input id="q" type="text" class="input-cell" placeholder="Buscar descripción" style="min-width:200px" />
                    <button id="apply-filters" class="press-btn btn-primary">Aplicar</button>
                    <button id="clear-filters" class="press-btn">Limpiar</button>
                    <button id="acct-export" class="press-btn">Exportar Excel</button>
                </div>
            </div>
        </div>
        <div class="table-wrapper">
            <table id="acct-table" class="acct-table">
                <thead>
                    <tr>
                        <th class="col-date">Fecha</th>
                        <th class="col-desc">Descripción</th>
                        <th class="col-in">Entra</th>
                        <th class="col-out">Sale</th>
                        <th class="col-bal">Saldo</th>
                        <th class="col-actions"></th>
                    </tr>
                </thead>
                <tbody id="acct-tbody"></tbody>
            </table>
        </div>
    </main>

    <button id="acct-add" class="press-btn btn-primary fab-add" title="Agregar">＋</button>

    <script type="module">
    (function(){
        let currentUser = null;
        try { const saved = localStorage.getItem('authUser'); if (saved) currentUser = JSON.parse(saved); } catch {}
        const isSuper = (currentUser?.role === 'superadmin') || !!currentUser?.isSuperAdmin || (String(currentUser?.name||'').toLowerCase()==='jorge');
        if (!isSuper) { location.href = '/'; return; }

        const backBtn = document.getElementById('acct-back');
        const addBtn = document.getElementById('acct-add');
        const monthInput = document.getElementById('month');
        const startInput = document.getElementById('start');
        const endInput = document.getElementById('end');
        const qInput = document.getElementById('q');
        const tbody = document.getElementById('acct-tbody');
        const balanceLabel = document.getElementById('balance-label');

        function fmtCurrency(n){ const v = Number(n||0); return v.toLocaleString('es-CO'); }
        function todayISO(){ const d = new Date(); const m = String(d.getMonth()+1).padStart(2,'0'); const day = String(d.getDate()).padStart(2,'0'); return `${d.getFullYear()}-${m}-${day}`; }
        function monthKey(iso){ return (iso||'').slice(0,7); }
        function getMonth(){ return monthInput.value || todayISO().slice(0,7); }
        function storageKey(m){ return `acct:${m}`; }

        async function fetchEntries(m){
            let u = `/api/accounting?actor=${encodeURIComponent(currentUser?.name||'')}`;
            const start = (startInput.value||'').slice(0,10);
            const end = (endInput.value||'').slice(0,10);
            const q = (qInput.value||'').trim();
            if (start && end) u += `&start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`;
            else u += `&month=${encodeURIComponent(m)}`;
            if (q) u += `&q=${encodeURIComponent(q)}`;
            const r = await fetch(u);
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            const j = await r.json();
            return Array.isArray(j.entries) ? j.entries : [];
        }
        async function createEntry(payload){
            const r = await fetch('/api/accounting', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...payload, actor_name: currentUser?.name || '' })
            });
            if (!r.ok) throw new Error('No se pudo guardar');
            return await r.json();
        }

        async function recalcAndRender(){
            const m = getMonth();
            tbody.innerHTML = '';
            let entries = [];
            try { entries = await fetchEntries(m); } catch { entries = []; }
            entries.sort((a,b) => String(a.entry_date||a.date).localeCompare(String(b.entry_date||b.date)));
            let running = 0;
            let sumIn = 0; let sumOut = 0;
            for (const e of entries){
                const dateStr = String(e.entry_date || e.date || '');
                const kind = String(e.kind || e.type || '');
                const amount = Number(e.amount || e.value || 0);
                const desc = String(e.description || e.desc || '');
                const tr = document.createElement('tr');
                const tdDate = document.createElement('td'); tdDate.textContent = dateStr;
                const tdDesc = document.createElement('td'); tdDesc.textContent = desc;
                const tdIn = document.createElement('td'); tdIn.className = 'right'; tdIn.textContent = kind==='ingreso' ? fmtCurrency(amount) : '';
                const tdOut = document.createElement('td'); tdOut.className = 'right'; tdOut.textContent = kind==='gasto' ? fmtCurrency(amount) : '';
                if (kind==='ingreso') { sumIn += amount; running += amount; } else { sumOut += amount; running -= amount; }
                const tdBal = document.createElement('td'); tdBal.className = 'right'; tdBal.textContent = fmtCurrency(running);
                const tdActions = document.createElement('td');
                const editBtn = document.createElement('button'); editBtn.className = 'press-btn'; editBtn.textContent = 'Editar';
                const delBtn = document.createElement('button'); delBtn.className = 'press-btn'; delBtn.textContent = 'Eliminar'; delBtn.style.marginLeft = '6px';
                tdActions.append(editBtn, delBtn);
                tr.append(tdDate, tdDesc, tdIn, tdOut, tdBal, tdActions);
                tbody.appendChild(tr);

                editBtn.addEventListener('click', () => openEditDialog({ id: e.id, date: dateStr, type: kind, value: amount, desc }));
                delBtn.addEventListener('click', () => confirmDelete(e.id));
            }
            balanceLabel.textContent = `Ingresos: ${fmtCurrency(sumIn)} · Gastos: ${fmtCurrency(sumOut)} · Saldo: ${fmtCurrency(running)}`;
        }

        async function updateEntry(payload){
            const r = await fetch('/api/accounting', { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ...payload, actor_name: currentUser?.name || '' }) });
            if (!r.ok) throw new Error('No se pudo actualizar');
            return await r.json();
        }

        async function deleteEntry(id){
            const u = `/api/accounting?id=${encodeURIComponent(String(id))}&actor=${encodeURIComponent(currentUser?.name||'')}`;
            const r = await fetch(u, { method: 'DELETE' });
            if (!r.ok) throw new Error('No se pudo eliminar');
            return true;
        }

        function openEditDialog(entry){
            const backdrop = document.createElement('div'); backdrop.className = 'dialog-backdrop';
            const dlg = document.createElement('div'); dlg.className = 'dialog';
            const title = document.createElement('h3'); title.textContent = 'Editar registro';
            const typeRow = document.createElement('div'); typeRow.className = 'type-row';
            const bIn = document.createElement('button'); bIn.className = 'pill'; bIn.textContent = 'Ingreso'; bIn.type = 'button';
            const bOut = document.createElement('button'); bOut.className = 'pill'; bOut.textContent = 'Gasto'; bOut.type = 'button';
            typeRow.append(bIn, bOut);
            let type = entry.type === 'gasto' ? 'gasto' : 'ingreso';
            if (type === 'ingreso') bIn.classList.add('active'); else bOut.classList.add('active');
            bIn.addEventListener('click', () => { type='ingreso'; bIn.classList.add('active'); bOut.classList.remove('active'); });
            bOut.addEventListener('click', () => { type='gasto'; bOut.classList.add('active'); bIn.classList.remove('active'); });

            const row1 = document.createElement('div'); row1.className = 'form-row';
            const lab1 = document.createElement('label'); lab1.textContent = 'Fecha';
            const inDate = document.createElement('input'); inDate.type = 'date'; inDate.value = (entry.date||'').slice(0,10);
            row1.append(lab1, inDate);

            const row2 = document.createElement('div'); row2.className = 'form-row';
            const lab2 = document.createElement('label'); lab2.textContent = 'Descripción';
            const inDesc = document.createElement('input'); inDesc.type = 'text'; inDesc.value = entry.desc || '';
            row2.append(lab2, inDesc);

            const row3 = document.createElement('div'); row3.className = 'form-row';
            const lab3 = document.createElement('label'); lab3.textContent = 'Valor';
            const inVal = document.createElement('input'); inVal.type = 'number'; inVal.min = '0'; inVal.step = '1'; inVal.value = String(entry.value || 0);
            row3.append(lab3, inVal);

            const actions = document.createElement('div'); actions.className = 'actions';
            const cancel = document.createElement('button'); cancel.className = 'press-btn'; cancel.textContent = 'Cancelar';
            const save = document.createElement('button'); save.className = 'press-btn btn-primary'; save.textContent = 'Guardar';
            actions.append(cancel, save);

            dlg.append(title, typeRow, row1, row2, row3, actions); backdrop.appendChild(dlg); document.body.appendChild(backdrop);
            setTimeout(() => backdrop.addEventListener('click', (e) => { if (e.target === backdrop) cleanup(); }), 0);
            function cleanup(){ if (backdrop.parentNode) backdrop.parentNode.removeChild(backdrop); }
            cancel.addEventListener('click', cleanup);
            save.addEventListener('click', async () => {
                const date = (inDate.value||'').slice(0,10);
                const desc = (inDesc.value||'').trim();
                const value = Math.max(0, Number(inVal.value||0)|0);
                if (!date || !desc || !value) { return; }
                try { await updateEntry({ id: entry.id, date, desc, value, type }); } catch {}
                cleanup();
                if (monthKey(date) === getMonth()) recalcAndRender(); else recalcAndRender();
            });
        }

        function confirmDelete(id){
            if (!confirm('¿Eliminar este registro?')) return;
            deleteEntry(id).then(() => recalcAndRender()).catch(() => {});
        }

        function openDialog(){
            const backdrop = document.createElement('div'); backdrop.className = 'dialog-backdrop';
            const dlg = document.createElement('div'); dlg.className = 'dialog';
            const title = document.createElement('h3'); title.textContent = 'Nuevo registro';
            const typeRow = document.createElement('div'); typeRow.className = 'type-row';
            const bIn = document.createElement('button'); bIn.className = 'pill active'; bIn.textContent = 'Ingreso'; bIn.type = 'button';
            const bOut = document.createElement('button'); bOut.className = 'pill'; bOut.textContent = 'Gasto'; bOut.type = 'button';
            typeRow.append(bIn, bOut);
            let type = 'ingreso';
            bIn.addEventListener('click', () => { type='ingreso'; bIn.classList.add('active'); bOut.classList.remove('active'); });
            bOut.addEventListener('click', () => { type='gasto'; bOut.classList.add('active'); bIn.classList.remove('active'); });

            const row1 = document.createElement('div'); row1.className = 'form-row';
            const lab1 = document.createElement('label'); lab1.textContent = 'Fecha';
            const inDate = document.createElement('input'); inDate.type = 'date'; inDate.value = todayISO();
            row1.append(lab1, inDate);

            const row2 = document.createElement('div'); row2.className = 'form-row';
            const lab2 = document.createElement('label'); lab2.textContent = 'Descripción';
            const inDesc = document.createElement('input'); inDesc.type = 'text'; inDesc.placeholder = 'Descripción';
            row2.append(lab2, inDesc);

            const row3 = document.createElement('div'); row3.className = 'form-row';
            const lab3 = document.createElement('label'); lab3.textContent = 'Valor';
            const inVal = document.createElement('input'); inVal.type = 'number'; inVal.min = '0'; inVal.step = '1'; inVal.placeholder = '0';
            row3.append(lab3, inVal);

            const actions = document.createElement('div'); actions.className = 'actions';
            const cancel = document.createElement('button'); cancel.className = 'press-btn'; cancel.textContent = 'Cancelar';
            const save = document.createElement('button'); save.className = 'press-btn btn-primary'; save.textContent = 'Guardar';
            actions.append(cancel, save);

            dlg.append(title, typeRow, row1, row2, row3, actions); backdrop.appendChild(dlg); document.body.appendChild(backdrop);
            setTimeout(() => backdrop.addEventListener('click', (e) => { if (e.target === backdrop) cleanup(); }), 0);

            function cleanup(){ if (backdrop.parentNode) backdrop.parentNode.removeChild(backdrop); }
            cancel.addEventListener('click', cleanup);
            save.addEventListener('click', async () => {
                const date = (inDate.value||'').slice(0,10);
                const desc = (inDesc.value||'').trim();
                const value = Math.max(0, Number(inVal.value||0)|0);
                if (!date || !desc || !value) { return; }
                try { await createEntry({ date, desc, value, type }); } catch {}
                cleanup();
                if (monthKey(date) === getMonth()) recalcAndRender();
            });
        }

        function initMonth() {
            const qs = new URLSearchParams(location.search);
            const q = (qs.get('month')||'').slice(0,7);
            const initial = q && /^\d{4}-\d{2}$/.test(q) ? q : todayISO().slice(0,7);
            monthInput.value = initial;
        }

        backBtn.addEventListener('click', () => { location.href = '/'; });
        monthInput.addEventListener('change', () => { recalcAndRender(); history.replaceState(null, '', `?month=${encodeURIComponent(getMonth())}`); });
        addBtn.addEventListener('click', openDialog);
        document.getElementById('apply-filters').addEventListener('click', () => { recalcAndRender(); });
        document.getElementById('clear-filters').addEventListener('click', () => { startInput.value = ''; endInput.value = ''; qInput.value = ''; recalcAndRender(); });
        document.getElementById('acct-export').addEventListener('click', async () => {
            const m = getMonth();
            let entries = [];
            try { entries = await fetchEntries(m); } catch {}
            const rows = entries.map(e => ({
                Fecha: String(e.entry_date||'').slice(0,10),
                Descripción: String(e.description||''),
                Entra: (e.kind==='ingreso' ? Number(e.amount||0) : ''),
                Sale: (e.kind==='gasto' ? Number(e.amount||0) : '')
            }));
            let running = 0; const withSaldo = rows.map(r => { const inV = Number(r.Entra||0); const outV = Number(r.Sale||0); running += inV - outV; return { ...r, Saldo: running }; });
            try {
                if (!window.XLSX) {
                    const s = document.createElement('script'); s.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js'; document.head.appendChild(s);
                    await new Promise(res => { s.onload = res; s.onerror = res; });
                }
                const ws = window.XLSX.utils.json_to_sheet(withSaldo);
                const wb = window.XLSX.utils.book_new();
                window.XLSX.utils.book_append_sheet(wb, ws, 'Contabilidad');
                const start = (startInput.value||'').slice(0,10); const end = (endInput.value||'').slice(0,10); const q = (qInput.value||'').trim();
                let label = m.replace('-','');
                if (start && end) label = `${start.replaceAll('-','')}_${end.replaceAll('-','')}`;
                if (q) label += `_busca_${q.replace(/\s+/g,'_')}`;
                window.XLSX.writeFile(wb, `Contabilidad_${label}.xlsx`);
            } catch {}
        });

        initMonth();
        recalcAndRender();
    })();
    </script>
</body>
</html>


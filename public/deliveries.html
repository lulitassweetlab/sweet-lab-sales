<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Entregas</title>
	<link rel="stylesheet" href="/styles.css?v=2025-09-17-1" />
</head>
<body>
	<header class="app-header">
		<div class="header-row">
			<div class="header-left">
				<img src="/logo.png" alt="Lulitas Logo" class="app-logo" />
				<h1>Entregas</h1>
			</div>
			<div class="header-actions">
				<button id="back-btn" class="press-btn">Volver</button>
			</div>
		</div>
	</header>

	<main class="sales-panel">
		<div class="panel-header">
			<h3>Producciones de postres</h3>
			<div class="panel-actions">
				<button id="add-delivery-btn" class="press-btn btn-primary">+ Nueva entrega</button>
			</div>
		</div>
		<div class="panel-body">
			<div class="table-wrapper">
				<table id="deliveries-table">
					<thead>
						<tr>
							<th>Fecha</th>
							<th class="col-qty">Arco</th>
							<th class="col-qty">Melo</th>
							<th class="col-qty">Mara</th>
							<th class="col-qty">Oreo</th>
							<th class="col-qty">Nute</th>
							<th>Acciones</th>
						</tr>
					</thead>
					<tbody id="deliveries-tbody"></tbody>
				</table>
			</div>
		</div>
	</main>

	<script type="module">
	(function(){
		const tbody = document.getElementById('deliveries-tbody');
		const addBtn = document.getElementById('add-delivery-btn');
		const backBtn = document.getElementById('back-btn');

		function getCurrentUser(){
			try { return JSON.parse(localStorage.getItem('authUser') || 'null'); } catch { return null; }
		}

		function requireAdmin(){
			const u = getCurrentUser();
			if (!u) { alert('Inicia sesiÃ³n'); window.location.href = '/index.html'; return null; }
			if (!(u.role === 'admin' || u.role === 'superadmin')) { alert('Solo para admin/superadmin'); window.location.href = '/index.html'; return null; }
			return u;
		}

		async function api(method, url, body) {
			const u = getCurrentUser();
			const headers = { 'Content-Type': 'application/json' };
			if (u && u.name) headers['X-Actor-Name'] = String(u.name);
			const res = await fetch(url, { method, headers, body: body ? JSON.stringify(body) : undefined });
			if (!res.ok) {
				const t = await res.text();
				throw new Error(t || 'API error');
			}
			return res.json();
		}

		async function load() {
			let rows = [];
			try { rows = await api('GET', '/api/deliveries'); } catch {}
			render(rows);
		}

		function render(rows) {
			tbody.innerHTML = '';
			for (const r of rows) tbody.appendChild(renderDeliveryRow(r));
		}

		function renderDeliveryRow(r) {
			const tr = document.createElement('tr');
			const d = document.createElement('td'); d.textContent = r.day || '';
			const a = document.createElement('td'); a.textContent = r.arco ?? 0; a.className = 'col-qty';
			const m = document.createElement('td'); m.textContent = r.melo ?? 0; m.className = 'col-qty';
			const ma = document.createElement('td'); ma.textContent = r.mara ?? 0; ma.className = 'col-qty';
			const o = document.createElement('td'); o.textContent = r.oreo ?? 0; o.className = 'col-qty';
			const n = document.createElement('td'); n.textContent = r.nute ?? 0; n.className = 'col-qty';
			const act = document.createElement('td');
			const edit = document.createElement('button'); edit.className = 'press-btn'; edit.textContent = 'Editar';
			const notes = document.createElement('button'); notes.className = 'press-btn'; notes.textContent = 'Notas';
			const addSeller = document.createElement('button'); addSeller.className = 'press-btn'; addSeller.textContent = 'Agregar vendedor';
			act.style.display = 'flex'; act.style.gap = '6px'; act.append(edit, notes, addSeller);
			tr.append(d, a, m, ma, o, n, act);
			return tr;
		}

		function openNewDeliveryPopover(anchorX, anchorY) {
			const overlay = document.createElement('div'); overlay.className = 'confirm-popover'; overlay.style.position = 'fixed'; overlay.style.left = '50%'; overlay.style.top = '14%'; overlay.style.transform = 'translate(-50%, 0)'; overlay.style.zIndex = '1000'; overlay.classList.add('aladdin-pop');
			const title = document.createElement('h4'); title.textContent = 'Nueva entrega'; title.style.margin = '0 0 10px 0';
			const form = document.createElement('div'); form.style.display = 'grid'; form.style.gridTemplateColumns = '1fr 1fr'; form.style.gap = '8px'; form.style.minWidth = '360px';
			const dLabel = document.createElement('label'); dLabel.textContent = 'Fecha:'; dLabel.style.gridColumn = '1 / span 2';
			const dInput = document.createElement('input'); dInput.type = 'date'; dInput.className = 'input-cell'; dInput.value = new Date().toISOString().slice(0,10); dInput.style.gridColumn = '1 / span 2';
			function numField(name, label){
				const wrap = document.createElement('div');
				const l = document.createElement('label'); l.textContent = label; l.style.display = 'block';
				const i = document.createElement('input'); i.type = 'number'; i.min = '0'; i.step = '1'; i.value = '0'; i.className = 'input-cell';
				wrap.append(l, i); return [wrap, i];
			}
			const [fa, ia] = numField('arco','Arco');
			const [fm, im] = numField('melo','Melo');
			const [fma, ima] = numField('mara','Mara');
			const [fo, io] = numField('oreo','Oreo');
			const [fn, inn] = numField('nute','Nute');
			form.append(dLabel, dInput, fa, fm, fma, fo, fn);
			const actions = document.createElement('div'); actions.className = 'confirm-actions'; actions.style.marginTop = '12px';
			const save = document.createElement('button'); save.className = 'press-btn btn-primary'; save.textContent = 'Guardar';
			const cancel = document.createElement('button'); cancel.className = 'press-btn'; cancel.textContent = 'Cancelar';
			actions.append(save, cancel);
			overlay.append(title, form, actions);
			document.body.appendChild(overlay);
			function close(){ if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay); }
			cancel.addEventListener('click', close);
			save.addEventListener('click', async () => {
				const payload = {
					day: dInput.value || new Date().toISOString().slice(0,10),
					items: {
						arco: Number(ia.value||0)||0,
						melo: Number(im.value||0)||0,
						mara: Number(ima.value||0)||0,
						oreo: Number(io.value||0)||0,
						nute: Number(inn.value||0)||0
					}
				};
				try { await api('POST', '/api/deliveries', payload); close(); await load(); }
				catch (e) { alert('No se pudo guardar: ' + (e?.message || e)); }
			});
		}

		addBtn.addEventListener('click', (ev) => {
			if (!requireAdmin()) return;
			const rect = addBtn.getBoundingClientRect();
			openNewDeliveryPopover(rect.left + rect.width/2, rect.bottom + 8);
		});

		backBtn.addEventListener('click', () => { window.location.href = '/index.html'; });
		requireAdmin();
		load();
	})();
	</script>
</body>
</html>


<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Entregas</title>
	<link rel="stylesheet" href="/styles.css?v=2025-09-17-1" />
</head>
<body>
	<header class="app-header">
		<div class="header-row">
			<div class="header-left">
				<img src="/logo.png" alt="Lulitas Logo" class="app-logo" />
				<h1>Entregas</h1>
			</div>
			<div class="header-actions">
				<button id="back-btn" class="press-btn">Volver</button>
			</div>
		</div>
	</header>

	<main class="sales-panel">
		<!-- View Tabs -->
		<div style="display: flex; gap: 8px; margin-bottom: 16px; border-bottom: 2px solid #eee;">
			<button id="tab-production" class="press-btn" style="border-bottom: 3px solid #4caf50; font-weight: bold;">Producciones</button>
			<button id="tab-sales" class="press-btn">Ventas Consolidadas</button>
		</div>
		
		<!-- Production View -->
		<div id="view-production">
			<div class="panel-header">
				<h3>Producciones de postres</h3>
				<div class="panel-actions">
					<button id="production-report-btn" class="press-btn">Reporte de producción</button>
					<button id="add-delivery-btn" class="press-btn btn-primary">+ Nueva entrega</button>
				</div>
			</div>
			<div class="panel-body">
				<div class="table-wrapper">
					<table id="deliveries-table">
						<thead>
							<tr id="deliveries-thead-row">
								<th>Fecha</th>
								<!-- Dynamic dessert columns will be inserted here -->
								<th>Acciones</th>
							</tr>
						</thead>
						<tbody id="deliveries-tbody"></tbody>
					</table>
				</div>
			</div>
		</div>
		
		<!-- Sales Consolidated View -->
		<div id="view-sales" style="display: none;">
			<div class="panel-header">
				<h3>Ventas Consolidadas por Fecha</h3>
				<div class="panel-actions">
					<button id="refresh-sales-btn" class="press-btn">Actualizar</button>
				</div>
			</div>
			<div class="panel-body">
				<div class="table-wrapper">
					<table id="sales-consolidated-table">
						<thead>
							<tr id="sales-thead-row">
								<th>Fecha</th>
								<th>Vendedor</th>
								<!-- Dynamic dessert columns will be inserted here -->
							</tr>
						</thead>
						<tbody id="sales-tbody"></tbody>
					</table>
				</div>
			</div>
		</div>
	</main>

	<script type="module">
	(function(){
		const tbody = document.getElementById('deliveries-tbody');
		const addBtn = document.getElementById('add-delivery-btn');
		const productionReportBtn = document.getElementById('production-report-btn');
		const backBtn = document.getElementById('back-btn');
		
		// Track which deliveries are expanded
		const expandedDeliveries = new Set();
		// Store current data for re-rendering
		let currentRows = [];
		// Dynamic desserts from API
		let desserts = [];
		let dessertsById = new Map();

		function getCurrentUser(){
			try { return JSON.parse(localStorage.getItem('authUser') || 'null'); } catch { return null; }
		}

		function requireAdmin(){
			const u = getCurrentUser();
			if (!u) { alert('Inicia sesión'); window.location.href = '/index.html'; return null; }
			if (!(u.role === 'admin' || u.role === 'superadmin')) { alert('Solo para admin/superadmin'); window.location.href = '/index.html'; return null; }
			return u;
		}

		async function api(method, url, body) {
			const u = getCurrentUser();
			const headers = { 'Content-Type': 'application/json' };
			if (u && u.name) headers['X-Actor-Name'] = String(u.name);
			const res = await fetch(url, { method, headers, body: body ? JSON.stringify(body) : undefined });
			if (!res.ok) {
				const t = await res.text();
				throw new Error(t || 'API error');
			}
			return res.json();
		}

		// Load desserts from API and render columns
		async function loadDesserts() {
			try {
				desserts = await api('GET', '/api/desserts');
				desserts = Array.isArray(desserts) ? desserts : [];
				// Build map by id for quick lookup
				dessertsById.clear();
				for (const d of desserts) {
					dessertsById.set(d.id, d);
				}
				renderDessertColumns();
			} catch (err) {
				console.error('Error loading desserts:', err);
			}
		}
		
		function renderDessertColumns() {
			const theadRow = document.getElementById('deliveries-thead-row');
			const actionsTh = theadRow.querySelector('th:last-child');
			
			// Remove existing dessert columns
			theadRow.querySelectorAll('th.col-qty').forEach(th => th.remove());
			
			// Insert new columns before Actions
			for (const d of desserts) {
				const th = document.createElement('th');
				th.className = 'col-qty';
				th.textContent = d.name;
				theadRow.insertBefore(th, actionsTh);
			}
		}

		async function load() {
			// Load desserts first
			await loadDesserts();
			
			let rows = [];
			try { rows = await api('GET', '/api/deliveries'); } catch {}
			// Load seller assignments and production users for each delivery
			for (const r of rows) {
				try {
					const sellers = await api('GET', `/api/deliveries?delivery_id=${r.id}`);
					r.sellers = Array.isArray(sellers) ? sellers : [];
				} catch {
					r.sellers = [];
				}
				try {
					const users = await api('GET', `/api/deliveries?production_users=${r.id}`);
					r.production_users = Array.isArray(users) ? users : [];
				} catch {
					r.production_users = [];
				}
			}
			currentRows = rows;
			render(rows);
		}

		function render(rows) {
			tbody.innerHTML = '';
			for (const r of rows) {
				tbody.appendChild(renderDeliveryRow(r));
				// Show production users if any
				if (r.production_users && r.production_users.length > 0) {
					tbody.appendChild(renderProductionUsersRow(r));
				}
				// Render seller rows below each delivery if expanded
				const isExpanded = expandedDeliveries.has(r.id);
				if (r.sellers && Array.isArray(r.sellers) && r.sellers.length > 0 && isExpanded) {
					for (const s of r.sellers) {
						tbody.appendChild(renderSellerRow(s, r));
					}
					// Add totals row
					tbody.appendChild(renderSellerTotalsRow(r));
					// Add spacing row
					tbody.appendChild(renderSpacingRow());
				}
			}
		}

		function formatIsoDate(value) {
			try {
				const s = String(value || '');
				if (!s) return '';
				if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
				const iso = new Date(s).toISOString();
				return iso.slice(0,10);
			} catch { return String(value || '').slice(0,10); }
		}

		function renderDeliveryRow(r) {
			const tr = document.createElement('tr');
			const dateCell = document.createElement('td');
			
			// Add toggle button if there are sellers
			const hasSellers = r.sellers && Array.isArray(r.sellers) && r.sellers.length > 0;
			if (hasSellers) {
				const isExpanded = expandedDeliveries.has(r.id);
				const toggleBtn = document.createElement('button');
				toggleBtn.className = 'press-btn';
				toggleBtn.textContent = isExpanded ? '▼' : '▶';
				toggleBtn.style.marginRight = '8px';
				toggleBtn.style.fontSize = '10px';
				toggleBtn.style.padding = '2px 6px';
				toggleBtn.addEventListener('click', () => {
					if (expandedDeliveries.has(r.id)) {
						expandedDeliveries.delete(r.id);
					} else {
						expandedDeliveries.add(r.id);
					}
					render(currentRows);
				});
				dateCell.appendChild(toggleBtn);
			}
			
			const dateText = document.createElement('span');
			dateText.textContent = formatIsoDate(r.day);
			dateCell.appendChild(dateText);
			
			tr.appendChild(dateCell);
			
			// Add dessert columns dynamically
			for (const d of desserts) {
				const td = document.createElement('td');
				td.className = 'col-qty';
				td.textContent = r[d.short_code] ?? 0;
				tr.appendChild(td);
			}
			
			const act = document.createElement('td');
			const edit = document.createElement('button'); edit.className = 'press-btn'; edit.textContent = 'Editar';
			const notes = document.createElement('button'); notes.className = 'press-btn'; notes.textContent = 'Notas';
			const addSeller = document.createElement('button'); addSeller.className = 'press-btn'; addSeller.textContent = 'Agregar vendedor';
			
			// Add event listener for "Agregar vendedor" button
			addSeller.addEventListener('click', async () => {
				if (!requireAdmin()) return;
				const rect = addSeller.getBoundingClientRect();
				await openAddSellerPopover(r.id, rect.left + rect.width/2, rect.bottom + 8);
			});
			
			act.style.display = 'flex'; act.style.gap = '6px'; act.append(edit, notes, addSeller);
			tr.appendChild(act);
			return tr;
		}

		function renderSellerRow(s, delivery) {
			const tr = document.createElement('tr');
			tr.style.backgroundColor = '#f5f5f5';
			tr.style.fontStyle = 'italic';
			
			const sellerCell = document.createElement('td');
			sellerCell.textContent = `  → ${s.seller_name}`;
			sellerCell.style.paddingLeft = '30px';
			tr.appendChild(sellerCell);
			
			// Add dessert columns dynamically
			for (const d of desserts) {
				const td = document.createElement('td');
				td.className = 'col-qty';
				td.textContent = s[d.short_code] ?? 0;
				tr.appendChild(td);
			}
			
			const actCell = document.createElement('td');
			const editBtn = document.createElement('button');
			editBtn.className = 'press-btn';
			editBtn.textContent = 'Editar';
			editBtn.addEventListener('click', async () => {
				if (!requireAdmin()) return;
				const rect = editBtn.getBoundingClientRect();
				await openAddSellerPopover(delivery.id, rect.left + rect.width/2, rect.bottom + 8, s);
			});
			actCell.appendChild(editBtn);
			tr.appendChild(actCell);
			
			return tr;
		}

		function renderSellerTotalsRow(delivery) {
			const tr = document.createElement('tr');
			tr.style.backgroundColor = '#e8f5e9';
			tr.style.fontWeight = 'bold';
			
			const labelCell = document.createElement('td');
			labelCell.textContent = 'Total vendedores';
			labelCell.style.paddingLeft = '30px';
			tr.appendChild(labelCell);
			
			// Calculate totals dynamically for all desserts
			const totals = {};
			for (const d of desserts) {
				totals[d.short_code] = 0;
			}
			
			if (delivery.sellers && Array.isArray(delivery.sellers)) {
				for (const s of delivery.sellers) {
					for (const d of desserts) {
						totals[d.short_code] += s[d.short_code] ?? 0;
					}
				}
			}
			
			// Add totals columns dynamically
			for (const d of desserts) {
				const td = document.createElement('td');
				td.className = 'col-qty';
				td.textContent = totals[d.short_code];
				tr.appendChild(td);
			}
			
			const emptyCell = document.createElement('td');
			tr.appendChild(emptyCell);
			
			return tr;
		}

		function renderProductionUsersRow(delivery) {
			const tr = document.createElement('tr');
			tr.style.backgroundColor = '#fafafa';
			const td = document.createElement('td');
			// Colspan: 1 (Fecha) + desserts.length + 1 (Acciones)
			td.colSpan = 1 + desserts.length + 1;
			td.style.padding = '4px 8px';
			td.style.fontSize = '11px';
			td.style.fontStyle = 'italic';
			td.style.color = '#666';
			td.textContent = 'Producción: ' + delivery.production_users.join(', ');
			tr.appendChild(td);
			return tr;
		}

		function renderSpacingRow() {
			const tr = document.createElement('tr');
			tr.style.height = '20px';
			tr.style.backgroundColor = 'transparent';
			const td = document.createElement('td');
			// Colspan: 1 (Fecha) + desserts.length + 1 (Acciones)
			td.colSpan = 1 + desserts.length + 1;
			td.innerHTML = '&nbsp;';
			tr.appendChild(td);
			return tr;
		}

		async function openAddSellerPopover(deliveryId, anchorX, anchorY, existingSeller = null) {
			try {
				// Load sellers and desserts
				let sellers = [];
				let desserts = [];
				try { 
					sellers = await api('GET', '/api/sellers'); 
					sellers = Array.isArray(sellers) ? sellers : [];
				} catch {}
				try { 
					const r = await api('GET', '/api/desserts'); 
					desserts = Array.isArray(r) ? r : [];
				} catch {}

				const pop = document.createElement('div');
				pop.className = 'new-sale-popover';
				pop.style.position = 'fixed';
				const isSmall = window.matchMedia('(max-width: 640px)').matches;
				if (typeof anchorX === 'number' && typeof anchorY === 'number' && !isSmall) {
					pop.style.left = anchorX + 'px';
					pop.style.top = anchorY + 'px';
					pop.style.transform = 'translate(-50%, 0)';
				} else {
					pop.style.left = '50%';
					pop.style.top = '20%';
					pop.style.transform = 'translate(-50%, 0)';
				}

				const title = document.createElement('h4');
				title.style.margin = '0 0 8px 0';
				title.textContent = existingSeller ? 'Editar asignación' : 'Agregar vendedor a entrega';

				const grid = document.createElement('div');
				grid.className = 'new-sale-grid';

				function appendRow(labelText, inputEl) {
					const left = document.createElement('div'); left.className = 'new-sale-cell new-sale-left';
					const right = document.createElement('div'); right.className = 'new-sale-cell new-sale-right';
					const lbl = document.createElement('div'); lbl.className = 'new-sale-label-text'; lbl.textContent = labelText;
					left.appendChild(lbl);
					right.appendChild(inputEl);
					right.addEventListener('mousedown', (ev) => { if (ev.target !== inputEl) { ev.preventDefault(); try { inputEl.focus(); inputEl.select?.(); } catch {} } });
					right.addEventListener('click', (ev) => { if (ev.target !== inputEl) { ev.preventDefault(); try { inputEl.focus(); inputEl.select?.(); } catch {} } });
					grid.appendChild(left);
					grid.appendChild(right);
				}

				// Seller dropdown
				const sellerSelect = document.createElement('select');
				sellerSelect.className = 'input-cell';
				const defaultOption = document.createElement('option');
				defaultOption.value = '';
				defaultOption.textContent = 'Seleccionar vendedor...';
				sellerSelect.appendChild(defaultOption);
				
				for (const s of sellers) {
					const opt = document.createElement('option');
					opt.value = s.id;
					opt.textContent = s.name;
					if (existingSeller && existingSeller.seller_id === s.id) {
						opt.selected = true;
					}
					sellerSelect.appendChild(opt);
				}
				appendRow('Vendedor', sellerSelect);

				// Dessert quantity inputs
				const qtyInputs = {};
				for (const d of desserts) {
					if (d.is_active === false) continue;
					const input = document.createElement('input');
					input.type = 'number'; 
					input.min = '0'; 
					input.step = '1'; 
					input.inputMode = 'numeric'; 
					input.placeholder = '0';
					input.className = 'input-cell input-qty';
					
					// Pre-fill if editing
					if (existingSeller) {
						const val = existingSeller[d.short_code];
						if (val !== undefined && val !== null) {
							input.value = val;
						}
					}
					
					qtyInputs[d.short_code] = input;
					appendRow(d.name, input);
				}

				const actions = document.createElement('div'); 
				actions.className = 'confirm-actions';
				const cancelBtn = document.createElement('button'); 
				cancelBtn.type = 'button'; 
				cancelBtn.className = 'press-btn'; 
				cancelBtn.textContent = 'Cancelar';
				const saveBtn = document.createElement('button'); 
				saveBtn.type = 'button'; 
				saveBtn.className = 'press-btn btn-primary'; 
				saveBtn.textContent = 'Guardar';
				actions.append(cancelBtn, saveBtn);

				pop.append(title, grid, actions);
				pop.style.visibility = 'hidden'; 
				pop.style.opacity = '0'; 
				pop.style.transition = 'opacity 160ms ease-out';
				document.body.appendChild(pop);

				function clampWithinViewport() {
					try {
						const margin = 8; 
						const vw = window.innerWidth; 
						const vh = window.innerHeight; 
						const r = pop.getBoundingClientRect();
						const baseX = (typeof anchorX === 'number') ? anchorX : (vw / 2);
						const baseY = (typeof anchorY === 'number') ? anchorY : (vh / 2);
						let left = Math.round(baseX - r.width / 2);
						let topBelow = Math.round(baseY + 8); 
						let topAbove = Math.round(baseY - 8 - r.height); 
						let top = topBelow;
						if (top + r.height > vh - margin) top = topAbove;
						if (top < margin) top = margin;
						if (top + r.height > vh - margin) top = Math.max(margin, vh - margin - r.height);
						if (left < margin) left = margin;
						if (left + r.width > vw - margin) left = Math.max(margin, vw - margin - r.width);
						pop.style.left = left + 'px'; 
						pop.style.top = top + 'px'; 
						pop.style.transform = 'none';
					} catch {}
				}
				clampWithinViewport(); 
				pop.style.visibility = 'visible'; 
				requestAnimationFrame(() => { pop.style.opacity = '1'; });

				function cleanup(){ 
					document.removeEventListener('mousedown', outside, true); 
					document.removeEventListener('touchstart', outside, true); 
					if (pop.parentNode) pop.parentNode.removeChild(pop); 
				}
				function outside(ev){ 
					const t = ev.target; 
					if (!pop.contains(t)) cleanup(); 
				}
				setTimeout(() => { 
					document.addEventListener('mousedown', outside, true); 
					document.addEventListener('touchstart', outside, true); 
				}, 0);
				cancelBtn.addEventListener('click', cleanup);

				setTimeout(() => { try { sellerSelect.focus(); } catch {} }, 0);

				async function doSave(){
					try {
						saveBtn.disabled = true; 
						cancelBtn.disabled = true;
						
						const sellerId = sellerSelect.value;
						if (!sellerId) {
							alert('Por favor selecciona un vendedor');
							saveBtn.disabled = false;
							cancelBtn.disabled = false;
							return;
						}

						const items = {};
						for (const [code, input] of Object.entries(qtyInputs)) { 
							const q = Math.max(0, parseInt(input?.value || '0', 10) || 0); 
							items[code] = q;
						}
						
						const payload = { 
							id: deliveryId, 
							seller_id: parseInt(sellerId, 10),
							items 
						};
						
						await api('PATCH', '/api/deliveries', payload);
						cleanup(); 
						await load();
					} catch (e) {
						alert('No se pudo guardar: ' + (e?.message || e));
						saveBtn.disabled = false; 
						cancelBtn.disabled = false;
					}
				}
				saveBtn.addEventListener('click', doSave);
				Object.values(qtyInputs).forEach((el) => { 
					el.addEventListener('keydown', (ev) => { 
						if (ev.key === 'Enter') { 
							ev.preventDefault(); 
							doSave(); 
						} 
					}); 
				});
			} catch (e) {
				alert('No se pudo abrir el formulario: ' + (e?.message || e));
			}
		}

		async function openProductionPopover(anchorX, anchorY) {
			try {
				// Load dynamic desserts and users
				let desserts = [];
				let users = [];
				try { const r = await api('GET', '/api/desserts'); desserts = Array.isArray(r) ? r : []; } catch {}
				try { const r = await api('GET', '/api/users'); users = Array.isArray(r) ? r : []; } catch {}
				// Build popover similar to Nuevo pedido
				const pop = document.createElement('div');
				pop.className = 'new-sale-popover';
				pop.style.position = 'fixed';
				const isSmall = window.matchMedia('(max-width: 640px)').matches;
				if (typeof anchorX === 'number' && typeof anchorY === 'number' && !isSmall) {
					pop.style.left = anchorX + 'px';
					pop.style.top = anchorY + 'px';
					pop.style.transform = 'translate(-50%, 0)';
				} else {
					pop.style.left = '50%';
					pop.style.top = '20%';
					pop.style.transform = 'translate(-50%, 0)';
				}

				const title = document.createElement('h4');
				title.style.margin = '0 0 8px 0';
				function formatTitle(iso){
					try {
						const d = iso ? new Date(iso + 'T00:00:00Z') : new Date();
						const mes = d.toLocaleString('es-CO', { month: 'long', timeZone: 'UTC' });
						const dia = d.getUTCDate();
						const cap = mes.charAt(0).toUpperCase() + mes.slice(1);
						return `Producción ${cap} ${dia}`;
					} catch { return 'Producción'; }
				}
				const todayIso = new Date().toISOString().slice(0,10);
				title.textContent = formatTitle(todayIso);

				const grid = document.createElement('div');
				grid.className = 'new-sale-grid';

				function appendRow(labelText, inputEl) {
					const left = document.createElement('div'); left.className = 'new-sale-cell new-sale-left';
					const right = document.createElement('div'); right.className = 'new-sale-cell new-sale-right';
					const lbl = document.createElement('div'); lbl.className = 'new-sale-label-text'; lbl.textContent = labelText;
					left.appendChild(lbl);
					right.appendChild(inputEl);
					right.addEventListener('mousedown', (ev) => { if (ev.target !== inputEl) { ev.preventDefault(); try { inputEl.focus(); inputEl.select?.(); } catch {} } });
					right.addEventListener('click', (ev) => { if (ev.target !== inputEl) { ev.preventDefault(); try { inputEl.focus(); inputEl.select?.(); } catch {} } });
					grid.appendChild(left);
					grid.appendChild(right);
				}

				// Fecha row (replaces Cliente)
				const dateInput = document.createElement('input');
				dateInput.type = 'date';
				dateInput.className = 'input-cell';
				dateInput.value = todayIso;
				dateInput.addEventListener('change', () => { title.textContent = formatTitle(dateInput.value); });
				appendRow('Fecha', dateInput);

				// Dessert rows from dynamic list
				const qtyInputs = {};
				const userSelections = {};
				for (const d of desserts) {
					if (d.is_active === false) continue;
					
					// Quantity input
					const input = document.createElement('input');
					input.type = 'number'; input.min = '0'; input.step = '1'; input.inputMode = 'numeric'; input.placeholder = '0';
					input.className = 'input-cell input-qty';
					qtyInputs[d.short_code] = input;
					
					// Container for quantity and user selection
					const container = document.createElement('div');
					container.style.display = 'flex';
					container.style.flexDirection = 'column';
					container.style.gap = '4px';
					container.appendChild(input);
					
					// User selection for this dessert
					const userContainer = document.createElement('div');
					userContainer.style.display = 'flex';
					userContainer.style.flexWrap = 'wrap';
					userContainer.style.gap = '4px';
					userContainer.style.marginTop = '4px';
					
					const selectedUsers = new Set();
					userSelections[d.short_code] = selectedUsers;
					
					for (const u of users) {
						const userChip = document.createElement('button');
						userChip.type = 'button';
						userChip.className = 'press-btn';
						userChip.textContent = u.username;
						userChip.style.fontSize = '11px';
						userChip.style.padding = '2px 8px';
						userChip.style.opacity = '0.5';
						userChip.addEventListener('click', () => {
							if (selectedUsers.has(u.id)) {
								selectedUsers.delete(u.id);
								userChip.style.opacity = '0.5';
								userChip.style.backgroundColor = '';
							} else {
								selectedUsers.add(u.id);
								userChip.style.opacity = '1';
								userChip.style.backgroundColor = '#4caf50';
								userChip.style.color = 'white';
							}
						});
						userContainer.appendChild(userChip);
					}
					
					container.appendChild(userContainer);
					appendRow(d.name, container);
				}

				const actions = document.createElement('div'); actions.className = 'confirm-actions';
				const cancelBtn = document.createElement('button'); cancelBtn.type = 'button'; cancelBtn.className = 'press-btn'; cancelBtn.textContent = 'Cancelar';
				const saveBtn = document.createElement('button'); saveBtn.type = 'button'; saveBtn.className = 'press-btn btn-primary'; saveBtn.textContent = 'Guardar';
				actions.append(cancelBtn, saveBtn);

				pop.append(title, grid, actions);
				pop.style.visibility = 'hidden'; pop.style.opacity = '0'; pop.style.transition = 'opacity 160ms ease-out';
				document.body.appendChild(pop);

				function clampWithinViewport() {
					try {
						const margin = 8; const vw = window.innerWidth; const vh = window.innerHeight; const r = pop.getBoundingClientRect();
						const baseX = (typeof anchorX === 'number') ? anchorX : (vw / 2);
						const baseY = (typeof anchorY === 'number') ? anchorY : (vh / 2);
						let left = Math.round(baseX - r.width / 2);
						let topBelow = Math.round(baseY + 8); let topAbove = Math.round(baseY - 8 - r.height); let top = topBelow;
						if (top + r.height > vh - margin) top = topAbove;
						if (top < margin) top = margin;
						if (top + r.height > vh - margin) top = Math.max(margin, vh - margin - r.height);
						if (left < margin) left = margin;
						if (left + r.width > vw - margin) left = Math.max(margin, vw - margin - r.width);
						pop.style.left = left + 'px'; pop.style.top = top + 'px'; pop.style.transform = 'none';
					} catch {}
				}
				clampWithinViewport(); pop.style.visibility = 'visible'; requestAnimationFrame(() => { pop.style.opacity = '1'; });

				function cleanup(){ document.removeEventListener('mousedown', outside, true); document.removeEventListener('touchstart', outside, true); if (pop.parentNode) pop.parentNode.removeChild(pop); }
				function outside(ev){ const t = ev.target; if (!pop.contains(t)) cleanup(); }
				setTimeout(() => { document.addEventListener('mousedown', outside, true); document.addEventListener('touchstart', outside, true); }, 0);
				cancelBtn.addEventListener('click', cleanup);

				setTimeout(() => { try { dateInput.focus(); } catch {} }, 0);

				async function doSave(){
					try {
						saveBtn.disabled = true; cancelBtn.disabled = true;
						const items = {};
						const production_users = {};
						for (const [code, input] of Object.entries(qtyInputs)) { 
							const q = Math.max(0, parseInt(input?.value || '0', 10) || 0); 
							if (q > 0) items[code] = q; 
						}
						for (const [code, selectedSet] of Object.entries(userSelections)) {
							if (selectedSet.size > 0) {
								production_users[code] = Array.from(selectedSet);
							}
						}
						const payload = { day: dateInput.value || todayIso, items, production_users };
						await api('POST', '/api/deliveries', payload);
						cleanup(); await load();
					} catch (e) {
						alert('No se pudo guardar: ' + (e?.message || e));
						saveBtn.disabled = false; cancelBtn.disabled = false;
					}
				}
				saveBtn.addEventListener('click', doSave);
				Object.values(qtyInputs).forEach((el) => { el.addEventListener('keydown', (ev) => { if (ev.key === 'Enter') { ev.preventDefault(); doSave(); } }); });
			} catch (e) {
				alert('No se pudo abrir el formulario');
			}
		}

		addBtn.addEventListener('click', async () => {
			if (!requireAdmin()) return;
			const rect = addBtn.getBoundingClientRect();
			await openProductionPopover(rect.left + rect.width/2, rect.bottom + 8);
		});

		productionReportBtn.addEventListener('click', async () => {
			if (!requireAdmin()) return;
			const rect = productionReportBtn.getBoundingClientRect();
			await openProductionReportPopover(rect.left + rect.width/2, rect.bottom + 8);
		});

		async function openProductionReportPopover(anchorX, anchorY) {
			try {
				const pop = document.createElement('div');
				pop.className = 'new-sale-popover';
				pop.style.position = 'fixed';
				const isSmall = window.matchMedia('(max-width: 640px)').matches;
				if (typeof anchorX === 'number' && typeof anchorY === 'number' && !isSmall) {
					pop.style.left = anchorX + 'px';
					pop.style.top = anchorY + 'px';
					pop.style.transform = 'translate(-50%, 0)';
				} else {
					pop.style.left = '50%';
					pop.style.top = '20%';
					pop.style.transform = 'translate(-50%, 0)';
				}

				const title = document.createElement('h4');
				title.style.margin = '0 0 12px 0';
				title.textContent = 'Reporte de producción';

				const grid = document.createElement('div');
				grid.className = 'new-sale-grid';

				function appendRow(labelText, inputEl) {
					const left = document.createElement('div'); left.className = 'new-sale-cell new-sale-left';
					const right = document.createElement('div'); right.className = 'new-sale-cell new-sale-right';
					const lbl = document.createElement('div'); lbl.className = 'new-sale-label-text'; lbl.textContent = labelText;
					left.appendChild(lbl);
					right.appendChild(inputEl);
					grid.appendChild(left);
					grid.appendChild(right);
				}

				// Date inputs
				const todayIso = new Date().toISOString().slice(0,10);
				const startDate = document.createElement('input');
				startDate.type = 'date';
				startDate.className = 'input-cell';
				startDate.value = todayIso;
				appendRow('Fecha inicio', startDate);

				const endDate = document.createElement('input');
				endDate.type = 'date';
				endDate.className = 'input-cell';
				endDate.value = todayIso;
				appendRow('Fecha fin', endDate);

				// Results container
				const resultsDiv = document.createElement('div');
				resultsDiv.style.marginTop = '16px';
				resultsDiv.style.maxHeight = '400px';
				resultsDiv.style.overflowY = 'auto';

				const actions = document.createElement('div');
				actions.className = 'confirm-actions';
				const cancelBtn = document.createElement('button');
				cancelBtn.type = 'button';
				cancelBtn.className = 'press-btn';
				cancelBtn.textContent = 'Cancelar';
				const generateBtn = document.createElement('button');
				generateBtn.type = 'button';
				generateBtn.className = 'press-btn btn-primary';
				generateBtn.textContent = 'Generar';
				actions.append(cancelBtn, generateBtn);

				pop.append(title, grid, resultsDiv, actions);
				pop.style.visibility = 'hidden';
				pop.style.opacity = '0';
				pop.style.transition = 'opacity 160ms ease-out';
				document.body.appendChild(pop);

				function clampWithinViewport() {
					try {
						const margin = 8;
						const vw = window.innerWidth;
						const vh = window.innerHeight;
						const r = pop.getBoundingClientRect();
						const baseX = (typeof anchorX === 'number') ? anchorX : (vw / 2);
						const baseY = (typeof anchorY === 'number') ? anchorY : (vh / 2);
						let left = Math.round(baseX - r.width / 2);
						let topBelow = Math.round(baseY + 8);
						let topAbove = Math.round(baseY - 8 - r.height);
						let top = topBelow;
						if (top + r.height > vh - margin) top = topAbove;
						if (top < margin) top = margin;
						if (top + r.height > vh - margin) top = Math.max(margin, vh - margin - r.height);
						if (left < margin) left = margin;
						if (left + r.width > vw - margin) left = Math.max(margin, vw - margin - r.width);
						pop.style.left = left + 'px';
						pop.style.top = top + 'px';
						pop.style.transform = 'none';
					} catch {}
				}
				clampWithinViewport();
				pop.style.visibility = 'visible';
				requestAnimationFrame(() => { pop.style.opacity = '1'; });

				function cleanup() {
					document.removeEventListener('mousedown', outside, true);
					document.removeEventListener('touchstart', outside, true);
					if (pop.parentNode) pop.parentNode.removeChild(pop);
				}
				function outside(ev) {
					const t = ev.target;
					if (!pop.contains(t)) cleanup();
				}
				setTimeout(() => {
					document.addEventListener('mousedown', outside, true);
					document.addEventListener('touchstart', outside, true);
				}, 0);
				cancelBtn.addEventListener('click', cleanup);

				async function generateReport() {
					try {
						generateBtn.disabled = true;
						const start = startDate.value;
						const end = endDate.value;
						if (!start || !end) {
							alert('Por favor selecciona ambas fechas');
							generateBtn.disabled = false;
							return;
						}

						const data = await api('GET', `/api/deliveries?report=production&start=${start}&end=${end}`);
						
						// Create table
						resultsDiv.innerHTML = '';
						const table = document.createElement('table');
						table.style.width = '100%';
						table.style.borderCollapse = 'collapse';
						table.style.fontSize = '12px';
						
					const thead = document.createElement('thead');
					const headerRow = document.createElement('tr');
					// Build headers dynamically
					const headers = ['Usuario'];
					for (const d of desserts) {
						headers.push(d.name);
					}
					for (const h of headers) {
						const th = document.createElement('th');
						th.textContent = h;
						th.style.borderBottom = '2px solid #ddd';
						th.style.padding = '8px';
						th.style.textAlign = 'left';
						headerRow.appendChild(th);
					}
					thead.appendChild(headerRow);
					table.appendChild(thead);
					
					const tbody = document.createElement('tbody');
					for (const [username, quantities] of Object.entries(data)) {
						const row = document.createElement('tr');
						const userCell = document.createElement('td');
						userCell.textContent = username;
						userCell.style.padding = '6px 8px';
						userCell.style.borderBottom = '1px solid #eee';
						row.appendChild(userCell);
						
						for (const d of desserts) {
							const code = d.short_code;
								const cell = document.createElement('td');
								cell.textContent = quantities[code] || 0;
								cell.style.padding = '6px 8px';
								cell.style.textAlign = 'center';
								cell.style.borderBottom = '1px solid #eee';
								row.appendChild(cell);
							}
							tbody.appendChild(row);
						}
						table.appendChild(tbody);
						resultsDiv.appendChild(table);
						
						generateBtn.disabled = false;
					} catch (e) {
						alert('Error al generar reporte: ' + (e?.message || e));
						generateBtn.disabled = false;
					}
				}
				generateBtn.addEventListener('click', generateReport);
			} catch (e) {
				alert('No se pudo abrir el formulario: ' + (e?.message || e));
			}
		}

		backBtn.addEventListener('click', () => { window.location.href = '/index.html'; });
		
		// Tab switching logic
		const tabProduction = document.getElementById('tab-production');
		const tabSales = document.getElementById('tab-sales');
		const viewProduction = document.getElementById('view-production');
		const viewSales = document.getElementById('view-sales');
		const refreshSalesBtn = document.getElementById('refresh-sales-btn');
		const salesTbody = document.getElementById('sales-tbody');
		
		let currentView = 'production';
		let salesData = [];
		
		function switchTab(tab) {
			if (tab === 'production') {
				currentView = 'production';
				viewProduction.style.display = 'block';
				viewSales.style.display = 'none';
				tabProduction.style.borderBottom = '3px solid #4caf50';
				tabProduction.style.fontWeight = 'bold';
				tabSales.style.borderBottom = 'none';
				tabSales.style.fontWeight = 'normal';
			} else {
				currentView = 'sales';
				viewProduction.style.display = 'none';
				viewSales.style.display = 'block';
				tabProduction.style.borderBottom = 'none';
				tabProduction.style.fontWeight = 'normal';
				tabSales.style.borderBottom = '3px solid #4caf50';
				tabSales.style.fontWeight = 'bold';
				loadSalesConsolidated();
			}
		}
		
		tabProduction.addEventListener('click', () => switchTab('production'));
		tabSales.addEventListener('click', () => switchTab('sales'));
		refreshSalesBtn.addEventListener('click', () => loadSalesConsolidated());
		
		async function loadSalesConsolidated() {
			try {
				const data = await api('GET', '/api/deliveries?sales_consolidated=true');
				salesData = Array.isArray(data) ? data : [];
				renderSalesConsolidated();
			} catch (err) {
				console.error('Error loading sales consolidated:', err);
				alert('Error al cargar ventas consolidadas: ' + (err.message || err));
			}
		}
		
		function renderSalesConsolidated() {
			// First render the header columns dynamically
			const theadRow = document.getElementById('sales-thead-row');
			// Remove existing dessert columns
			theadRow.querySelectorAll('th.col-qty').forEach(th => th.remove());
			
			// Insert new columns after Vendedor
			for (const d of desserts) {
				const th = document.createElement('th');
				th.className = 'col-qty';
				th.textContent = d.name;
				theadRow.appendChild(th);
			}
			
			// Clear tbody
			salesTbody.innerHTML = '';
			
			// Render each date
			for (const dateData of salesData) {
				// Render date header row (just the date with colspan)
				const dateRow = document.createElement('tr');
				dateRow.style.backgroundColor = '#e3f2fd';
				dateRow.style.fontWeight = 'bold';
				const dateCell = document.createElement('td');
				dateCell.colSpan = 2 + desserts.length; // Fecha + Vendedor + all desserts
				dateCell.textContent = formatIsoDate(dateData.day);
				dateCell.style.padding = '12px 8px';
				dateRow.appendChild(dateCell);
				salesTbody.appendChild(dateRow);
				
				// Render each seller
				for (const seller of dateData.sellers) {
					const tr = document.createElement('tr');
					tr.style.backgroundColor = '#fafafa';
					
					// Empty cell for Fecha column (merge with date header visually)
					const emptyDateCell = document.createElement('td');
					emptyDateCell.textContent = '';
					tr.appendChild(emptyDateCell);
					
					// Seller name
					const sellerCell = document.createElement('td');
					sellerCell.textContent = seller.seller_name;
					sellerCell.style.paddingLeft = '16px';
					tr.appendChild(sellerCell);
					
					// Dessert quantities
					for (const d of desserts) {
						const td = document.createElement('td');
						td.className = 'col-qty';
						td.textContent = seller[d.short_code] || 0;
						tr.appendChild(td);
					}
					
					salesTbody.appendChild(tr);
				}
				
				// Render totals row
				const totalsRow = document.createElement('tr');
				totalsRow.style.backgroundColor = '#c8e6c9';
				totalsRow.style.fontWeight = 'bold';
				
				const emptyTotalDateCell = document.createElement('td');
				totalsRow.appendChild(emptyTotalDateCell);
				
				const totalLabel = document.createElement('td');
				totalLabel.textContent = 'TOTAL';
				totalLabel.style.paddingLeft = '16px';
				totalsRow.appendChild(totalLabel);
				
				for (const d of desserts) {
					const td = document.createElement('td');
					td.className = 'col-qty';
					td.textContent = dateData.totals[d.short_code] || 0;
					totalsRow.appendChild(td);
				}
				
				salesTbody.appendChild(totalsRow);
				
				// Add spacing row
				const spacingRow = document.createElement('tr');
				spacingRow.style.height = '20px';
				spacingRow.style.backgroundColor = 'transparent';
				const spacingCell = document.createElement('td');
				spacingCell.colSpan = 2 + desserts.length;
				spacingCell.innerHTML = '&nbsp;';
				spacingRow.appendChild(spacingCell);
				salesTbody.appendChild(spacingRow);
			}
			
			if (salesData.length === 0) {
				const emptyRow = document.createElement('tr');
				const emptyCell = document.createElement('td');
				emptyCell.colSpan = 2 + desserts.length;
				emptyCell.textContent = 'No hay datos de ventas consolidadas';
				emptyCell.style.textAlign = 'center';
				emptyCell.style.padding = '32px';
				emptyCell.style.color = '#999';
				emptyRow.appendChild(emptyCell);
				salesTbody.appendChild(emptyRow);
			}
		}
		
		requireAdmin();
		load();
	})();
	</script>
</body>
</html>


<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Entregas</title>
	<link rel="stylesheet" href="/styles.css?v=2025-09-17-1" />
</head>
<body>
	<header class="app-header">
		<div class="header-row">
			<div class="header-left">
				<img src="/logo.png" alt="Lulitas Logo" class="app-logo" />
				<h1>Entregas</h1>
			</div>
			<div class="header-actions">
				<button id="back-btn" class="press-btn">Volver</button>
			</div>
		</div>
	</header>

	<main class="sales-panel">
		<div class="panel-header">
			<h3>Entregas</h3>
			<div class="panel-actions">
				<button id="refresh-sales-btn" class="press-btn">Actualizar</button>
			</div>
		</div>
		<div class="panel-body">
			<div class="table-wrapper">
				<table id="sales-consolidated-table">
					<thead>
						<tr id="sales-thead-row">
							<th>Vendedor</th>
							<!-- Dynamic dessert columns will be inserted here -->
							<th>Total</th>
						</tr>
					</thead>
					<tbody id="sales-tbody"></tbody>
				</table>
			</div>
		</div>
	</main>

	<script type="module">
	(function(){
		const backBtn = document.getElementById('back-btn');
		const refreshSalesBtn = document.getElementById('refresh-sales-btn');
		const salesTbody = document.getElementById('sales-tbody');
		
		// Dynamic desserts from API
		let desserts = [];
		let dessertsById = new Map();
		let salesData = [];
		
		// Track expanded sellers (date_sellerId format)
		const expandedSellers = new Set();

		function getCurrentUser(){
			try { return JSON.parse(localStorage.getItem('authUser') || 'null'); } catch { return null; }
		}

		function requireAdmin(){
			const u = getCurrentUser();
			if (!u) { alert('Inicia sesión'); window.location.href = '/index.html'; return null; }
			if (!(u.role === 'admin' || u.role === 'superadmin')) { alert('Solo para admin/superadmin'); window.location.href = '/index.html'; return null; }
			return u;
		}

		async function api(method, url, body) {
			const u = getCurrentUser();
			const headers = { 'Content-Type': 'application/json' };
			if (u && u.name) headers['X-Actor-Name'] = String(u.name);
			const res = await fetch(url, { method, headers, body: body ? JSON.stringify(body) : undefined });
			if (!res.ok) {
				const t = await res.text();
				throw new Error(t || 'API error');
			}
			return res.json();
		}

		// Load desserts from API
		async function loadDesserts() {
			try {
				desserts = await api('GET', '/api/desserts');
				desserts = Array.isArray(desserts) ? desserts : [];
				// Build map by id for quick lookup
				dessertsById.clear();
				for (const d of desserts) {
					dessertsById.set(d.id, d);
				}
			} catch (err) {
				console.error('Error loading desserts:', err);
			}
		}

		async function load() {
			// Load desserts first
			await loadDesserts();
			// Load sales consolidated data
			await loadSalesConsolidated();
		}

		function formatIsoDate(value) {
			try {
				const s = String(value || '');
				if (!s) return '';
				if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
				const iso = new Date(s).toISOString();
				return iso.slice(0,10);
			} catch { return String(value || '').slice(0,10); }
		}

		async function loadSalesConsolidated() {
			try {
				const data = await api('GET', '/api/deliveries?sales_consolidated=true');
				salesData = Array.isArray(data) ? data : [];
				renderSalesConsolidated();
			} catch (err) {
				console.error('Error loading sales consolidated:', err);
				alert('Error al cargar entregas: ' + (err.message || err));
			}
		}
		
		function renderSalesConsolidated() {
			// First render the header columns dynamically
			const theadRow = document.getElementById('sales-thead-row');
			// Remove existing dessert columns
			theadRow.querySelectorAll('th.col-qty').forEach(th => th.remove());
			
			// Get the Total column
			const totalTh = theadRow.querySelector('th:last-child');
			
			// Insert new dessert columns before Total
			for (const d of desserts) {
				const th = document.createElement('th');
				th.className = 'col-qty';
				th.textContent = d.name;
				theadRow.insertBefore(th, totalTh);
			}
			
			// Clear tbody
			salesTbody.innerHTML = '';
			
			// Render each date
			for (const dateData of salesData) {
				// Render date header row (just the date with colspan)
				const dateRow = document.createElement('tr');
				dateRow.style.backgroundColor = '#e3f2fd';
				dateRow.style.fontWeight = 'bold';
				const dateCell = document.createElement('td');
				dateCell.colSpan = 1 + desserts.length + 1; // Vendedor + all desserts + Total
				dateCell.textContent = formatIsoDate(dateData.day);
				dateCell.style.padding = '12px 8px';
				dateRow.appendChild(dateCell);
				salesTbody.appendChild(dateRow);
				
				// Render each seller
				for (let i = 0; i < dateData.sellers.length; i++) {
					const seller = dateData.sellers[i];
					const sellerKey = `${dateData.day}_${seller.seller_id}`;
					const hasSpecial = seller.has_muestra || seller.has_a_costo;
					
					// Check if has delivered quantities
					const hasDelivered = seller.delivered_quantities && Object.values(seller.delivered_quantities).some(q => q > 0);
					const hasExpandable = hasSpecial || hasDelivered;
					const isExpanded = expandedSellers.has(sellerKey);
					
					const tr = document.createElement('tr');
					tr.style.backgroundColor = '#fafafa';
					
					// Add pink border between sellers (except first one)
					if (i > 0) {
						tr.style.borderTop = '1px solid rgba(255, 192, 203, 0.4)';
					}
					
					// Seller name with expand button
					const sellerCell = document.createElement('td');
					sellerCell.style.paddingLeft = '8px';
					sellerCell.style.textAlign = 'left';
					
					// Add expand arrow if has special pricing or delivered quantities
					if (hasExpandable) {
						const expandArrow = document.createElement('span');
						expandArrow.textContent = '▼';
						expandArrow.style.display = 'inline-block';
						expandArrow.style.marginRight = '6px';
						expandArrow.style.transform = isExpanded ? 'rotate(0deg)' : 'rotate(-90deg)';
						expandArrow.style.fontSize = '10px';
						expandArrow.style.color = '#999';
						expandArrow.style.cursor = 'pointer';
						expandArrow.style.transition = 'transform 0.2s ease';
						expandArrow.style.width = '12px';
						expandArrow.style.textAlign = 'center';
						expandArrow.addEventListener('click', () => {
							if (expandedSellers.has(sellerKey)) {
								expandedSellers.delete(sellerKey);
							} else {
								expandedSellers.add(sellerKey);
							}
							renderSalesConsolidated();
						});
						sellerCell.appendChild(expandArrow);
					}
					
					const sellerNameSpan = document.createElement('span');
					sellerNameSpan.textContent = seller.seller_name;
					sellerCell.appendChild(sellerNameSpan);
					
					tr.appendChild(sellerCell);
					
					// Dessert quantities and calculate seller total
					let sellerTotal = 0;
					for (const d of desserts) {
						const qty = seller[d.short_code] || 0;
						const td = document.createElement('td');
						td.className = 'col-qty';
						td.textContent = qty;
						tr.appendChild(td);
						sellerTotal += qty;
					}
					
					// Seller total column
					const sellerTotalCell = document.createElement('td');
					sellerTotalCell.className = 'col-qty';
					sellerTotalCell.textContent = sellerTotal;
					sellerTotalCell.style.fontWeight = 'bold';
					tr.appendChild(sellerTotalCell);
					
					salesTbody.appendChild(tr);
					
					// Render expanded detail rows if expanded
					if (isExpanded && hasExpandable) {
						// Delivered row (always show for expanded sellers)
						const deliveredRow = document.createElement('tr');
						deliveredRow.style.backgroundColor = 'rgba(76, 175, 80, 0.1)';
						deliveredRow.style.fontStyle = 'italic';
						
						const labelCell = document.createElement('td');
						labelCell.textContent = '  → Entregados';
						labelCell.style.paddingLeft = '32px';
						labelCell.style.fontSize = '13px';
						labelCell.style.textAlign = 'left';
						deliveredRow.appendChild(labelCell);
						
						for (const d of desserts) {
							const qty = seller.delivered_quantities[d.short_code] || 0;
							const td = document.createElement('td');
							td.className = 'col-qty';
							td.style.cursor = 'pointer';
							td.title = 'Click para editar';
							
							if (qty > 0) {
								const badge = document.createElement('span');
								badge.textContent = qty;
								badge.style.backgroundColor = '#4caf50';
								badge.style.color = 'white';
								badge.style.padding = '3px 8px';
								badge.style.borderRadius = '12px';
								badge.style.fontSize = '12px';
								badge.style.fontWeight = 'bold';
								badge.style.display = 'inline-block';
								td.appendChild(badge);
							} else {
								const badge = document.createElement('span');
								badge.textContent = '-';
								badge.style.color = '#999';
								badge.style.fontSize = '12px';
								td.appendChild(badge);
							}
							
							// Make editable on click
							td.addEventListener('click', async () => {
								if (!requireAdmin()) return;
								await openEditDeliveredPopover(dateData.day, seller.seller_id, seller.seller_name, d.short_code, d.name, qty);
							});
							
							deliveredRow.appendChild(td);
						}
						
						// Edit all button in total cell
						const editAllCell = document.createElement('td');
						const editAllBtn = document.createElement('button');
						editAllBtn.className = 'press-btn';
						editAllBtn.textContent = 'Editar';
						editAllBtn.style.fontSize = '11px';
						editAllBtn.style.padding = '2px 8px';
						editAllBtn.addEventListener('click', async () => {
							if (!requireAdmin()) return;
							await openEditAllDeliveredPopover(dateData.day, seller.seller_id, seller.seller_name, seller.delivered_quantities);
						});
						editAllCell.appendChild(editAllBtn);
						deliveredRow.appendChild(editAllCell);
						
						salesTbody.appendChild(deliveredRow);
						
						// Muestra row
						if (seller.has_muestra) {
							const muestraRow = document.createElement('tr');
							muestraRow.style.backgroundColor = '#f3e5f5';
							muestraRow.style.fontStyle = 'italic';
							
							const labelCell = document.createElement('td');
							labelCell.textContent = '  → Muestra';
							labelCell.style.paddingLeft = '40px';
							labelCell.style.fontSize = '13px';
							muestraRow.appendChild(labelCell);
							
							for (const d of desserts) {
								const qty = seller.muestra_quantities[d.short_code] || 0;
								const td = document.createElement('td');
								td.className = 'col-qty';
								
								if (qty > 0) {
									const badge = document.createElement('span');
									badge.textContent = qty;
									badge.style.backgroundColor = '#9c27b0';
									badge.style.color = 'white';
									badge.style.padding = '3px 8px';
									badge.style.borderRadius = '12px';
									badge.style.fontSize = '12px';
									badge.style.fontWeight = 'bold';
									badge.style.display = 'inline-block';
									td.appendChild(badge);
								} else {
									td.textContent = '-';
								}
								
								muestraRow.appendChild(td);
							}
							
							// Empty total cell
							const emptyTotalCell = document.createElement('td');
							muestraRow.appendChild(emptyTotalCell);
							
							salesTbody.appendChild(muestraRow);
						}
						
						// A Costo row
						if (seller.has_a_costo) {
							const costoRow = document.createElement('tr');
							costoRow.style.backgroundColor = '#fff3e0';
							costoRow.style.fontStyle = 'italic';
							
							const labelCell = document.createElement('td');
							labelCell.textContent = '  → A Costo';
							labelCell.style.paddingLeft = '40px';
							labelCell.style.fontSize = '13px';
							costoRow.appendChild(labelCell);
							
							for (const d of desserts) {
								const qty = seller.a_costo_quantities[d.short_code] || 0;
								const td = document.createElement('td');
								td.className = 'col-qty';
								
								if (qty > 0) {
									const badge = document.createElement('span');
									badge.textContent = qty;
									badge.style.backgroundColor = '#ff9800';
									badge.style.color = 'white';
									badge.style.padding = '3px 8px';
									badge.style.borderRadius = '12px';
									badge.style.fontSize = '12px';
									badge.style.fontWeight = 'bold';
									badge.style.display = 'inline-block';
									td.appendChild(badge);
								} else {
									td.textContent = '-';
								}
								
								costoRow.appendChild(td);
							}
							
							// Empty total cell
							const emptyTotalCell = document.createElement('td');
							costoRow.appendChild(emptyTotalCell);
							
							salesTbody.appendChild(costoRow);
						}
					}
				}
				
				// Render totals row
				const totalsRow = document.createElement('tr');
				totalsRow.style.backgroundColor = '#c8e6c9';
				totalsRow.style.fontWeight = 'bold';
				
				const totalLabel = document.createElement('td');
				totalLabel.textContent = 'TOTAL';
				totalLabel.style.paddingLeft = '16px';
				totalsRow.appendChild(totalLabel);
				
				// Calculate grand total for the date
				let grandTotal = 0;
				for (const d of desserts) {
					const qty = dateData.totals[d.short_code] || 0;
					const td = document.createElement('td');
					td.className = 'col-qty';
					td.textContent = qty;
					totalsRow.appendChild(td);
					grandTotal += qty;
				}
				
				// Grand total column
				const grandTotalCell = document.createElement('td');
				grandTotalCell.className = 'col-qty';
				grandTotalCell.textContent = grandTotal;
				grandTotalCell.style.fontWeight = 'bold';
				grandTotalCell.style.fontSize = '16px';
				grandTotalCell.style.backgroundColor = '#81c784';
				totalsRow.appendChild(grandTotalCell);
				
				salesTbody.appendChild(totalsRow);
				
				// Add spacing row
				const spacingRow = document.createElement('tr');
				spacingRow.style.height = '20px';
				spacingRow.style.backgroundColor = 'transparent';
				const spacingCell = document.createElement('td');
				spacingCell.colSpan = 1 + desserts.length + 1;
				spacingCell.innerHTML = '&nbsp;';
				spacingRow.appendChild(spacingCell);
				salesTbody.appendChild(spacingRow);
			}
			
			if (salesData.length === 0) {
				const emptyRow = document.createElement('tr');
				const emptyCell = document.createElement('td');
				emptyCell.colSpan = 1 + desserts.length + 1;
				emptyCell.textContent = 'No hay datos de entregas';
				emptyCell.style.textAlign = 'center';
				emptyCell.style.padding = '32px';
				emptyCell.style.color = '#999';
				emptyRow.appendChild(emptyCell);
				salesTbody.appendChild(emptyRow);
			}
		}

		// Open popover to edit single dessert delivered quantity
		async function openEditDeliveredPopover(day, sellerId, sellerName, dessertCode, dessertName, currentQty) {
			const pop = document.createElement('div');
			pop.className = 'new-sale-popover';
			pop.style.position = 'fixed';
			pop.style.left = '50%';
			pop.style.top = '30%';
			pop.style.transform = 'translate(-50%, 0)';
			pop.style.zIndex = '1000';

			const title = document.createElement('h4');
			title.style.margin = '0 0 12px 0';
			title.textContent = `Editar entregados - ${sellerName}`;

			const grid = document.createElement('div');
			grid.className = 'new-sale-grid';

			const label = document.createElement('div');
			label.style.marginBottom = '8px';
			label.textContent = `${dessertName} entregados:`;

			const input = document.createElement('input');
			input.type = 'number';
			input.min = '0';
			input.step = '1';
			input.value = currentQty;
			input.className = 'input-cell input-qty';
			input.style.width = '100%';

			grid.appendChild(label);
			grid.appendChild(input);

			const actions = document.createElement('div');
			actions.className = 'confirm-actions';
			const cancelBtn = document.createElement('button');
			cancelBtn.className = 'press-btn';
			cancelBtn.textContent = 'Cancelar';
			const saveBtn = document.createElement('button');
			saveBtn.className = 'press-btn btn-primary';
			saveBtn.textContent = 'Guardar';
			actions.append(cancelBtn, saveBtn);

			pop.append(title, grid, actions);
			document.body.appendChild(pop);

			function cleanup() {
				if (pop.parentNode) pop.parentNode.removeChild(pop);
			}

			cancelBtn.addEventListener('click', cleanup);

			saveBtn.addEventListener('click', async () => {
				try {
					saveBtn.disabled = true;
					const qty = Math.max(0, parseInt(input.value || '0', 10));
					
					const payload = {
						day,
						seller_id: sellerId,
						dessert_code: dessertCode,
						quantity: qty
					};
					
					await api('PUT', '/api/deliveries?update_delivered=true', payload);
					cleanup();
					await loadSalesConsolidated();
				} catch (e) {
					alert('Error al guardar: ' + (e?.message || e));
					saveBtn.disabled = false;
				}
			});

			input.addEventListener('keydown', (ev) => {
				if (ev.key === 'Enter') {
					ev.preventDefault();
					saveBtn.click();
				}
			});

			setTimeout(() => { try { input.focus(); input.select(); } catch {} }, 0);
		}

		// Open popover to edit all delivered quantities
		async function openEditAllDeliveredPopover(day, sellerId, sellerName, currentQuantities) {
			const pop = document.createElement('div');
			pop.className = 'new-sale-popover';
			pop.style.position = 'fixed';
			pop.style.left = '50%';
			pop.style.top = '20%';
			pop.style.transform = 'translate(-50%, 0)';
			pop.style.zIndex = '1000';

			const title = document.createElement('h4');
			title.style.margin = '0 0 12px 0';
			title.textContent = `Editar todos los entregados - ${sellerName}`;

			const grid = document.createElement('div');
			grid.className = 'new-sale-grid';

			const inputs = {};
			for (const d of desserts) {
				const label = document.createElement('div');
				label.className = 'new-sale-label-text';
				label.textContent = d.name;

				const input = document.createElement('input');
				input.type = 'number';
				input.min = '0';
				input.step = '1';
				input.value = currentQuantities[d.short_code] || 0;
				input.className = 'input-cell input-qty';
				inputs[d.short_code] = input;

				const left = document.createElement('div');
				left.className = 'new-sale-cell new-sale-left';
				left.appendChild(label);

				const right = document.createElement('div');
				right.className = 'new-sale-cell new-sale-right';
				right.appendChild(input);

				grid.appendChild(left);
				grid.appendChild(right);
			}

			const actions = document.createElement('div');
			actions.className = 'confirm-actions';
			const cancelBtn = document.createElement('button');
			cancelBtn.className = 'press-btn';
			cancelBtn.textContent = 'Cancelar';
			const saveBtn = document.createElement('button');
			saveBtn.className = 'press-btn btn-primary';
			saveBtn.textContent = 'Guardar';
			actions.append(cancelBtn, saveBtn);

			pop.append(title, grid, actions);
			document.body.appendChild(pop);

			function cleanup() {
				if (pop.parentNode) pop.parentNode.removeChild(pop);
			}

			cancelBtn.addEventListener('click', cleanup);

			saveBtn.addEventListener('click', async () => {
				try {
					saveBtn.disabled = true;
					
					const quantities = {};
					for (const [code, input] of Object.entries(inputs)) {
						quantities[code] = Math.max(0, parseInt(input.value || '0', 10));
					}
					
					const payload = {
						day,
						seller_id: sellerId,
						quantities
					};
					
					await api('PUT', '/api/deliveries?update_all_delivered=true', payload);
					cleanup();
					await loadSalesConsolidated();
				} catch (e) {
					alert('Error al guardar: ' + (e?.message || e));
					saveBtn.disabled = false;
				}
			});

			setTimeout(() => { 
				try { 
					const firstInput = Object.values(inputs)[0];
					if (firstInput) {
						firstInput.focus();
						firstInput.select();
					}
				} catch {} 
			}, 0);
		}

		backBtn.addEventListener('click', () => { window.location.href = '/index.html'; });
		refreshSalesBtn.addEventListener('click', () => loadSalesConsolidated());
		
		requireAdmin();
		load();
	})();
	</script>
</body>
</html>


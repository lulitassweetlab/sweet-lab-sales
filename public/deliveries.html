<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Entregas - Producciones de postres</title>
	<link rel="stylesheet" href="/styles.css?v=2025-09-17-1" />
</head>
<body>
	<header class="app-header">
		<div class="header-row">
			<div class="header-left">
				<img src="/logo.png" alt="Lulitas Logo" class="app-logo" />
				<h1>Entregas</h1>
			</div>
			<div class="header-actions">
				<button id="back-btn" class="press-btn">Volver</button>
			</div>
		</div>
	</header>

	<main class="sales-panel">
		<div class="panel-header">
			<h3 id="title">Producciones de postres</h3>
			<div class="panel-actions">
				<button id="change-range" class="press-btn">Cambiar fechas</button>
			</div>
		</div>
		<div class="panel-body">
			<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
				<strong id="range-label"></strong>
				<small id="count-label" style="opacity:.8"></small>
			</div>
			<div class="table-wrapper" id="deliveries-wrapper">
				<table id="deliveries-table" class="clients-table">
					<thead>
						<tr>
							<th class="col-date">Fecha</th>
							<th>Vendedor</th>
							<th>Cliente</th>
							<th class="col-qty">Arco</th>
							<th class="col-qty">Melo</th>
							<th class="col-qty">Mara</th>
							<th class="col-qty">Oreo</th>
							<th class="col-qty">Nute</th>
							<th class="col-total">Total</th>
						</tr>
					</thead>
					<tbody id="deliveries-tbody"></tbody>
				</table>
			</div>
		</div>
	</main>

	<script type="module">
	(function(){
		const qs = new URLSearchParams(location.search);
		let start = (qs.get('start') || '').slice(0,10);
		let end = (qs.get('end') || '').slice(0,10);
		let actor = (qs.get('actor') || '').toString();
		if (!actor) { try { const saved = JSON.parse(localStorage.getItem('authUser')||'null'); actor = (saved?.name||saved?.username||'').toString(); } catch {} }
		const rangeLabel = document.getElementById('range-label');
		const countLabel = document.getElementById('count-label');
		const tbody = document.getElementById('deliveries-tbody');
		const backBtn = document.getElementById('back-btn');
		const changeBtn = document.getElementById('change-range');

		function withActor(url){
			try { const u = new URL(url, location.origin); if (actor) u.searchParams.set('actor', actor); return u.pathname + (u.search || ''); }
			catch { return url + (url.includes('?') ? `&actor=${encodeURIComponent(actor)}` : `?actor=${encodeURIComponent(actor)}`); }
		}

		async function fetchJSON(u){ const r = await fetch(u); if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); }

		function formatDay(iso){ if (!iso) return ''; const d = new Date(iso + 'T00:00:00Z'); const months=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre']; return `${d.getUTCDate()} ${months[d.getUTCMonth()]} ${d.getFullYear()}`; }

		function openActionBar(tr, sale){
			closeActionBar();
			const rect = tr.getBoundingClientRect();
			const bar = document.createElement('div');
			bar.className = 'client-action-bar';
			bar.style.position = 'fixed';
			bar.style.left = (rect.left + rect.width/2) + 'px';
			bar.style.top = (rect.top - 8) + 'px';
			bar.style.transform = 'translate(-50%, -100%)';
			// Bot√≥n Editar
			const editBtn = document.createElement('button');
			editBtn.className = 'client-action-bar-btn';
			editBtn.innerHTML = '<span class="client-action-bar-btn-icon">‚úèÔ∏è</span><span class="client-action-bar-btn-label">Editar</span>';
			editBtn.title = 'Editar pedido';
			editBtn.addEventListener('click', (e) => {
				e.stopPropagation();
				bar.classList.remove('active');
				// Reusar popup de edici√≥n si existe en app principal (abre en index)
				try {
					localStorage.setItem('pendingFocus', JSON.stringify({ sellerId: sale.seller_id, dayIso: String(sale.sale_day||'').slice(0,10), clientName: sale.client_name||'' }));
					window.open('/', '_blank');
					closeActionBar();
				} catch {}
			});
			// Bot√≥n Comentario
			const commentBtn = document.createElement('button');
			commentBtn.className = 'client-action-bar-btn';
			commentBtn.innerHTML = '<span class="client-action-bar-btn-icon">üí¨</span><span class="client-action-bar-btn-label">Comentario</span>';
			commentBtn.title = 'Agregar/editar comentario';
			commentBtn.addEventListener('click', async (e) => {
				e.stopPropagation();
				bar.classList.remove('active');
				const text = prompt('Comentario para el pedido:', (sale.comment_text||''));
				if (text == null) return;
				try {
					await fetch('/api/sales', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: sale.id, comment_text: text, _actor_name: actor }) });
					try { alert('Comentario guardado'); } catch {}
					closeActionBar();
				} catch {}
			});
			// Bot√≥n Agregar vendedor (icono)
			const addSellerBtn = document.createElement('button');
			addSellerBtn.className = 'client-action-bar-btn';
			addSellerBtn.innerHTML = '<span class="client-action-bar-btn-icon">üë§</span><span class="client-action-bar-btn-label">Agregar vendedor</span>';
			addSellerBtn.title = 'Agregar vendedor';
			addSellerBtn.addEventListener('click', async (e) => {
				e.stopPropagation();
				bar.classList.remove('active');
				const name = prompt('Nombre del vendedor a agregar:');
				if (!name || !name.trim()) return;
				try {
					await fetch('/api/sellers', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: name.trim() }) });
					try { alert('Vendedor agregado'); } catch {}
				} catch { try { alert('No se pudo agregar'); } catch {} }
				closeActionBar();
			});
			bar.append(editBtn, commentBtn, addSellerBtn);
			document.body.appendChild(bar);
			setTimeout(() => bar.classList.add('active'), 10);
			activeBar = { bar, tr };
			function outside(ev){ if (!bar.contains(ev.target)) closeActionBar(); }
			setTimeout(() => { document.addEventListener('mousedown', outside, true); document.addEventListener('touchstart', outside, true); }, 0);
			activeBar.cleanup = () => { document.removeEventListener('mousedown', outside, true); document.removeEventListener('touchstart', outside, true); };
		}

		let activeBar = null;
		function closeActionBar(){
			if (!activeBar) return;
			if (activeBar.cleanup) activeBar.cleanup();
			if (activeBar.bar && activeBar.bar.parentNode) activeBar.bar.parentNode.removeChild(activeBar.bar);
			activeBar = null;
		}

		async function load(){
			if (!start || !end) { rangeLabel.textContent = 'Selecciona rango'; openCalendar(); return; }
			rangeLabel.textContent = `${start} ‚Äî ${end}`;
			countLabel.textContent = 'Cargando‚Ä¶';
			tbody.innerHTML = '';
			// Cargar sellers y d√≠as, luego ventas
			let sellers = [];
			try { sellers = await fetchJSON(withActor('/api/sellers')); } catch { sellers = []; }
			countLabel.textContent = `Vendedores: ${sellers.length} ¬∑ Buscando d√≠as‚Ä¶`;
			const isoBetween = (iso, a, b) => iso >= a && iso <= b;
			async function mapLimit(items, limit, fn){ const out=[]; let idx=0; let running=0; let resolveAll; const done=new Promise(r=>resolveAll=r); function runNext(){ if(idx>=items.length && running===0) return resolveAll(); while(running<limit && idx<items.length){ const cur=items[idx++]; running++; Promise.resolve(fn(cur)).then(v=>{ out.push(v); running--; runNext(); }).catch(()=>{ running--; runNext(); }); } } runNext(); await done; return out; }
			const sellerDays = [];
			await mapLimit(sellers, 6, async (s) => {
				try {
					const days = await fetchJSON(withActor(`/api/days?seller_id=${encodeURIComponent(s.id)}&include_archived=1`));
					for (const d of (days||[])) { const iso = String(d.day).slice(0,10); if (isoBetween(iso, start, end)) sellerDays.push({ seller: s, day: d }); }
				} catch {}
			});
			countLabel.textContent = `D√≠as: ${sellerDays.length} ¬∑ Buscando ventas‚Ä¶`;
			const rows = [];
			await mapLimit(sellerDays, 6, async ({ seller, day }) => {
				try {
					const params = new URLSearchParams({ seller_id: String(seller.id), sale_day_id: String(day.id) });
					const sales = await fetchJSON(withActor(`/api/sales?${params.toString()}`));
					for (const r of (sales || [])) rows.push({ seller, day, sale: r });
				} catch {}
			});
			countLabel.textContent = `Ventas: ${rows.length}`;
			const fmtMoney = (n) => new Intl.NumberFormat('es-CO').format(Number(n||0));
			for (const { seller, day, sale } of rows){
				const tr = document.createElement('tr');
				tr.innerHTML = `
					<td>${String(day.day).slice(0,10)}</td>
					<td>${seller.name||''}</td>
					<td>${sale.client_name||''}</td>
					<td>${sale.qty_arco||''}</td>
					<td>${sale.qty_melo||''}</td>
					<td>${sale.qty_mara||''}</td>
					<td>${sale.qty_oreo||''}</td>
					<td>${sale.qty_nute||''}</td>
					<td class="col-total">${fmtMoney(sale.total_cents||0)}</td>`;
				// Click fila -> barra acci√≥n
				tr.addEventListener('click', () => openActionBar(tr, { ...sale, seller_id: seller.id, sale_day: day.day }));
				tbody.appendChild(tr);
			}
		}

		function openCalendar(ev){
			openRangeCalendarPopover((range) => {
				if (!range || !range.start || !range.end) return;
				start = range.start; end = range.end;
				history.replaceState(null, '', `?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}${actor?`&actor=${encodeURIComponent(actor)}`:''}`);
				load();
			}, ev?.clientX, ev?.clientY, { preferUp: true });
		}

		// Lightweight embed of openRangeCalendarPopover if not present
		if (typeof window.openRangeCalendarPopover !== 'function') {
			window.openRangeCalendarPopover = function(onPickedRange, anchorX, anchorY, opts){
				const pop = document.createElement('div'); pop.className = 'date-popover'; pop.style.position = 'fixed'; const baseX = anchorX||window.innerWidth/2; const baseY = anchorY||window.innerHeight/2; pop.style.left = baseX+'px'; pop.style.top=(baseY+8)+'px'; pop.style.transform='translate(-50%,0)'; pop.style.zIndex='1000';
				const months = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre']; let view = new Date(); view.setDate(1); let startIso=null, endIso=null;
				const header=document.createElement('div'); header.className='date-popover-header'; const prev=document.createElement('button'); prev.className='date-nav'; prev.textContent='‚Äπ'; const label=document.createElement('div'); label.className='date-label'; const next=document.createElement('button'); next.className='date-nav'; next.textContent='‚Ä∫'; header.append(prev,label,next);
				const grid=document.createElement('div'); grid.className='date-grid'; const weekdays=['L','M','X','J','V','S','D']; const wk=document.createElement('div'); wk.className='date-weekdays'; for (const w of weekdays){ const c=document.createElement('div'); c.textContent=w; wk.appendChild(c);} 
				function isoUTC(y,m,d){ return new Date(Date.UTC(y,m,d)).toISOString().slice(0,10); }
				function isBetween(x,a,b){ return x>=a && x<=b; }
				function render(){ label.textContent = months[view.getMonth()] + ' ' + view.getFullYear(); grid.innerHTML=''; const year=view.getFullYear(); const month=view.getMonth(); const firstDay=(new Date(Date.UTC(year,month,1)).getUTCDay()+6)%7; const daysInMonth=new Date(Date.UTC(year,month+1,0)).getUTCDate(); for (let i=0;i<firstDay;i++){ const cell=document.createElement('button'); cell.className='date-cell disabled'; cell.disabled=true; grid.appendChild(cell);} for (let d=1; d<=daysInMonth; d++){ const iso=isoUTC(year,month,d); const cell=document.createElement('button'); let cls='date-cell'; if (startIso && !endIso && iso===startIso) cls+=' range-start selected'; if (startIso && endIso){ if (iso===startIso) cls+=' range-start selected'; else if (iso===endIso) cls+=' range-end selected'; else if (isBetween(iso,startIso,endIso)) cls+=' in-range'; } cell.className=cls; cell.textContent=String(d); cell.addEventListener('click',()=>{ if(!startIso){ startIso=iso; endIso=null; render(); return; } if(!endIso){ if(iso<startIso){ endIso=startIso; startIso=iso; } else { endIso=iso; } render(); return; } startIso=iso; endIso=null; render(); }); grid.appendChild(cell);} }
				function cleanup(){ document.removeEventListener('mousedown', outside, true); document.removeEventListener('touchstart', outside, true); if(pop.parentNode) pop.parentNode.removeChild(pop);} function outside(ev){ if(!pop.contains(ev.target)) cleanup(); }
				prev.addEventListener('click',()=>{ view.setMonth(view.getMonth()-1); render(); }); next.addEventListener('click',()=>{ view.setMonth(view.getMonth()+1); render(); });
				const actions=document.createElement('div'); actions.style.display='flex'; actions.style.justifyContent='space-between'; actions.style.marginTop='8px'; const clearBtn=document.createElement('button'); clearBtn.className='date-nav'; clearBtn.textContent='Limpiar'; const genBtn=document.createElement('button'); genBtn.className='date-nav'; genBtn.textContent='Generar'; genBtn.disabled=true; clearBtn.addEventListener('click',()=>{ startIso=null; endIso=null; genBtn.disabled=true; render(); }); genBtn.addEventListener('click',()=>{ if(startIso && endIso && typeof onPickedRange==='function'){ cleanup(); onPickedRange({ start:startIso, end:endIso }); } }); actions.append(clearBtn, genBtn);
				const origRender = render; render = function(){ origRender(); genBtn.disabled = !(startIso && endIso); };
				pop.append(header, wk, grid, actions); document.body.appendChild(pop); pop.classList.add('aladdin-pop');
				document.addEventListener('mousedown', outside, true); document.addEventListener('touchstart', outside, true); render();
			};
		}

		backBtn.addEventListener('click', () => { location.href = '/'; });
		changeBtn.addEventListener('click', (ev) => openCalendar(ev));

		if (!start || !end) {
			rangeLabel.textContent = 'Selecciona un rango de fechas';
			const cx = Math.round(window.innerWidth / 2);
			const cy = 120;
			openRangeCalendarPopover((range) => {
				if (!range || !range.start || !range.end) return;
				start = range.start; end = range.end;
				history.replaceState(null, '', `?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}${actor?`&actor=${encodeURIComponent(actor)}`:''}`);
				load();
			}, cx, cy, { preferUp: true });
		} else {
			load();
		}
	})();
	</script>
</body>
</html>


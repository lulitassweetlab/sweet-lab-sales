<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Entregas</title>
	<link rel="stylesheet" href="/styles.css?v=2025-09-17-1" />
</head>
<body>
	<header class="app-header">
		<div class="header-row">
			<div class="header-left">
				<img src="/logo.png" alt="Lulitas Logo" class="app-logo" />
				<h1>Entregas</h1>
			</div>
			<div class="header-actions">
				<button id="back-btn" class="press-btn">Volver</button>
			</div>
		</div>
	</header>

	<main class="sales-panel">
		<div class="panel-header">
			<h3>Producciones de postres</h3>
			<div class="panel-actions">
				<button id="production-report-btn" class="press-btn">Reporte de producción</button>
				<button id="add-delivery-btn" class="press-btn btn-primary">+ Nueva entrega</button>
			</div>
		</div>
		<div class="panel-body">
			<div class="table-wrapper">
				<table id="deliveries-table">
					<thead>
						<tr>
							<th>Fecha</th>
							<th class="col-qty">Arco</th>
							<th class="col-qty">Melo</th>
							<th class="col-qty">Mara</th>
							<th class="col-qty">Oreo</th>
							<th class="col-qty">Nute</th>
							<th>Acciones</th>
						</tr>
					</thead>
					<tbody id="deliveries-tbody"></tbody>
				</table>
			</div>
		</div>
	</main>

	<script type="module">
	(function(){
		const tbody = document.getElementById('deliveries-tbody');
		const addBtn = document.getElementById('add-delivery-btn');
		const productionReportBtn = document.getElementById('production-report-btn');
		const backBtn = document.getElementById('back-btn');
		
		// Track which deliveries are expanded
		const expandedDeliveries = new Set();
		// Store current data for re-rendering
		let currentRows = [];

		function getCurrentUser(){
			try { return JSON.parse(localStorage.getItem('authUser') || 'null'); } catch { return null; }
		}

		function requireAdmin(){
			const u = getCurrentUser();
			if (!u) { alert('Inicia sesión'); window.location.href = '/index.html'; return null; }
			if (!(u.role === 'admin' || u.role === 'superadmin')) { alert('Solo para admin/superadmin'); window.location.href = '/index.html'; return null; }
			return u;
		}

		async function api(method, url, body) {
			const u = getCurrentUser();
			const headers = { 'Content-Type': 'application/json' };
			if (u && u.name) headers['X-Actor-Name'] = String(u.name);
			const res = await fetch(url, { method, headers, body: body ? JSON.stringify(body) : undefined });
			if (!res.ok) {
				const t = await res.text();
				throw new Error(t || 'API error');
			}
			return res.json();
		}

		async function load() {
			let rows = [];
			try { rows = await api('GET', '/api/deliveries'); } catch {}
			// Load seller assignments and production users for each delivery
			for (const r of rows) {
				try {
					const sellers = await api('GET', `/api/deliveries?delivery_id=${r.id}`);
					r.sellers = Array.isArray(sellers) ? sellers : [];
				} catch {
					r.sellers = [];
				}
				try {
					const usersByDessert = await api('GET', `/api/deliveries?production_users=${r.id}`);
					r.production_users_by_dessert = (usersByDessert && typeof usersByDessert === 'object') ? usersByDessert : {};
				} catch {
					r.production_users_by_dessert = {};
				}
			}
			currentRows = rows;
			render(rows);
		}

		function render(rows) {
			tbody.innerHTML = '';
			for (const r of rows) {
				tbody.appendChild(renderDeliveryRow(r));
				// Show production users if any
				if (r.production_users_by_dessert && Object.keys(r.production_users_by_dessert).length > 0) {
					tbody.appendChild(renderProductionUsersRow(r));
				}
				// Render seller rows below each delivery if expanded
				const isExpanded = expandedDeliveries.has(r.id);
				if (r.sellers && Array.isArray(r.sellers) && r.sellers.length > 0 && isExpanded) {
					for (const s of r.sellers) {
						tbody.appendChild(renderSellerRow(s, r));
					}
					// Add totals row
					tbody.appendChild(renderSellerTotalsRow(r));
					// Add spacing row
					tbody.appendChild(renderSpacingRow());
				}
			}
		}

		function formatIsoDate(value) {
			try {
				const s = String(value || '');
				if (!s) return '';
				if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
				const iso = new Date(s).toISOString();
				return iso.slice(0,10);
			} catch { return String(value || '').slice(0,10); }
		}

		function renderDeliveryRow(r) {
			const tr = document.createElement('tr');
			const dateCell = document.createElement('td');
			
			// Add toggle button if there are sellers
			const hasSellers = r.sellers && Array.isArray(r.sellers) && r.sellers.length > 0;
			if (hasSellers) {
				const isExpanded = expandedDeliveries.has(r.id);
				const toggleBtn = document.createElement('button');
				toggleBtn.className = 'press-btn';
				toggleBtn.textContent = isExpanded ? '▼' : '▶';
				toggleBtn.style.marginRight = '8px';
				toggleBtn.style.fontSize = '10px';
				toggleBtn.style.padding = '2px 6px';
				toggleBtn.addEventListener('click', () => {
					if (expandedDeliveries.has(r.id)) {
						expandedDeliveries.delete(r.id);
					} else {
						expandedDeliveries.add(r.id);
					}
					render(currentRows);
				});
				dateCell.appendChild(toggleBtn);
			}
			
			const dateText = document.createElement('span');
			dateText.textContent = formatIsoDate(r.day);
			dateCell.appendChild(dateText);
			
			const a = document.createElement('td'); a.textContent = r.arco ?? 0; a.className = 'col-qty';
			const m = document.createElement('td'); m.textContent = r.melo ?? 0; m.className = 'col-qty';
			const ma = document.createElement('td'); ma.textContent = r.mara ?? 0; ma.className = 'col-qty';
			const o = document.createElement('td'); o.textContent = r.oreo ?? 0; o.className = 'col-qty';
			const n = document.createElement('td'); n.textContent = r.nute ?? 0; n.className = 'col-qty';
			const act = document.createElement('td');
			const edit = document.createElement('button'); edit.className = 'press-btn'; edit.textContent = 'Editar';
			const notes = document.createElement('button'); notes.className = 'press-btn'; notes.textContent = 'Notas';
			const addSeller = document.createElement('button'); addSeller.className = 'press-btn'; addSeller.textContent = 'Agregar vendedor';
			
			// Add event listener for "Agregar vendedor" button
			addSeller.addEventListener('click', async () => {
				if (!requireAdmin()) return;
				const rect = addSeller.getBoundingClientRect();
				await openAddSellerPopover(r.id, rect.left + rect.width/2, rect.bottom + 8);
			});
			
			act.style.display = 'flex'; act.style.gap = '6px'; act.append(edit, notes, addSeller);
			tr.append(dateCell, a, m, ma, o, n, act);
			return tr;
		}

		function renderSellerRow(s, delivery) {
			const tr = document.createElement('tr');
			tr.style.backgroundColor = '#f5f5f5';
			tr.style.fontStyle = 'italic';
			
			const sellerCell = document.createElement('td');
			sellerCell.textContent = `  → ${s.seller_name}`;
			sellerCell.style.paddingLeft = '30px';
			
			const a = document.createElement('td'); a.textContent = s.arco ?? 0; a.className = 'col-qty';
			const m = document.createElement('td'); m.textContent = s.melo ?? 0; m.className = 'col-qty';
			const ma = document.createElement('td'); ma.textContent = s.mara ?? 0; ma.className = 'col-qty';
			const o = document.createElement('td'); o.textContent = s.oreo ?? 0; o.className = 'col-qty';
			const n = document.createElement('td'); n.textContent = s.nute ?? 0; n.className = 'col-qty';
			
			const actCell = document.createElement('td');
			const editBtn = document.createElement('button');
			editBtn.className = 'press-btn';
			editBtn.textContent = 'Editar';
			editBtn.addEventListener('click', async () => {
				if (!requireAdmin()) return;
				const rect = editBtn.getBoundingClientRect();
				await openAddSellerPopover(delivery.id, rect.left + rect.width/2, rect.bottom + 8, s);
			});
			actCell.appendChild(editBtn);
			
			tr.append(sellerCell, a, m, ma, o, n, actCell);
			return tr;
		}

		function renderSellerTotalsRow(delivery) {
			const tr = document.createElement('tr');
			tr.style.backgroundColor = '#e8f5e9';
			tr.style.fontWeight = 'bold';
			
			const labelCell = document.createElement('td');
			labelCell.textContent = 'Total vendedores';
			labelCell.style.paddingLeft = '30px';
			
			// Calculate totals
			const totals = { arco: 0, melo: 0, mara: 0, oreo: 0, nute: 0 };
			if (delivery.sellers && Array.isArray(delivery.sellers)) {
				for (const s of delivery.sellers) {
					totals.arco += s.arco ?? 0;
					totals.melo += s.melo ?? 0;
					totals.mara += s.mara ?? 0;
					totals.oreo += s.oreo ?? 0;
					totals.nute += s.nute ?? 0;
				}
			}
			
			const a = document.createElement('td'); a.textContent = totals.arco; a.className = 'col-qty';
			const m = document.createElement('td'); m.textContent = totals.melo; m.className = 'col-qty';
			const ma = document.createElement('td'); ma.textContent = totals.mara; ma.className = 'col-qty';
			const o = document.createElement('td'); o.textContent = totals.oreo; o.className = 'col-qty';
			const n = document.createElement('td'); n.textContent = totals.nute; n.className = 'col-qty';
			
			const emptyCell = document.createElement('td');
			
			tr.append(labelCell, a, m, ma, o, n, emptyCell);
			return tr;
		}

		function renderProductionUsersRow(delivery) {
			const tr = document.createElement('tr');
			tr.style.backgroundColor = '#fafafa';
			tr.style.borderTop = '1px solid #e9ecef';
			
			const labelCell = document.createElement('td');
			labelCell.style.padding = '8px';
			labelCell.style.fontSize = '11px';
			labelCell.style.fontWeight = 'bold';
			labelCell.style.color = '#495057';
			labelCell.style.verticalAlign = 'top';
			labelCell.textContent = 'Producción:';
			
			const contentCell = document.createElement('td');
			contentCell.colSpan = 6;
			contentCell.style.padding = '8px';
			
			const usersByDessert = delivery.production_users_by_dessert || {};
			
			// If we have per-dessert info, display it
			if (Object.keys(usersByDessert).length > 0) {
				const dessertNames = {
					arco: 'Arco',
					melo: 'Melo',
					mara: 'Mara',
					oreo: 'Oreo',
					nute: 'Nute'
				};
				
				const detailDiv = document.createElement('div');
				detailDiv.style.display = 'flex';
				detailDiv.style.flexDirection = 'column';
				detailDiv.style.gap = '6px';
				
				for (const [code, users] of Object.entries(usersByDessert)) {
					if (!users || users.length === 0) continue;
					
					const line = document.createElement('div');
					line.style.fontSize = '11px';
					line.style.color = '#666';
					line.style.display = 'flex';
					line.style.alignItems = 'center';
					line.style.gap = '8px';
					
					const dessertLabel = document.createElement('strong');
					dessertLabel.textContent = dessertNames[code];
					dessertLabel.style.color = '#495057';
					dessertLabel.style.minWidth = '50px';
					
					// Create user chips
					const usersContainer = document.createElement('div');
					usersContainer.style.display = 'flex';
					usersContainer.style.flexWrap = 'wrap';
					usersContainer.style.gap = '4px';
					
					for (const username of users) {
						const chip = document.createElement('span');
						chip.textContent = username;
						chip.style.fontSize = '10px';
						chip.style.padding = '2px 8px';
						chip.style.backgroundColor = '#e3f2fd';
						chip.style.color = '#1976d2';
						chip.style.borderRadius = '12px';
						chip.style.border = '1px solid #90caf9';
						usersContainer.appendChild(chip);
					}
					
					line.appendChild(dessertLabel);
					line.appendChild(usersContainer);
					detailDiv.appendChild(line);
				}
				
				contentCell.appendChild(detailDiv);
			} else {
				const noData = document.createElement('span');
				noData.style.fontSize = '11px';
				noData.style.color = '#adb5bd';
				noData.style.fontStyle = 'italic';
				noData.textContent = 'No hay información de usuarios';
				contentCell.appendChild(noData);
			}
			
			tr.appendChild(labelCell);
			tr.appendChild(contentCell);
			return tr;
		}

		function renderSpacingRow() {
			const tr = document.createElement('tr');
			tr.style.height = '20px';
			tr.style.backgroundColor = 'transparent';
			const td = document.createElement('td');
			td.colSpan = 7;
			td.innerHTML = '&nbsp;';
			tr.appendChild(td);
			return tr;
		}

		async function openAddSellerPopover(deliveryId, anchorX, anchorY, existingSeller = null) {
			try {
				// Load sellers and desserts
				let sellers = [];
				let desserts = [];
				try { 
					sellers = await api('GET', '/api/sellers'); 
					sellers = Array.isArray(sellers) ? sellers : [];
				} catch {}
				try { 
					const r = await api('GET', '/api/desserts'); 
					desserts = Array.isArray(r) ? r : [];
				} catch {}

				const pop = document.createElement('div');
				pop.className = 'new-sale-popover';
				pop.style.position = 'fixed';
				const isSmall = window.matchMedia('(max-width: 640px)').matches;
				if (typeof anchorX === 'number' && typeof anchorY === 'number' && !isSmall) {
					pop.style.left = anchorX + 'px';
					pop.style.top = anchorY + 'px';
					pop.style.transform = 'translate(-50%, 0)';
				} else {
					pop.style.left = '50%';
					pop.style.top = '20%';
					pop.style.transform = 'translate(-50%, 0)';
				}

				const title = document.createElement('h4');
				title.style.margin = '0 0 8px 0';
				title.textContent = existingSeller ? 'Editar asignación' : 'Agregar vendedor a entrega';

				const grid = document.createElement('div');
				grid.className = 'new-sale-grid';

				function appendRow(labelText, inputEl) {
					const left = document.createElement('div'); left.className = 'new-sale-cell new-sale-left';
					const right = document.createElement('div'); right.className = 'new-sale-cell new-sale-right';
					const lbl = document.createElement('div'); lbl.className = 'new-sale-label-text'; lbl.textContent = labelText;
					left.appendChild(lbl);
					right.appendChild(inputEl);
					right.addEventListener('mousedown', (ev) => { if (ev.target !== inputEl) { ev.preventDefault(); try { inputEl.focus(); inputEl.select?.(); } catch {} } });
					right.addEventListener('click', (ev) => { if (ev.target !== inputEl) { ev.preventDefault(); try { inputEl.focus(); inputEl.select?.(); } catch {} } });
					grid.appendChild(left);
					grid.appendChild(right);
				}

				// Seller dropdown
				const sellerSelect = document.createElement('select');
				sellerSelect.className = 'input-cell';
				const defaultOption = document.createElement('option');
				defaultOption.value = '';
				defaultOption.textContent = 'Seleccionar vendedor...';
				sellerSelect.appendChild(defaultOption);
				
				for (const s of sellers) {
					const opt = document.createElement('option');
					opt.value = s.id;
					opt.textContent = s.name;
					if (existingSeller && existingSeller.seller_id === s.id) {
						opt.selected = true;
					}
					sellerSelect.appendChild(opt);
				}
				appendRow('Vendedor', sellerSelect);

				// Dessert quantity inputs
				const qtyInputs = {};
				for (const d of desserts) {
					if (d.is_active === false) continue;
					const input = document.createElement('input');
					input.type = 'number'; 
					input.min = '0'; 
					input.step = '1'; 
					input.inputMode = 'numeric'; 
					input.placeholder = '0';
					input.className = 'input-cell input-qty';
					
					// Pre-fill if editing
					if (existingSeller) {
						const val = existingSeller[d.short_code];
						if (val !== undefined && val !== null) {
							input.value = val;
						}
					}
					
					qtyInputs[d.short_code] = input;
					appendRow(d.name, input);
				}

				const actions = document.createElement('div'); 
				actions.className = 'confirm-actions';
				const cancelBtn = document.createElement('button'); 
				cancelBtn.type = 'button'; 
				cancelBtn.className = 'press-btn'; 
				cancelBtn.textContent = 'Cancelar';
				const saveBtn = document.createElement('button'); 
				saveBtn.type = 'button'; 
				saveBtn.className = 'press-btn btn-primary'; 
				saveBtn.textContent = 'Guardar';
				actions.append(cancelBtn, saveBtn);

				pop.append(title, grid, actions);
				pop.style.visibility = 'hidden'; 
				pop.style.opacity = '0'; 
				pop.style.transition = 'opacity 160ms ease-out';
				document.body.appendChild(pop);

				function clampWithinViewport() {
					try {
						const margin = 8; 
						const vw = window.innerWidth; 
						const vh = window.innerHeight; 
						const r = pop.getBoundingClientRect();
						const baseX = (typeof anchorX === 'number') ? anchorX : (vw / 2);
						const baseY = (typeof anchorY === 'number') ? anchorY : (vh / 2);
						let left = Math.round(baseX - r.width / 2);
						let topBelow = Math.round(baseY + 8); 
						let topAbove = Math.round(baseY - 8 - r.height); 
						let top = topBelow;
						if (top + r.height > vh - margin) top = topAbove;
						if (top < margin) top = margin;
						if (top + r.height > vh - margin) top = Math.max(margin, vh - margin - r.height);
						if (left < margin) left = margin;
						if (left + r.width > vw - margin) left = Math.max(margin, vw - margin - r.width);
						pop.style.left = left + 'px'; 
						pop.style.top = top + 'px'; 
						pop.style.transform = 'none';
					} catch {}
				}
				clampWithinViewport(); 
				pop.style.visibility = 'visible'; 
				requestAnimationFrame(() => { pop.style.opacity = '1'; });

				function cleanup(){ 
					document.removeEventListener('mousedown', outside, true); 
					document.removeEventListener('touchstart', outside, true); 
					if (pop.parentNode) pop.parentNode.removeChild(pop); 
				}
				function outside(ev){ 
					const t = ev.target; 
					if (!pop.contains(t)) cleanup(); 
				}
				setTimeout(() => { 
					document.addEventListener('mousedown', outside, true); 
					document.addEventListener('touchstart', outside, true); 
				}, 0);
				cancelBtn.addEventListener('click', cleanup);

				setTimeout(() => { try { sellerSelect.focus(); } catch {} }, 0);

				async function doSave(){
					try {
						saveBtn.disabled = true; 
						cancelBtn.disabled = true;
						
						const sellerId = sellerSelect.value;
						if (!sellerId) {
							alert('Por favor selecciona un vendedor');
							saveBtn.disabled = false;
							cancelBtn.disabled = false;
							return;
						}

						const items = {};
						for (const [code, input] of Object.entries(qtyInputs)) { 
							const q = Math.max(0, parseInt(input?.value || '0', 10) || 0); 
							items[code] = q;
						}
						
						const payload = { 
							id: deliveryId, 
							seller_id: parseInt(sellerId, 10),
							items 
						};
						
						await api('PATCH', '/api/deliveries', payload);
						cleanup(); 
						await load();
					} catch (e) {
						alert('No se pudo guardar: ' + (e?.message || e));
						saveBtn.disabled = false; 
						cancelBtn.disabled = false;
					}
				}
				saveBtn.addEventListener('click', doSave);
				Object.values(qtyInputs).forEach((el) => { 
					el.addEventListener('keydown', (ev) => { 
						if (ev.key === 'Enter') { 
							ev.preventDefault(); 
							doSave(); 
						} 
					}); 
				});
			} catch (e) {
				alert('No se pudo abrir el formulario: ' + (e?.message || e));
			}
		}

		// User selection popover
		function openUserSelectionPopover(dessertName, selectedUsers, triggerBtn) {
			const userPop = document.createElement('div');
			userPop.className = 'new-sale-popover';
			userPop.style.position = 'fixed';
			userPop.style.left = '50%';
			userPop.style.top = '50%';
			userPop.style.transform = 'translate(-50%, -50%)';
			userPop.style.minWidth = '300px';
			userPop.style.maxWidth = '400px';
			
			const title = document.createElement('h4');
			title.style.margin = '0 0 12px 0';
			title.textContent = `Usuarios - ${dessertName}`;
			
			const userGrid = document.createElement('div');
			userGrid.style.display = 'grid';
			userGrid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(100px, 1fr))';
			userGrid.style.gap = '8px';
			userGrid.style.marginBottom = '16px';
			userGrid.style.minHeight = '60px';
			userGrid.innerHTML = '<p style="color: #6c757d; text-align: center;">Cargando usuarios...</p>';
			
			// Load users
			api('GET', '/api/users').then(r => {
				const users = Array.isArray(r) ? r : [];
				userGrid.innerHTML = '';
				
				if (users.length === 0) {
					userGrid.innerHTML = '<p style="color: #dc3545;">No hay usuarios disponibles</p>';
					return;
				}
				
				// Create button for each user
				for (const u of users) {
					const userBtn = document.createElement('button');
					userBtn.type = 'button';
					userBtn.className = 'press-btn';
					userBtn.textContent = u.username;
					userBtn.style.fontSize = '12px';
					userBtn.style.padding = '8px 12px';
					userBtn.style.transition = 'all 0.2s ease';
					userBtn.style.border = '2px solid #dee2e6';
					
					// Check if already selected
					const isSelected = selectedUsers.has(u.id);
					if (isSelected) {
						userBtn.style.backgroundColor = '#4caf50';
						userBtn.style.color = 'white';
						userBtn.style.borderColor = '#4caf50';
						userBtn.style.fontWeight = 'bold';
					} else {
						userBtn.style.backgroundColor = '#f8f9fa';
						userBtn.style.color = '#212529';
					}
					
					userBtn.addEventListener('click', (e) => {
						e.preventDefault();
						if (selectedUsers.has(u.id)) {
							selectedUsers.delete(u.id);
							userBtn.style.backgroundColor = '#f8f9fa';
							userBtn.style.color = '#212529';
							userBtn.style.borderColor = '#dee2e6';
							userBtn.style.fontWeight = 'normal';
						} else {
							selectedUsers.add(u.id);
							userBtn.style.backgroundColor = '#4caf50';
							userBtn.style.color = 'white';
							userBtn.style.borderColor = '#4caf50';
							userBtn.style.fontWeight = 'bold';
						}
						// Update trigger button text
						const count = selectedUsers.size;
						triggerBtn.textContent = count > 0 ? `Quién (${count})` : 'Quién (0)';
					});
					
					// Hover effects
					userBtn.addEventListener('mouseenter', () => {
						if (!selectedUsers.has(u.id)) {
							userBtn.style.backgroundColor = '#e9ecef';
							userBtn.style.borderColor = '#adb5bd';
						}
					});
					userBtn.addEventListener('mouseleave', () => {
						if (!selectedUsers.has(u.id)) {
							userBtn.style.backgroundColor = '#f8f9fa';
							userBtn.style.borderColor = '#dee2e6';
						}
					});
					
					userGrid.appendChild(userBtn);
				}
			}).catch((err) => {
				userGrid.innerHTML = '<p style="color: #dc3545;">Error cargando usuarios</p>';
				console.error('Error loading users:', err);
			});
			
			const closeBtn = document.createElement('button');
			closeBtn.type = 'button';
			closeBtn.className = 'press-btn btn-primary';
			closeBtn.textContent = 'Cerrar';
			closeBtn.style.width = '100%';
			
			userPop.append(title, userGrid, closeBtn);
			userPop.style.visibility = 'hidden';
			userPop.style.opacity = '0';
			userPop.style.transition = 'opacity 160ms ease-out';
			document.body.appendChild(userPop);
			
			requestAnimationFrame(() => {
				userPop.style.visibility = 'visible';
				userPop.style.opacity = '1';
			});
			
			function cleanup() {
				document.removeEventListener('mousedown', outside, true);
				if (userPop.parentNode) userPop.parentNode.removeChild(userPop);
			}
			
			function outside(ev) {
				const t = ev.target;
				if (!userPop.contains(t) && t !== triggerBtn) cleanup();
			}
			
			setTimeout(() => {
				document.addEventListener('mousedown', outside, true);
			}, 0);
			
			closeBtn.addEventListener('click', cleanup);
		}

		async function openProductionPopover(anchorX, anchorY) {
			try {
				// Load dynamic desserts and users
				let desserts = [];
				let users = [];
				try { const r = await api('GET', '/api/desserts'); desserts = Array.isArray(r) ? r : []; } catch {}
				try { const r = await api('GET', '/api/users'); users = Array.isArray(r) ? r : []; } catch {}
				// Build popover similar to Nuevo pedido
				const pop = document.createElement('div');
				pop.className = 'new-sale-popover';
				pop.style.position = 'fixed';
				pop.style.left = '50%';
				pop.style.top = '50%';
				pop.style.transform = 'translate(-50%, -50%)';
				pop.style.maxHeight = '90vh';
				pop.style.overflowY = 'auto';

				const title = document.createElement('h4');
				title.style.margin = '0 0 8px 0';
				function formatTitle(iso){
					try {
						const d = iso ? new Date(iso + 'T00:00:00Z') : new Date();
						const mes = d.toLocaleString('es-CO', { month: 'long', timeZone: 'UTC' });
						const dia = d.getUTCDate();
						const cap = mes.charAt(0).toUpperCase() + mes.slice(1);
						return `Producción ${cap} ${dia}`;
					} catch { return 'Producción'; }
				}
				const todayIso = new Date().toISOString().slice(0,10);
				title.textContent = formatTitle(todayIso);

				const grid = document.createElement('div');
				grid.className = 'new-sale-grid';

				function appendRow(labelText, inputEl, noInteraction = false) {
					const left = document.createElement('div'); left.className = 'new-sale-cell new-sale-left';
					const right = document.createElement('div'); right.className = 'new-sale-cell new-sale-right';
					const lbl = document.createElement('div'); lbl.className = 'new-sale-label-text'; lbl.textContent = labelText;
					left.appendChild(lbl);
					right.appendChild(inputEl);
					if (!noInteraction) {
						right.addEventListener('mousedown', (ev) => { if (ev.target !== inputEl && !inputEl.contains(ev.target)) { ev.preventDefault(); try { inputEl.focus(); inputEl.select?.(); } catch {} } });
						right.addEventListener('click', (ev) => { if (ev.target !== inputEl && !inputEl.contains(ev.target)) { ev.preventDefault(); try { inputEl.focus(); inputEl.select?.(); } catch {} } });
					}
					grid.appendChild(left);
					grid.appendChild(right);
				}

				// Fecha row
				const dateInput = document.createElement('input');
				dateInput.type = 'date';
				dateInput.className = 'input-cell';
				dateInput.value = todayIso;
				dateInput.addEventListener('change', () => { title.textContent = formatTitle(dateInput.value); });
				appendRow('Fecha', dateInput);

				// Dessert quantity rows with user selectors
				const qtyInputs = {};
				const userSelections = {};
				
				for (const d of desserts) {
					if (d.is_active === false) continue;
					
					// Container for input and user selector
					const container = document.createElement('div');
					container.style.display = 'flex';
					container.style.flexDirection = 'row';
					container.style.alignItems = 'center';
					container.style.gap = '8px';
					
					// Quantity input
					const input = document.createElement('input');
					input.type = 'number'; 
					input.min = '0'; 
					input.step = '1'; 
					input.inputMode = 'numeric'; 
					input.placeholder = '0';
					input.className = 'input-cell input-qty';
					qtyInputs[d.short_code] = input;
					container.appendChild(input);
					
					// User selector button
					const selectedUsers = new Set();
					userSelections[d.short_code] = selectedUsers;
					
					const selectorBtn = document.createElement('button');
					selectorBtn.type = 'button';
					selectorBtn.className = 'press-btn';
					selectorBtn.textContent = 'Quién (0)';
					selectorBtn.style.fontSize = '11px';
					selectorBtn.style.padding = '4px 8px';
					selectorBtn.style.whiteSpace = 'nowrap';
					selectorBtn.style.minWidth = '80px';
					
					// Open user selection popover
					selectorBtn.addEventListener('click', (e) => {
						e.preventDefault();
						e.stopPropagation();
						openUserSelectionPopover(d.name, selectedUsers, selectorBtn);
					});
					
					container.appendChild(selectorBtn);
					
					appendRow(d.name, container, true);
				}

				const actions = document.createElement('div'); 
				actions.className = 'confirm-actions';
				const cancelBtn = document.createElement('button'); 
				cancelBtn.type = 'button'; 
				cancelBtn.className = 'press-btn'; 
				cancelBtn.textContent = 'Cancelar';
				const saveBtn = document.createElement('button'); 
				saveBtn.type = 'button'; 
				saveBtn.className = 'press-btn btn-primary'; 
				saveBtn.textContent = 'Guardar';
				actions.append(cancelBtn, saveBtn);

				pop.append(title, grid, actions);
				pop.style.visibility = 'hidden'; 
				pop.style.opacity = '0'; 
				pop.style.transition = 'opacity 160ms ease-out';
				document.body.appendChild(pop);

				// Center the popover
				requestAnimationFrame(() => {
					pop.style.visibility = 'visible';
					pop.style.opacity = '1';
				});

				function cleanup(){ 
					document.removeEventListener('mousedown', outside, true); 
					document.removeEventListener('touchstart', outside, true); 
					if (pop.parentNode) pop.parentNode.removeChild(pop); 
				}
				function outside(ev){ 
					const t = ev.target; 
					if (!pop.contains(t)) cleanup(); 
				}
				setTimeout(() => { 
					document.addEventListener('mousedown', outside, true); 
					document.addEventListener('touchstart', outside, true); 
				}, 0);
				cancelBtn.addEventListener('click', cleanup);

				setTimeout(() => { try { dateInput.focus(); } catch {} }, 0);

				async function doSave(){
					try {
						saveBtn.disabled = true; 
						cancelBtn.disabled = true;
						const items = {};
						const production_users = {};
						
						// Collect quantities
						for (const [code, input] of Object.entries(qtyInputs)) { 
							const q = Math.max(0, parseInt(input?.value || '0', 10) || 0); 
							if (q > 0) items[code] = q; 
						}
						
						// Apply selected users for each dessert
						for (const [code, selectedSet] of Object.entries(userSelections)) {
							if (selectedSet.size > 0) {
								production_users[code] = Array.from(selectedSet);
							}
						}
						
						const payload = { day: dateInput.value || todayIso, items, production_users };
						await api('POST', '/api/deliveries', payload);
						cleanup(); 
						await load();
					} catch (e) {
						alert('No se pudo guardar: ' + (e?.message || e));
						saveBtn.disabled = false; 
						cancelBtn.disabled = false;
					}
				}
				saveBtn.addEventListener('click', doSave);
				Object.values(qtyInputs).forEach((el) => { 
					el.addEventListener('keydown', (ev) => { 
						if (ev.key === 'Enter') { 
							ev.preventDefault(); 
							doSave(); 
						} 
					}); 
				});
			} catch (e) {
				alert('No se pudo abrir el formulario');
			}
		}

		addBtn.addEventListener('click', async () => {
			if (!requireAdmin()) return;
			const rect = addBtn.getBoundingClientRect();
			await openProductionPopover(rect.left + rect.width/2, rect.bottom + 8);
		});

		productionReportBtn.addEventListener('click', async () => {
			if (!requireAdmin()) return;
			const rect = productionReportBtn.getBoundingClientRect();
			await openProductionReportPopover(rect.left + rect.width/2, rect.bottom + 8);
		});

		async function openProductionReportPopover(anchorX, anchorY) {
			try {
				const pop = document.createElement('div');
				pop.className = 'new-sale-popover';
				pop.style.position = 'fixed';
				const isSmall = window.matchMedia('(max-width: 640px)').matches;
				if (typeof anchorX === 'number' && typeof anchorY === 'number' && !isSmall) {
					pop.style.left = anchorX + 'px';
					pop.style.top = anchorY + 'px';
					pop.style.transform = 'translate(-50%, 0)';
				} else {
					pop.style.left = '50%';
					pop.style.top = '20%';
					pop.style.transform = 'translate(-50%, 0)';
				}

				const title = document.createElement('h4');
				title.style.margin = '0 0 12px 0';
				title.textContent = 'Reporte de producción';

				const grid = document.createElement('div');
				grid.className = 'new-sale-grid';

				function appendRow(labelText, inputEl) {
					const left = document.createElement('div'); left.className = 'new-sale-cell new-sale-left';
					const right = document.createElement('div'); right.className = 'new-sale-cell new-sale-right';
					const lbl = document.createElement('div'); lbl.className = 'new-sale-label-text'; lbl.textContent = labelText;
					left.appendChild(lbl);
					right.appendChild(inputEl);
					grid.appendChild(left);
					grid.appendChild(right);
				}

				// Date inputs
				const todayIso = new Date().toISOString().slice(0,10);
				const startDate = document.createElement('input');
				startDate.type = 'date';
				startDate.className = 'input-cell';
				startDate.value = todayIso;
				appendRow('Fecha inicio', startDate);

				const endDate = document.createElement('input');
				endDate.type = 'date';
				endDate.className = 'input-cell';
				endDate.value = todayIso;
				appendRow('Fecha fin', endDate);

				// Results container
				const resultsDiv = document.createElement('div');
				resultsDiv.style.marginTop = '16px';
				resultsDiv.style.maxHeight = '400px';
				resultsDiv.style.overflowY = 'auto';

				const actions = document.createElement('div');
				actions.className = 'confirm-actions';
				const cancelBtn = document.createElement('button');
				cancelBtn.type = 'button';
				cancelBtn.className = 'press-btn';
				cancelBtn.textContent = 'Cancelar';
				const generateBtn = document.createElement('button');
				generateBtn.type = 'button';
				generateBtn.className = 'press-btn btn-primary';
				generateBtn.textContent = 'Generar';
				actions.append(cancelBtn, generateBtn);

				pop.append(title, grid, resultsDiv, actions);
				pop.style.visibility = 'hidden';
				pop.style.opacity = '0';
				pop.style.transition = 'opacity 160ms ease-out';
				document.body.appendChild(pop);

				function clampWithinViewport() {
					try {
						const margin = 8;
						const vw = window.innerWidth;
						const vh = window.innerHeight;
						const r = pop.getBoundingClientRect();
						const baseX = (typeof anchorX === 'number') ? anchorX : (vw / 2);
						const baseY = (typeof anchorY === 'number') ? anchorY : (vh / 2);
						let left = Math.round(baseX - r.width / 2);
						let topBelow = Math.round(baseY + 8);
						let topAbove = Math.round(baseY - 8 - r.height);
						let top = topBelow;
						if (top + r.height > vh - margin) top = topAbove;
						if (top < margin) top = margin;
						if (top + r.height > vh - margin) top = Math.max(margin, vh - margin - r.height);
						if (left < margin) left = margin;
						if (left + r.width > vw - margin) left = Math.max(margin, vw - margin - r.width);
						pop.style.left = left + 'px';
						pop.style.top = top + 'px';
						pop.style.transform = 'none';
					} catch {}
				}
				clampWithinViewport();
				pop.style.visibility = 'visible';
				requestAnimationFrame(() => { pop.style.opacity = '1'; });

				function cleanup() {
					document.removeEventListener('mousedown', outside, true);
					document.removeEventListener('touchstart', outside, true);
					if (pop.parentNode) pop.parentNode.removeChild(pop);
				}
				function outside(ev) {
					const t = ev.target;
					if (!pop.contains(t)) cleanup();
				}
				setTimeout(() => {
					document.addEventListener('mousedown', outside, true);
					document.addEventListener('touchstart', outside, true);
				}, 0);
				cancelBtn.addEventListener('click', cleanup);

				async function generateReport() {
					try {
						generateBtn.disabled = true;
						const start = startDate.value;
						const end = endDate.value;
						if (!start || !end) {
							alert('Por favor selecciona ambas fechas');
							generateBtn.disabled = false;
							return;
						}

						const data = await api('GET', `/api/deliveries?report=production&start=${start}&end=${end}`);
						
						// Create table
						resultsDiv.innerHTML = '';
						const table = document.createElement('table');
						table.style.width = '100%';
						table.style.borderCollapse = 'collapse';
						table.style.fontSize = '12px';
						
						const thead = document.createElement('thead');
						const headerRow = document.createElement('tr');
						const headers = ['Usuario', 'Arco', 'Melo', 'Mara', 'Oreo', 'Nute'];
						for (const h of headers) {
							const th = document.createElement('th');
							th.textContent = h;
							th.style.borderBottom = '2px solid #ddd';
							th.style.padding = '8px';
							th.style.textAlign = 'left';
							headerRow.appendChild(th);
						}
						thead.appendChild(headerRow);
						table.appendChild(thead);
						
						const tbody = document.createElement('tbody');
						for (const [username, quantities] of Object.entries(data)) {
							const row = document.createElement('tr');
							const userCell = document.createElement('td');
							userCell.textContent = username;
							userCell.style.padding = '6px 8px';
							userCell.style.borderBottom = '1px solid #eee';
							row.appendChild(userCell);
							
							for (const code of ['arco', 'melo', 'mara', 'oreo', 'nute']) {
								const cell = document.createElement('td');
								cell.textContent = quantities[code] || 0;
								cell.style.padding = '6px 8px';
								cell.style.textAlign = 'center';
								cell.style.borderBottom = '1px solid #eee';
								row.appendChild(cell);
							}
							tbody.appendChild(row);
						}
						table.appendChild(tbody);
						resultsDiv.appendChild(table);
						
						generateBtn.disabled = false;
					} catch (e) {
						alert('Error al generar reporte: ' + (e?.message || e));
						generateBtn.disabled = false;
					}
				}
				generateBtn.addEventListener('click', generateReport);
			} catch (e) {
				alert('No se pudo abrir el formulario: ' + (e?.message || e));
			}
		}

		backBtn.addEventListener('click', () => { window.location.href = '/index.html'; });
		requireAdmin();
		load();
	})();
	</script>
</body>
</html>


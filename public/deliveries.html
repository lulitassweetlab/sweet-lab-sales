<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Entregas</title>
	<link rel="stylesheet" href="/styles.css?v=2025-09-17-1" />
</head>
<body>
	<header class="app-header">
		<div class="header-row">
			<div class="header-left">
				<img src="/logo.png" alt="Lulitas Logo" class="app-logo" />
				<h1>Entregas</h1>
			</div>
			<div class="header-actions">
				<button id="back-btn" class="press-btn">Volver</button>
			</div>
		</div>
	</header>

	<main class="sales-panel">
		<div class="panel-header">
			<h3>Entregas</h3>
			<div class="panel-actions">
				<button id="refresh-sales-btn" class="press-btn">Actualizar</button>
			</div>
		</div>
		<div class="panel-body">
			<div class="table-wrapper">
				<table id="sales-consolidated-table">
					<thead>
						<tr id="sales-thead-row">
							<th>Fecha</th>
							<th>Vendedor</th>
							<!-- Dynamic dessert columns will be inserted here -->
							<th>Total</th>
						</tr>
					</thead>
					<tbody id="sales-tbody"></tbody>
				</table>
			</div>
		</div>
	</main>

	<script type="module">
	(function(){
		const backBtn = document.getElementById('back-btn');
		const refreshSalesBtn = document.getElementById('refresh-sales-btn');
		const salesTbody = document.getElementById('sales-tbody');
		
		// Dynamic desserts from API
		let desserts = [];
		let dessertsById = new Map();
		let salesData = [];

		function getCurrentUser(){
			try { return JSON.parse(localStorage.getItem('authUser') || 'null'); } catch { return null; }
		}

		function requireAdmin(){
			const u = getCurrentUser();
			if (!u) { alert('Inicia sesiÃ³n'); window.location.href = '/index.html'; return null; }
			if (!(u.role === 'admin' || u.role === 'superadmin')) { alert('Solo para admin/superadmin'); window.location.href = '/index.html'; return null; }
			return u;
		}

		async function api(method, url, body) {
			const u = getCurrentUser();
			const headers = { 'Content-Type': 'application/json' };
			if (u && u.name) headers['X-Actor-Name'] = String(u.name);
			const res = await fetch(url, { method, headers, body: body ? JSON.stringify(body) : undefined });
			if (!res.ok) {
				const t = await res.text();
				throw new Error(t || 'API error');
			}
			return res.json();
		}

		// Load desserts from API
		async function loadDesserts() {
			try {
				desserts = await api('GET', '/api/desserts');
				desserts = Array.isArray(desserts) ? desserts : [];
				// Build map by id for quick lookup
				dessertsById.clear();
				for (const d of desserts) {
					dessertsById.set(d.id, d);
				}
			} catch (err) {
				console.error('Error loading desserts:', err);
			}
		}

		async function load() {
			// Load desserts first
			await loadDesserts();
			// Load sales consolidated data
			await loadSalesConsolidated();
		}

		function formatIsoDate(value) {
			try {
				const s = String(value || '');
				if (!s) return '';
				if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
				const iso = new Date(s).toISOString();
				return iso.slice(0,10);
			} catch { return String(value || '').slice(0,10); }
		}

		async function loadSalesConsolidated() {
			try {
				const data = await api('GET', '/api/deliveries?sales_consolidated=true');
				salesData = Array.isArray(data) ? data : [];
				renderSalesConsolidated();
			} catch (err) {
				console.error('Error loading sales consolidated:', err);
				alert('Error al cargar entregas: ' + (err.message || err));
			}
		}
		
		function renderSalesConsolidated() {
			// First render the header columns dynamically
			const theadRow = document.getElementById('sales-thead-row');
			// Remove existing dessert columns
			theadRow.querySelectorAll('th.col-qty').forEach(th => th.remove());
			
			// Get the Total column
			const totalTh = theadRow.querySelector('th:last-child');
			
			// Insert new dessert columns before Total
			for (const d of desserts) {
				const th = document.createElement('th');
				th.className = 'col-qty';
				th.textContent = d.name;
				theadRow.insertBefore(th, totalTh);
			}
			
			// Clear tbody
			salesTbody.innerHTML = '';
			
			// Render each date
			for (const dateData of salesData) {
				// Render date header row (just the date with colspan)
				const dateRow = document.createElement('tr');
				dateRow.style.backgroundColor = '#e3f2fd';
				dateRow.style.fontWeight = 'bold';
				const dateCell = document.createElement('td');
				dateCell.colSpan = 2 + desserts.length + 1; // Fecha + Vendedor + all desserts + Total
				dateCell.textContent = formatIsoDate(dateData.day);
				dateCell.style.padding = '12px 8px';
				dateRow.appendChild(dateCell);
				salesTbody.appendChild(dateRow);
				
				// Render each seller
				for (let i = 0; i < dateData.sellers.length; i++) {
					const seller = dateData.sellers[i];
					const tr = document.createElement('tr');
					tr.style.backgroundColor = '#fafafa';
					
					// Add pink border between sellers (except first one)
					if (i > 0) {
						tr.style.borderTop = '1px solid rgba(255, 192, 203, 0.4)';
					}
					
					// Empty cell for Fecha column (merge with date header visually)
					const emptyDateCell = document.createElement('td');
					emptyDateCell.textContent = '';
					tr.appendChild(emptyDateCell);
					
					// Seller name with special pricing indicators
					const sellerCell = document.createElement('td');
					sellerCell.style.paddingLeft = '16px';
					
					const sellerNameSpan = document.createElement('span');
					sellerNameSpan.textContent = seller.seller_name;
					sellerCell.appendChild(sellerNameSpan);
					
					// Add badges for special pricing
					if (seller.has_muestra) {
						const badge = document.createElement('span');
						badge.textContent = 'Muestra';
						badge.style.marginLeft = '6px';
						badge.style.fontSize = '10px';
						badge.style.padding = '2px 6px';
						badge.style.backgroundColor = '#9c27b0';
						badge.style.color = 'white';
						badge.style.borderRadius = '3px';
						badge.style.fontWeight = 'bold';
						sellerCell.appendChild(badge);
					}
					
					if (seller.has_a_costo) {
						const badge = document.createElement('span');
						badge.textContent = 'A Costo';
						badge.style.marginLeft = '6px';
						badge.style.fontSize = '10px';
						badge.style.padding = '2px 6px';
						badge.style.backgroundColor = '#ff9800';
						badge.style.color = 'white';
						badge.style.borderRadius = '3px';
						badge.style.fontWeight = 'bold';
						sellerCell.appendChild(badge);
					}
					
					tr.appendChild(sellerCell);
					
					// Dessert quantities and calculate seller total
					let sellerTotal = 0;
					for (const d of desserts) {
						const qty = seller[d.short_code] || 0;
						const td = document.createElement('td');
						td.className = 'col-qty';
						td.textContent = qty;
						tr.appendChild(td);
						sellerTotal += qty;
					}
					
					// Seller total column
					const sellerTotalCell = document.createElement('td');
					sellerTotalCell.className = 'col-qty';
					sellerTotalCell.textContent = sellerTotal;
					sellerTotalCell.style.fontWeight = 'bold';
					tr.appendChild(sellerTotalCell);
					
					salesTbody.appendChild(tr);
				}
				
				// Render totals row
				const totalsRow = document.createElement('tr');
				totalsRow.style.backgroundColor = '#c8e6c9';
				totalsRow.style.fontWeight = 'bold';
				
				const emptyTotalDateCell = document.createElement('td');
				totalsRow.appendChild(emptyTotalDateCell);
				
				const totalLabel = document.createElement('td');
				totalLabel.textContent = 'TOTAL';
				totalLabel.style.paddingLeft = '16px';
				totalsRow.appendChild(totalLabel);
				
				// Calculate grand total for the date
				let grandTotal = 0;
				for (const d of desserts) {
					const qty = dateData.totals[d.short_code] || 0;
					const td = document.createElement('td');
					td.className = 'col-qty';
					td.textContent = qty;
					totalsRow.appendChild(td);
					grandTotal += qty;
				}
				
				// Grand total column
				const grandTotalCell = document.createElement('td');
				grandTotalCell.className = 'col-qty';
				grandTotalCell.textContent = grandTotal;
				grandTotalCell.style.fontWeight = 'bold';
				grandTotalCell.style.fontSize = '16px';
				grandTotalCell.style.backgroundColor = '#81c784';
				totalsRow.appendChild(grandTotalCell);
				
				salesTbody.appendChild(totalsRow);
				
				// Add spacing row
				const spacingRow = document.createElement('tr');
				spacingRow.style.height = '20px';
				spacingRow.style.backgroundColor = 'transparent';
				const spacingCell = document.createElement('td');
				spacingCell.colSpan = 2 + desserts.length + 1;
				spacingCell.innerHTML = '&nbsp;';
				spacingRow.appendChild(spacingCell);
				salesTbody.appendChild(spacingRow);
			}
			
			if (salesData.length === 0) {
				const emptyRow = document.createElement('tr');
				const emptyCell = document.createElement('td');
				emptyCell.colSpan = 2 + desserts.length + 1;
				emptyCell.textContent = 'No hay datos de entregas';
				emptyCell.style.textAlign = 'center';
				emptyCell.style.padding = '32px';
				emptyCell.style.color = '#999';
				emptyRow.appendChild(emptyCell);
				salesTbody.appendChild(emptyRow);
			}
		}

		backBtn.addEventListener('click', () => { window.location.href = '/index.html'; });
		refreshSalesBtn.addEventListener('click', () => loadSalesConsolidated());
		
		requireAdmin();
		load();
	})();
	</script>
</body>
</html>


<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Subir comprobante</title>
	<style>
		body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; padding: 20px; background: var(--background, #fff); color: var(--foreground, #111); }
		.card { max-width: 560px; margin: 0 auto; background: var(--card, #fff); border: 1px solid var(--border, #e5e7eb); border-radius: 12px; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.06); }
		h1 { font-size: 18px; margin: 0 0 8px; font-weight: 500; }
		label { display: block; margin: 12px 0 6px; font-size: 14px; }
		input[type="file"] { display: block; width: 100%; }
		.preview { margin-top: 12px; display: none; }
		.preview img { max-width: 100%; border-radius: 8px; border: 1px solid var(--border, #e5e7eb); }
		.actions { margin-top: 14px; display: flex; gap: 8px; justify-content: flex-end; }
		.btn { border: 1px solid var(--border, #e5e7eb); background: var(--card, #fff); color: inherit; border-radius: 10px; padding: 8px 12px; cursor: pointer; }
		.btn-primary { background: var(--primary, #f4a6b7); color: #fff; border-color: transparent; }
		.btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
		.note { font-size: 12px; color: #6b7280; margin-top: 8px; }
		
		/* Loading overlay */
		.loading-overlay {
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: rgba(0, 0, 0, 0.7);
			display: none;
			align-items: center;
			justify-content: center;
			z-index: 9999;
			opacity: 0;
			transition: opacity 0.3s ease;
		}
		.loading-overlay.show {
			display: flex;
			opacity: 1;
		}
		.loading-content {
			background: var(--card, #fff);
			padding: 32px 48px;
			border-radius: 16px;
			text-align: center;
			box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
			transform: scale(0.9);
			transition: transform 0.3s ease;
		}
		.loading-overlay.show .loading-content {
			transform: scale(1);
		}
		.spinner {
			width: 48px;
			height: 48px;
			margin: 0 auto 16px;
			border: 4px solid var(--border, #e5e7eb);
			border-top-color: var(--primary, #f4a6b7);
			border-radius: 50%;
			animation: spin 0.8s linear infinite;
		}
		@keyframes spin {
			to { transform: rotate(360deg); }
		}
		.loading-text {
			font-size: 16px;
			font-weight: 500;
			color: var(--foreground, #111);
			margin: 0;
		}
		.loading-subtext {
			font-size: 14px;
			color: #6b7280;
			margin: 8px 0 0;
		}
		.success-icon {
			width: 64px;
			height: 64px;
			margin: 0 auto 16px;
			border-radius: 50%;
			background: #10b981;
			display: flex;
			align-items: center;
			justify-content: center;
			animation: successPop 0.4s ease;
		}
		@keyframes successPop {
			0% { transform: scale(0); }
			50% { transform: scale(1.1); }
			100% { transform: scale(1); }
		}
		.success-icon::after {
			content: '✓';
			color: white;
			font-size: 36px;
			font-weight: bold;
		}
	</style>
</head>
<body>
	<div class="card">
		<h1>Subir comprobante de transferencia</h1>
		<div id="sale-info" class="note"></div>
		<label for="file">Foto(s) del comprobante</label>
		<input id="file" type="file" accept="image/*" multiple />
		<label for="note">Nota (opcional)</label>
		<textarea id="note" rows="3" placeholder="Escribe una nota..." style="width:100%; resize: vertical;"></textarea>
		<div class="preview" id="preview">
			<!-- Images will be added here dynamically -->
		</div>
		<div class="actions">
			<button class="btn" id="back">Cancelar</button>
			<button class="btn btn-primary" id="upload" disabled>Subir</button>
		</div>
		<div class="note">Formatos comunes: JPG, PNG. Tamaño máximo recomendado 2MB.</div>
	</div>

	<!-- Loading overlay -->
	<div class="loading-overlay" id="loading-overlay">
		<div class="loading-content" id="loading-content">
			<div class="spinner" id="spinner"></div>
			<div class="success-icon" id="success-icon" style="display: none;"></div>
			<p class="loading-text" id="loading-text">Procesando...</p>
			<p class="loading-subtext" id="loading-subtext"></p>
		</div>
	</div>

	<script>
	(function(){
		const qs = new URLSearchParams(location.search);
		const saleId = Number(qs.get('sale_id'));
		document.getElementById('sale-info').textContent = saleId ? ('Venta #' + saleId) : '';
		// Resolve actor name from saved auth user
		let actorName = '';
		try { const saved = localStorage.getItem('authUser'); if (saved) { const u = JSON.parse(saved); actorName = (u && (u.name || u.username)) ? (u.name || u.username) : ''; } } catch {}
		const fileInput = document.getElementById('file');
		const preview = document.getElementById('preview');
		const uploadBtn = document.getElementById('upload');
		let selectedFiles = [];
		
		document.getElementById('back').addEventListener('click', () => history.length > 1 ? history.back() : (location.href = '/'));
		
		fileInput.addEventListener('change', () => {
			const files = fileInput.files;
			if (!files || files.length === 0) { 
				preview.style.display = 'none'; 
				preview.innerHTML = '';
				uploadBtn.disabled = true; 
				selectedFiles = [];
				return; 
			}
			
			// Store files for later upload
			selectedFiles = Array.from(files);
			
			// Show previews
			preview.innerHTML = '';
			preview.style.display = 'block';
			
			selectedFiles.forEach((file, index) => {
				const reader = new FileReader();
				reader.onload = (e) => {
					const imgContainer = document.createElement('div');
					imgContainer.style.marginBottom = '12px';
					
					const img = document.createElement('img');
					img.src = e.target.result;
					img.alt = 'Vista previa ' + (index + 1);
					img.style.maxWidth = '100%';
					img.style.borderRadius = '8px';
					img.style.border = '1px solid var(--border, #e5e7eb)';
					
					const label = document.createElement('div');
					label.textContent = 'Archivo ' + (index + 1) + ': ' + file.name;
					label.style.fontSize = '12px';
					label.style.marginBottom = '4px';
					label.style.opacity = '0.75';
					
					imgContainer.appendChild(label);
					imgContainer.appendChild(img);
					preview.appendChild(imgContainer);
				};
				reader.readAsDataURL(file);
			});
			
			uploadBtn.disabled = false;
			uploadBtn.textContent = `Subir ${selectedFiles.length} archivo${selectedFiles.length > 1 ? 's' : ''}`;
		});
		
		uploadBtn.addEventListener('click', async () => {
			if (selectedFiles.length === 0 || !saleId) return;
			uploadBtn.disabled = true;
			
			// Show loading overlay
			const overlay = document.getElementById('loading-overlay');
			const loadingText = document.getElementById('loading-text');
			const loadingSubtext = document.getElementById('loading-subtext');
			const spinner = document.getElementById('spinner');
			const successIcon = document.getElementById('success-icon');
			
			overlay.classList.add('show');
			loadingText.textContent = 'Procesando...';
			loadingSubtext.textContent = '';
			
			const note = (document.getElementById('note').value || '').toString();
			let successCount = 0;
			let errorCount = 0;
			
			try {
				// Upload each file
				for (let i = 0; i < selectedFiles.length; i++) {
					const file = selectedFiles[i];
					loadingText.textContent = 'Subiendo archivos...';
					loadingSubtext.textContent = `${i + 1} de ${selectedFiles.length}`;
					
					try {
						const base64 = await new Promise((resolve, reject) => {
							const reader = new FileReader();
							reader.onload = () => resolve(reader.result);
							reader.onerror = reject;
							reader.readAsDataURL(file);
						});
						
						const res = await fetch('/api/sales', { 
							method: 'POST', 
							headers: { 'Content-Type': 'application/json' }, 
							body: JSON.stringify({ 
								_upload_receipt_for: saleId, 
								image_base64: base64, 
								note_text: note,
								_actor_name: actorName 
							}) 
						});
						
						if (!res.ok) {
							console.error('Error uploading file:', file.name);
							errorCount++;
						} else {
							successCount++;
						}
					} catch (e) {
						console.error('Error processing file:', file.name, e);
						errorCount++;
					}
				}
				
				// Show results
				if (successCount > 0 && errorCount === 0) {
					// Success animation
					spinner.style.display = 'none';
					successIcon.style.display = 'flex';
					const fileWord = successCount === 1 ? 'archivo' : 'archivos';
					const uploadedWord = successCount === 1 ? 'subido' : 'subidos';
					loadingText.textContent = `${successCount} ${fileWord} ${uploadedWord}`;
					loadingSubtext.textContent = '✓ Completado con éxito';
					
					// Hint the app to focus this sale on return
					try { localStorage.setItem('pendingFocus', JSON.stringify({ saleId })); } catch {}
					
					// Wait a bit to show success, then navigate back
					await new Promise(resolve => setTimeout(resolve, 1500));
					overlay.classList.remove('show');
					await new Promise(resolve => setTimeout(resolve, 300));
					
					// Navigate back to sales table
					window.history.back();
				} else if (successCount > 0 && errorCount > 0) {
					spinner.style.display = 'none';
					successIcon.style.display = 'flex';
					const fileWord = successCount === 1 ? 'archivo' : 'archivos';
					const uploadedWord = successCount === 1 ? 'subido' : 'subidos';
					loadingText.textContent = `${successCount} ${fileWord} ${uploadedWord}`;
					loadingSubtext.textContent = `⚠️ ${errorCount} con error`;
					
					try { localStorage.setItem('pendingFocus', JSON.stringify({ saleId })); } catch {}
					
					await new Promise(resolve => setTimeout(resolve, 2000));
					overlay.classList.remove('show');
					await new Promise(resolve => setTimeout(resolve, 300));
					window.history.back();
				} else {
					// All failed
					spinner.style.display = 'none';
					loadingText.textContent = '✗ Error al subir';
					loadingSubtext.textContent = 'Intenta de nuevo';
					
					await new Promise(resolve => setTimeout(resolve, 2000));
					overlay.classList.remove('show');
					uploadBtn.disabled = false;
					uploadBtn.textContent = `Subir ${selectedFiles.length} archivo${selectedFiles.length > 1 ? 's' : ''}`;
				}
			} catch (e) {
				console.error(e);
				spinner.style.display = 'none';
				loadingText.textContent = '✗ Error al subir';
				loadingSubtext.textContent = 'Intenta de nuevo';
				
				await new Promise(resolve => setTimeout(resolve, 2000));
				overlay.classList.remove('show');
				uploadBtn.disabled = false;
				uploadBtn.textContent = `Subir ${selectedFiles.length} archivo${selectedFiles.length > 1 ? 's' : ''}`;
			}
		});
	})();
	</script>
</body>
</html>


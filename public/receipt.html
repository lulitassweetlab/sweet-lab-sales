<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Subir comprobante</title>
	<style>
		body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; padding: 20px; background: var(--background, #fff); color: var(--foreground, #111); }
		.card { max-width: 560px; margin: 0 auto; background: var(--card, #fff); border: 1px solid var(--border, #e5e7eb); border-radius: 12px; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.06); }
		h1 { font-size: 18px; margin: 0 0 8px; font-weight: 500; }
		label { display: block; margin: 12px 0 6px; font-size: 14px; }
		input[type="file"] { display: block; width: 100%; }
		.preview { margin-top: 12px; display: none; }
		.preview img { max-width: 100%; border-radius: 8px; border: 1px solid var(--border, #e5e7eb); }
		.actions { margin-top: 14px; display: flex; gap: 8px; justify-content: flex-end; }
		.btn { border: 1px solid var(--border, #e5e7eb); background: var(--card, #fff); color: inherit; border-radius: 10px; padding: 8px 12px; cursor: pointer; }
		.btn-primary { background: var(--primary, #f4a6b7); color: #fff; border-color: transparent; }
		.btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
		.note { font-size: 12px; color: #6b7280; margin-top: 8px; }
	</style>
</head>
<body>
	<div class="card">
		<h1>Subir comprobante de transferencia</h1>
		<div id="sale-info" class="note"></div>
        <label for="file">Foto(s) del comprobante</label>
        <input id="file" type="file" accept="image/*" multiple />
		<label for="note">Nota (opcional)</label>
		<textarea id="note" rows="3" placeholder="Escribe una nota..." style="width:100%; resize: vertical;"></textarea>
        <div class="preview" id="preview">
            <div id="preview-info" class="note" style="margin-bottom:6px;"></div>
            <img id="img" alt="Vista previa" />
        </div>
		<div class="actions">
			<button class="btn" id="back">Cancelar</button>
			<button class="btn btn-primary" id="upload" disabled>Subir</button>
		</div>
        <div class="note">Formatos comunes: JPG, PNG. Tamaño máximo recomendado 2MB por archivo.</div>
	</div>

	<script>
	(function(){
		const qs = new URLSearchParams(location.search);
		const saleId = Number(qs.get('sale_id'));
		document.getElementById('sale-info').textContent = saleId ? ('Venta #' + saleId) : '';
		// Resolve actor name from saved auth user
		let actorName = '';
		try { const saved = localStorage.getItem('authUser'); if (saved) { const u = JSON.parse(saved); actorName = (u && (u.name || u.username)) ? (u.name || u.username) : ''; } } catch {}
		const fileInput = document.getElementById('file');
        const preview = document.getElementById('preview');
        const previewInfo = document.getElementById('preview-info');
        const img = document.getElementById('img');
		const uploadBtn = document.getElementById('upload');
		document.getElementById('back').addEventListener('click', () => history.length > 1 ? history.back() : (location.href = '/'));
        fileInput.addEventListener('change', () => {
            const files = fileInput.files;
            if (!files || files.length === 0) { preview.style.display = 'none'; img.src = ''; uploadBtn.disabled = true; return; }
            // Preview the first image and show count
            const first = files[0];
            const reader = new FileReader();
            reader.onload = () => {
                img.src = reader.result;
                previewInfo.textContent = files.length > 1 ? `${files.length} archivos seleccionados (se mostrará vista previa del primero)` : '1 archivo seleccionado';
                preview.style.display = 'block';
                uploadBtn.disabled = false;
            };
            reader.readAsDataURL(first);
        });
        uploadBtn.addEventListener('click', async () => {
            const files = fileInput.files;
            if (!files || files.length === 0 || !saleId) return;
            uploadBtn.disabled = true;
            try {
                // Helper to read a File as data URL
                const readAsDataURL = (file) => new Promise((resolve, reject) => {
                    const r = new FileReader();
                    r.onload = () => resolve(r.result);
                    r.onerror = reject;
                    r.readAsDataURL(file);
                });
                const note = (document.getElementById('note').value || '').toString();
                for (const f of files) {
                    const base64 = await readAsDataURL(f);
                    const res = await fetch('/api/sales', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ _upload_receipt_for: saleId, image_base64: base64, note_text: note, _actor_name: actorName })
                    });
                    if (!res.ok) {
                        alert('Error al subir uno de los comprobantes');
                        uploadBtn.disabled = false;
                        return;
                    }
                }
                alert('Comprobante(s) subido(s)');
                try { localStorage.setItem('pendingFocus', JSON.stringify({ saleId })); } catch {}
                location.href = '/';
            } catch (e) {
                console.error(e);
                alert('Error al subir comprobante');
                uploadBtn.disabled = false;
            }
        });
	})();
	</script>
</body>
</html>


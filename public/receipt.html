<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Subir comprobante</title>
	<style>
		body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; padding: 20px; background: var(--background, #fff); color: var(--foreground, #111); }
		.card { max-width: 560px; margin: 0 auto; background: var(--card, #fff); border: 1px solid var(--border, #e5e7eb); border-radius: 12px; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.06); }
		h1 { font-size: 18px; margin: 0 0 8px; font-weight: 500; }
		label { display: block; margin: 12px 0 6px; font-size: 14px; }
		input[type="file"] { display: block; width: 100%; }
		.preview { margin-top: 12px; display: none; }
		.preview img { max-width: 100%; border-radius: 8px; border: 1px solid var(--border, #e5e7eb); }
		.actions { margin-top: 14px; display: flex; gap: 8px; justify-content: flex-end; }
		.btn { border: 1px solid var(--border, #e5e7eb); background: var(--card, #fff); color: inherit; border-radius: 10px; padding: 8px 12px; cursor: pointer; }
		.btn-primary { background: var(--primary, #f4a6b7); color: #fff; border-color: transparent; }
		.btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
		.note { font-size: 12px; color: #6b7280; margin-top: 8px; }
	</style>
</head>
<body>
	<div class="card">
		<h1>Subir comprobante de transferencia</h1>
		<div id="sale-info" class="note"></div>
		<label for="file">Foto del comprobante</label>
		<input id="file" type="file" accept="image/*" />
		<label for="note">Nota (opcional)</label>
		<textarea id="note" rows="3" placeholder="Escribe una nota..." style="width:100%; resize: vertical;"></textarea>
		<div class="preview" id="preview">
			<img id="img" alt="Vista previa" />
		</div>
		<div class="actions">
			<button class="btn" id="back">Cancelar</button>
			<button class="btn btn-primary" id="upload" disabled>Subir</button>
		</div>
		<div class="note">Formatos comunes: JPG, PNG. Tamaño máximo recomendado 2MB.</div>
	</div>

	<script>
	(function(){
		const qs = new URLSearchParams(location.search);
		const saleId = Number(qs.get('sale_id'));
		document.getElementById('sale-info').textContent = saleId ? ('Venta #' + saleId) : '';
		const fileInput = document.getElementById('file');
		const preview = document.getElementById('preview');
		const img = document.getElementById('img');
		const uploadBtn = document.getElementById('upload');
		document.getElementById('back').addEventListener('click', () => history.length > 1 ? history.back() : (location.href = '/'));
		fileInput.addEventListener('change', () => {
			const f = fileInput.files && fileInput.files[0];
			if (!f) { preview.style.display = 'none'; img.src = ''; uploadBtn.disabled = true; return; }
			const reader = new FileReader();
			reader.onload = () => { img.src = reader.result; preview.style.display = 'block'; uploadBtn.disabled = false; };
			reader.readAsDataURL(f);
		});
		uploadBtn.addEventListener('click', async () => {
			const f = fileInput.files && fileInput.files[0];
			if (!f || !saleId) return;
			uploadBtn.disabled = true;
			try {
				const reader = new FileReader();
				reader.onload = async () => {
					const base64 = reader.result;
					const note = (document.getElementById('note').value || '').toString();
					const res = await fetch('/api/sales', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ _upload_receipt_for: saleId, image_base64: base64, note_text: note }) });
					if (!res.ok) { alert('Error al subir comprobante'); uploadBtn.disabled = false; return; }
					alert('Comprobante subido');
					history.length > 1 ? history.back() : (location.href = '/');
				};
				reader.readAsDataURL(f);
			} catch (e) {
				console.error(e);
				alert('Error al subir comprobante');
				uploadBtn.disabled = false;
			}
		});
	})();
	</script>
</body>
</html>


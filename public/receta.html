<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Receta por pasos</title>
	<link rel="stylesheet" href="/styles.css?v=2025-09-17-1" />
	<style>
		/* Loading overlay */
		.loading-overlay {
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: rgba(244, 166, 183, 0.98);
			z-index: 99999;
			display: flex !important;
			align-items: center;
			justify-content: center;
			backdrop-filter: blur(5px);
			opacity: 0;
			pointer-events: none;
			transition: opacity 0.2s ease;
		}
		.loading-overlay.active { 
			opacity: 1 !important;
			pointer-events: auto;
		}
		.loading-content {
			text-align: center;
			max-width: 400px;
			padding: 32px;
			background: white;
			border-radius: 16px;
			box-shadow: 0 8px 32px rgba(0,0,0,0.1);
			transform: translateY(0);
			transition: transform 0.2s ease;
		}
		.loading-overlay:not(.active) .loading-content {
			transform: translateY(-20px);
		}
		.loading-spinner {
			width: 60px;
			height: 60px;
			margin: 0 auto 24px;
			border: 4px solid #f0f0f0;
			border-top-color: var(--primary);
			border-radius: 50%;
			animation: spin 0.8s linear infinite;
		}
		@keyframes spin {
			to { transform: rotate(360deg); }
		}
		.progress-bar-container {
			width: 100%;
			height: 8px;
			background: #f0f0f0;
			border-radius: 4px;
			overflow: hidden;
			margin: 16px 0;
		}
		.progress-bar {
			height: 100%;
			background: linear-gradient(90deg, var(--primary), var(--hover-primary-pink));
			border-radius: 4px;
			transition: width 0.3s ease;
			animation: progress-pulse 1.5s ease-in-out infinite;
		}
		@keyframes progress-pulse {
			0%, 100% { opacity: 1; }
			50% { opacity: 0.7; }
		}
		.loading-text {
			font-size: 16px;
			color: var(--text);
			margin: 8px 0;
			font-weight: 500;
		}
		.loading-subtext {
			font-size: 13px;
			color: var(--muted);
		}
		
		/* Recipe ingredient table styles */
		.measure-section table td {
			vertical-align: middle;
		}
		
		.measure-section table td > div {
			display: flex;
			align-items: center;
			gap: 8px;
			justify-content: flex-end;
		}
		
		/* Inventory button states */
		button[data-used="true"] {
			cursor: not-allowed;
		}
		
		button[data-used="true"]:hover {
			opacity: 0.9;
		}
		
		/* Quantity display hover effect */
		.measure-section table span[title="Click para editar"]:hover {
			background: rgba(244, 166, 183, 0.1);
		}
		
		/* Modified quantity indicator */
		.measure-section table span.modified {
			background: rgba(255, 193, 7, 0.1);
			border: 1px solid rgba(255, 193, 7, 0.3);
		}
	</style>
</head>
<body>
	<!-- Loading overlay -->
	<div id="loading-overlay" class="loading-overlay">
		<div class="loading-content">
			<div class="loading-spinner"></div>
			<div class="loading-text" id="loading-text">Cargando recetas...</div>
			<div class="progress-bar-container">
				<div class="progress-bar" id="progress-bar" style="width: 0%"></div>
			</div>
			<div class="loading-subtext" id="loading-subtext">Esto tomar√° solo un momento</div>
		</div>
	</div>
	<header class="app-header">
		<div class="header-row">
			<div class="header-left">
				<img src="/logo.png" alt="Lulitas Logo" class="app-logo" />
				<h1>Receta por pasos</h1>
			</div>
			<div class="header-actions">
				<button id="back-btn" class="press-btn">Volver</button>
			</div>
		</div>
	</header>

	<main class="sales-panel">
		<div class="panel-header">
			<h3 id="title">Recetas con cantidades vendidas</h3>
			<div class="panel-actions">
					<button id="change-range" class="press-btn">Cambiar fechas</button>
			</div>
		</div>
		<div class="panel-body">
			<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
				<strong id="range-label"></strong>
				<small id="count-label" style="opacity:.8"></small>
			</div>
			<div id="counts-summary" style="display:flex; gap:10px; flex-wrap:wrap; margin:6px 0 12px 0"></div>
			<div id="cards-wrap" style="display:flex; flex-direction:column; gap:22px; margin-top:8px"></div>
		</div>
	</main>

	<script type="module">
	(function(){
		const qs = new URLSearchParams(location.search);
		let start = (qs.get('start') || '').slice(0,10);
		let end = (qs.get('end') || '').slice(0,10);
		let actor = (qs.get('actor') || '').toString();
		if (!actor) { try { const saved = JSON.parse(localStorage.getItem('authUser')||'null'); actor = (saved?.name||saved?.username||'').toString(); } catch {} }
		const rangeLabel = document.getElementById('range-label');
		const countLabel = document.getElementById('count-label');
		const countsSummary = document.getElementById('counts-summary');
		const cardsWrap = document.getElementById('cards-wrap');
		const backBtn = document.getElementById('back-btn');
		const changeBtn = document.getElementById('change-range');
 		const sessions = [];
		let desserts = [];

		// Lightweight embed of openRangeCalendarPopover if not present
		if (typeof window.openRangeCalendarPopover !== 'function') {
			window.openRangeCalendarPopover = function(onPickedRange, anchorX, anchorY){
				const pop = document.createElement('div'); pop.className = 'date-popover'; pop.style.position = 'fixed'; const baseX = anchorX||window.innerWidth/2; const baseY = anchorY||window.innerHeight/2; pop.style.left = baseX+'px'; pop.style.top=(baseY+8)+'px'; pop.style.transform='translate(-50%,0)'; pop.style.zIndex='1000';
				const months = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre']; let view = new Date(); view.setDate(1); let startIso=null, endIso=null;
				const header=document.createElement('div'); header.className='date-popover-header'; const prev=document.createElement('button'); prev.className='date-nav'; prev.textContent='‚Äπ'; const label=document.createElement('div'); label.className='date-label'; const next=document.createElement('button'); next.className='date-nav'; next.textContent='‚Ä∫'; header.append(prev,label,next);
				const grid=document.createElement('div'); grid.className='date-grid'; const weekdays=['L','M','X','J','V','S','D']; const wk=document.createElement('div'); wk.className='date-weekdays'; for (const w of weekdays){ const c=document.createElement('div'); c.textContent=w; wk.appendChild(c);} 
				function isoUTC(y,m,d){ return new Date(Date.UTC(y,m,d)).toISOString().slice(0,10); }
				function isBetween(x,a,b){ return x>=a && x<=b; }
				function render(){ label.textContent = months[view.getMonth()] + ' ' + view.getFullYear(); grid.innerHTML=''; const year=view.getFullYear(); const month=view.getMonth(); const firstDay=(new Date(Date.UTC(year,month,1)).getUTCDay()+6)%7; const daysInMonth=new Date(Date.UTC(year,month+1,0)).getUTCDate(); for (let i=0;i<firstDay;i++){ const cell=document.createElement('button'); cell.className='date-cell disabled'; cell.disabled=true; grid.appendChild(cell);} for (let d=1; d<=daysInMonth; d++){ const iso=isoUTC(year,month,d); const cell=document.createElement('button'); let cls='date-cell'; if (startIso && !endIso && iso===startIso) cls+=' range-start selected'; if (startIso && endIso){ if (iso===startIso) cls+=' range-start selected'; else if (iso===endIso) cls+=' range-end selected'; else if (isBetween(iso,startIso,endIso)) cls+=' in-range'; } cell.className=cls; cell.textContent=String(d); cell.addEventListener('click',()=>{ if(!startIso){ startIso=iso; endIso=null; render(); return; } if(!endIso){ if(iso<startIso){ endIso=startIso; startIso=iso; } else { endIso=iso; } render(); return; } startIso=iso; endIso=null; render(); }); grid.appendChild(cell);} }
				function cleanup(){ document.removeEventListener('mousedown', outside, true); document.removeEventListener('touchstart', outside, true); if(pop.parentNode) pop.parentNode.removeChild(pop);} function outside(ev){ if(!pop.contains(ev.target)) cleanup(); }
				prev.addEventListener('click',()=>{ view.setMonth(view.getMonth()-1); render(); }); next.addEventListener('click',()=>{ view.setMonth(view.getMonth()+1); render(); });
				const actions=document.createElement('div'); actions.style.display='flex'; actions.style.justifyContent='space-between'; actions.style.marginTop='8px'; const clearBtn=document.createElement('button'); clearBtn.className='date-nav'; clearBtn.textContent='Limpiar'; const genBtn=document.createElement('button'); genBtn.className='date-nav'; genBtn.textContent='Generar'; genBtn.disabled=true; clearBtn.addEventListener('click',()=>{ startIso=null; endIso=null; genBtn.disabled=true; render(); }); genBtn.addEventListener('click',()=>{ if(startIso && endIso && typeof onPickedRange==='function'){ cleanup(); onPickedRange({ start:startIso, end:endIso }); } }); actions.append(clearBtn, genBtn);
				const origRender = render; render = function(){ origRender(); genBtn.disabled = !(startIso && endIso); };
				pop.append(header, wk, grid, actions); document.body.appendChild(pop); pop.classList.add('aladdin-pop');
				document.addEventListener('mousedown', outside, true); document.addEventListener('touchstart', outside, true); render();
			};
		}

		function formatDay(iso){ if (!iso) return ''; const d = new Date(iso + 'T00:00:00Z'); const months=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre']; return `${d.getUTCDate()} ${months[d.getUTCMonth()]} ${d.getFullYear()}`; }
		async function fetchJSON(u){ const r = await fetch(u); if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); }
		function withActor(url){
			try {
				const u = new URL(url, location.origin);
				if (actor) u.searchParams.set('actor', actor);
				return u.pathname + (u.search || '');
			} catch { return url + (url.includes('?') ? `&actor=${encodeURIComponent(actor)}` : `?actor=${encodeURIComponent(actor)}`); }
		}

		// Store original and edited counts
		let originalCounts = {};
		let editedCounts = {};
		
		function sumCountsView(c, onCountChange){
			countsSummary.innerHTML = '';
			const pills = [];
			
			// Add pill for each dessert dynamically
			let total = 0;
			let editedTotal = 0;
			for (const d of desserts) {
				const originalV = c[d.short_code] || 0;
				const editedV = editedCounts[d.short_code] !== undefined ? editedCounts[d.short_code] : originalV;
				pills.push({ label: d.name, code: d.short_code, original: originalV, edited: editedV });
				total += originalV;
				editedTotal += editedV;
			}
			pills.push({ label: 'Total', code: null, original: total, edited: editedTotal });
			
			for (const p of pills){ 
				const el = document.createElement('div'); 
				el.style.background = 'var(--card)'; 
				el.style.border = '1px solid var(--border)'; 
				el.style.borderRadius = '999px'; 
				el.style.padding = '4px 10px';
				el.style.display = 'flex';
				el.style.alignItems = 'center';
				el.style.gap = '6px';
				
				const labelSpan = document.createElement('span');
				labelSpan.textContent = p.label + ':';
				labelSpan.style.fontWeight = '500';
				el.appendChild(labelSpan);
				
				if (p.code) {
					// Editable input
					const input = document.createElement('input');
					input.type = 'number';
					input.min = '0';
					input.value = p.edited;
					input.style.width = '50px';
					input.style.border = '1px solid var(--border)';
					input.style.borderRadius = '4px';
					input.style.padding = '2px 6px';
					input.style.textAlign = 'center';
					input.style.fontWeight = '600';
					input.addEventListener('change', () => {
						const newValue = Math.max(0, parseInt(input.value) || 0);
						input.value = newValue;
						editedCounts[p.code] = newValue;
						if (onCountChange) onCountChange();
					});
					el.appendChild(input);
					
					// Show original if different
					if (p.edited !== p.original) {
						const originalSpan = document.createElement('span');
						originalSpan.textContent = `(orig: ${p.original})`;
						originalSpan.style.fontSize = '11px';
						originalSpan.style.opacity = '0.7';
						el.appendChild(originalSpan);
					}
				} else {
					// Total (not editable)
					const totalSpan = document.createElement('span');
					totalSpan.textContent = p.edited;
					totalSpan.style.fontWeight = '700';
					el.appendChild(totalSpan);
					
					if (p.edited !== p.original) {
						const originalSpan = document.createElement('span');
						originalSpan.textContent = `(orig: ${p.original})`;
						originalSpan.style.fontSize = '11px';
						originalSpan.style.opacity = '0.7';
						el.appendChild(originalSpan);
					}
				}
				
				countsSummary.appendChild(el); 
			}
		}
	
	// History helper functions (global scope for access from timers)
	function readHistory(){ try { return JSON.parse(localStorage.getItem('timesHistory') || '[]') || []; } catch { return []; } }
	function writeHistory(arr){ try { localStorage.setItem('timesHistory', JSON.stringify(arr)); } catch {} }
	function fmtMs(ms){ const total=Math.max(0,Math.floor(ms/1000)); const h=Math.floor(total/3600); const m=Math.floor((total%3600)/60); const s=total%60; const pad=n=>String(n).padStart(2,'0'); return (h>0?`${h}:`:'')+`${pad(m)}:${pad(s)}`; }
	
	// Show inventory update popover
	function showInventoryPopover(targetElement) {
		const popover = document.createElement('div');
		popover.className = 'inventory-popover';
		popover.textContent = '‚úÖ Inventario actualizado';
		popover.style.position = 'fixed';
		popover.style.background = 'var(--primary)';
		popover.style.color = 'white';
		popover.style.padding = '8px 16px';
		popover.style.borderRadius = '8px';
		popover.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
		popover.style.zIndex = '10000';
		popover.style.fontSize = '14px';
		popover.style.fontWeight = '500';
		popover.style.opacity = '0';
		popover.style.transition = 'opacity 0.3s ease';
		
		// Position near the button
		const rect = targetElement.getBoundingClientRect();
		popover.style.left = (rect.right + 10) + 'px';
		popover.style.top = (rect.top + (rect.height / 2) - 20) + 'px';
		
		document.body.appendChild(popover);
		
		// Animate in
		requestAnimationFrame(() => {
			popover.style.opacity = '1';
		});
		
		// Remove after 2 seconds
		setTimeout(() => {
			popover.style.opacity = '0';
			setTimeout(() => {
				if (popover.parentNode) {
					popover.parentNode.removeChild(popover);
				}
			}, 300);
		}, 2000);
	}

		// Global container for active timer buttons (right side)
		let activeTimersContainer = null;
		let timerButtonIdCounter = 0;

		function buildTimerControls(associatedRows = [], dessertName = '', stepName = '', targetElement = null, qtyPerDessert = 0){
			const stepState = { elapsedMs: 0, isRunning: false, startedAt: null };
			const wrap = document.createElement('div'); wrap.style.display='flex'; wrap.style.alignItems='center'; wrap.style.gap='8px';
			const display = document.createElement('div'); display.style.minWidth='180px'; display.style.textAlign='center'; display.style.fontVariantNumeric='tabular-nums';
			const playBtn = document.createElement('button'); playBtn.className='press-btn'; playBtn.textContent='‚ñ∂'; playBtn.title='Play';
			const pauseBtn = document.createElement('button'); pauseBtn.className='press-btn'; pauseBtn.textContent='‚è∏'; pauseBtn.title='Pause';
			const stopBtn = document.createElement('button'); stopBtn.className='press-btn'; stopBtn.textContent='‚èπ'; stopBtn.title='Stop';
			const saveBtn = document.createElement('button'); saveBtn.className='press-btn'; saveBtn.textContent='üíæ'; saveBtn.title='Guardar'; saveBtn.style.fontSize='16px';
			const histBtn = document.createElement('button'); histBtn.className='press-btn'; histBtn.textContent='üìä'; histBtn.title='Historial'; histBtn.style.fontSize='16px';
			wrap.append(display, playBtn, pauseBtn, stopBtn, saveBtn, histBtn);
			function formatMs(ms){ const total=Math.max(0,Math.floor(ms/1000)); const h=Math.floor(total/3600); const m=Math.floor((total%3600)/60); const s=total%60; const pad=n=>String(n).padStart(2,'0'); return (h>0?`${h}:`:'')+`${pad(m)}:${pad(s)}`; }
			let intervalId = null;
			let activeTimerButton = null;
			const timerId = 'timer-btn-' + (++timerButtonIdCounter);
			
			// Calculate estimated time based on history
			function getEstimatedTime() {
				const hist = readHistory();
				const filtered = hist.filter(item => 
					item.dessert === dessertName && 
					item.step_name === stepName && 
					item.avg_ms_per_unit
				);
				
				if (filtered.length === 0) return null;
				
				// Calculate average of averages
				const sumOfAverages = filtered.reduce((sum, item) => sum + item.avg_ms_per_unit, 0);
				const avgPerUnit = Math.round(sumOfAverages / filtered.length);
				
				// Multiply by quantity
				return avgPerUnit * qtyPerDessert;
			}
			
			const estimatedMs = getEstimatedTime();
			
			function compute(){ const base=Number(stepState.elapsedMs||0)||0; if (stepState.isRunning && stepState.startedAt) return base + (Date.now()-stepState.startedAt); return base; }
			function render(){ 
				const currentTime = formatMs(compute());
				if (estimatedMs) {
					const estimatedTime = formatMs(estimatedMs);
					display.innerHTML = `<span style="color:var(--text);">${currentTime}</span> <span style="color:rgba(0,0,0,0.4); font-weight:400;">/ ${estimatedTime}</span>`;
				} else {
					display.textContent = currentTime;
				}
			}
			
			function updateRowHighlight(){
				for (const row of associatedRows){
					if (stepState.isRunning) {
						row.classList.add('timer-row-active');
					} else {
						row.classList.remove('timer-row-active');
					}
				}
			}
			function createActiveTimerButton(){
				if (!activeTimersContainer || !dessertName || !stepName) return;
				
				// Remove any existing button for this timer
				removeActiveTimerButton();
				
				// Extract first word of step name
				const firstWordOfStep = stepName.split(' ')[0];
				
				const btn = document.createElement('button');
				btn.className = 'press-btn active-timer-btn';
				btn.id = timerId;
				btn.innerHTML = `<strong>${dessertName}</strong><br><small>${firstWordOfStep}</small>`;
				btn.addEventListener('click', () => {
					if (targetElement) {
						targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
						// Add a visual highlight effect
						const originalBoxShadow = targetElement.style.boxShadow;
						targetElement.style.transition = 'box-shadow 0.3s ease';
						targetElement.style.boxShadow = '0 0 20px rgba(244, 166, 183, 0.8)';
						setTimeout(() => {
							targetElement.style.boxShadow = originalBoxShadow || '';
						}, 1500);
					}
				});
				activeTimersContainer.appendChild(btn);
				activeTimerButton = btn;
			}
			function removeActiveTimerButton(){
				if (activeTimerButton && activeTimerButton.parentNode) {
					activeTimerButton.parentNode.removeChild(activeTimerButton);
				}
				activeTimerButton = null;
			}
			function play(){ 
				if (stepState.isRunning) return; 
				stepState.isRunning = true; 
				stepState.startedAt = Date.now(); 
				clearInterval(intervalId); 
				intervalId = setInterval(render, 250); 
				updateRowHighlight();
				createActiveTimerButton();
			}
			function pause(){ 
				if (!stepState.isRunning) return; 
				stepState.elapsedMs = compute(); 
				stepState.isRunning = false; 
				stepState.startedAt = null; 
				clearInterval(intervalId); 
				intervalId = null; 
				render(); 
				updateRowHighlight();
				removeActiveTimerButton();
			}
			function stop(){ 
				const currentMs = compute();
				
				// If there's time recorded, ask if user wants to save
				if (currentMs > 0 && qtyPerDessert > 0) {
					// Create popover
					const popover = document.createElement('div');
					popover.className = 'save-time-popover';
					popover.style.position = 'fixed';
					popover.style.left = '50%';
					popover.style.top = '50%';
					popover.style.transform = 'translate(-50%, -50%)';
					popover.style.background = 'white';
					popover.style.padding = '24px';
					popover.style.borderRadius = '12px';
					popover.style.boxShadow = '0 8px 32px rgba(0,0,0,0.2)';
					popover.style.zIndex = '10001';
					popover.style.minWidth = '320px';
					popover.style.textAlign = 'center';
					
					const overlay = document.createElement('div');
					overlay.style.position = 'fixed';
					overlay.style.top = '0';
					overlay.style.left = '0';
					overlay.style.right = '0';
					overlay.style.bottom = '0';
					overlay.style.background = 'rgba(0,0,0,0.4)';
					overlay.style.zIndex = '10000';
					overlay.style.backdropFilter = 'blur(2px)';
					
					const title = document.createElement('div');
					title.textContent = '¬øGuardar este tiempo?';
					title.style.fontSize = '18px';
					title.style.fontWeight = '600';
					title.style.marginBottom = '12px';
					title.style.color = 'var(--text)';
					
					const info = document.createElement('div');
					info.style.fontSize = '14px';
					info.style.marginBottom = '20px';
					info.style.color = 'var(--text)';
					info.style.opacity = '0.8';
					info.innerHTML = `
						<div style="margin-bottom:8px;">
							<strong style="color:var(--primary);">${dessertName} - ${stepName}</strong>
						</div>
						<div>‚è±Ô∏è Tiempo: <strong>${fmtMs(currentMs)}</strong></div>
						<div>üì¶ Cantidad: <strong>${qtyPerDessert}</strong></div>
					`;
					
					const actions = document.createElement('div');
					actions.style.display = 'flex';
					actions.style.gap = '12px';
					actions.style.justifyContent = 'center';
					
					const saveButton = document.createElement('button');
					saveButton.className = 'press-btn btn-primary';
					saveButton.textContent = 'üíæ Guardar';
					saveButton.style.flex = '1';
					saveButton.style.maxWidth = '140px';
					
					const discardButton = document.createElement('button');
					discardButton.className = 'press-btn';
					discardButton.textContent = 'Descartar';
					discardButton.style.flex = '1';
					discardButton.style.maxWidth = '140px';
					
					function cleanup() {
						if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
						if (popover.parentNode) popover.parentNode.removeChild(popover);
					}
					
					saveButton.addEventListener('click', async () => {
						cleanup();
						const saved = await saveTimerData();
						if (saved) {
							// Show brief success message
							const toast = document.createElement('div');
							toast.textContent = '‚úÖ Tiempo guardado';
							toast.style.position = 'fixed';
							toast.style.top = '20px';
							toast.style.left = '50%';
							toast.style.transform = 'translateX(-50%)';
							toast.style.background = 'var(--primary)';
							toast.style.color = 'white';
							toast.style.padding = '12px 24px';
							toast.style.borderRadius = '8px';
							toast.style.boxShadow = '0 4px 16px rgba(0,0,0,0.2)';
							toast.style.zIndex = '10002';
							toast.style.fontWeight = '500';
							document.body.appendChild(toast);
							setTimeout(() => {
								if (toast.parentNode) toast.parentNode.removeChild(toast);
							}, 2000);
						}
						// Execute stop
						stepState.elapsedMs = 0; 
						stepState.isRunning = false; 
						stepState.startedAt = null; 
						clearInterval(intervalId); 
						intervalId = null; 
						render(); 
						updateRowHighlight();
						removeActiveTimerButton();
					});
					
					discardButton.addEventListener('click', () => {
						cleanup();
						// Execute stop without saving
						stepState.elapsedMs = 0; 
						stepState.isRunning = false; 
						stepState.startedAt = null; 
						clearInterval(intervalId); 
						intervalId = null; 
						render(); 
						updateRowHighlight();
						removeActiveTimerButton();
					});
					
					overlay.addEventListener('click', () => {
						cleanup();
					});
					
					actions.append(saveButton, discardButton);
					popover.append(title, info, actions);
					document.body.appendChild(overlay);
					document.body.appendChild(popover);
				} else {
					// No time or no quantity, just stop
					stepState.elapsedMs = 0; 
					stepState.isRunning = false; 
					stepState.startedAt = null; 
					clearInterval(intervalId); 
					intervalId = null; 
					render(); 
					updateRowHighlight();
					removeActiveTimerButton();
				}
			}
			function writeHistory(arr){ try { localStorage.setItem('timesHistory', JSON.stringify(arr)); } catch {} }
			function fmtMs(ms){ const total=Math.max(0,Math.floor(ms/1000)); const h=Math.floor(total/3600); const m=Math.floor((total%3600)/60); const s=total%60; const pad=n=>String(n).padStart(2,'0'); return (h>0?`${h}:`:'')+`${pad(m)}:${pad(s)}`; }
			
			async function saveTimerData() {
				const ms = compute();
				if (ms <= 0) {
					return false;
				}
				
				const qty = Number(qtyPerDessert) || 0;
				if (qty <= 0) {
					return false;
				}
				
				const avg = Math.round(ms / qty);
				const steps = [{ 
					name: stepName, 
					elapsed_ms: ms, 
					qty_units: qty, 
					avg_ms_per_unit: avg 
				}];
				
				try {
					// Save to server
					await fetch('/api/times', { 
						method: 'POST', 
						headers: { 'Content-Type': 'application/json' }, 
						body: JSON.stringify({ 
							dessert: dessertName, 
							steps, 
							total_elapsed_ms: ms, 
							actor_name: null 
						}) 
					});
					
					// Save to local history
					const hist = readHistory();
					hist.push({ 
						id: new Date().toISOString(), 
						date_iso: new Date().toISOString(), 
						dessert: dessertName, 
						step_name: stepName,
						qty_units: qty, 
						total_elapsed_ms: ms,
						avg_ms_per_unit: avg,
						steps 
					});
					writeHistory(hist);
					
					return true;
				} catch (err) {
					console.error('Error al guardar:', err);
					return false;
				}
			}
			
			histBtn.addEventListener('click', () => {
				const allHistory = readHistory();
				// Filter by this specific dessert and step
				const filteredItems = allHistory.filter(item => 
					item.dessert === dessertName && item.step_name === stepName
				).reverse();
				
				// Create overlay
				const overlay = document.createElement('div');
				overlay.style.position = 'fixed';
				overlay.style.top = '0';
				overlay.style.left = '0';
				overlay.style.right = '0';
				overlay.style.bottom = '0';
				overlay.style.background = 'rgba(0,0,0,0.4)';
				overlay.style.zIndex = '9999';
				overlay.style.backdropFilter = 'blur(2px)';
				
				const pop = document.createElement('div'); 
				pop.className = 'confirm-popover'; 
				pop.style.position='fixed'; 
				pop.style.left=(window.innerWidth/2)+'px'; 
				pop.style.top='10%'; 
				pop.style.transform='translate(-50%,0)'; 
				pop.style.zIndex='10000';
				pop.style.maxWidth='90vw';
				
				const title = document.createElement('h4'); 
				title.textContent = `Historial: ${dessertName} - ${stepName}`; 
				title.style.margin='0 0 12px 0';
				title.style.textAlign='center';
				
				const list = document.createElement('div'); 
				list.style.maxHeight='65vh'; 
				list.style.overflow='auto'; 
				list.style.minWidth='min(85vw,700px)';
				
				if (!filteredItems.length) { 
					const empty=document.createElement('div'); 
					empty.textContent='Sin registros para este paso'; 
					empty.style.textAlign='center';
					empty.style.padding='20px';
					empty.style.opacity='0.7';
					list.appendChild(empty); 
				} else {
					// Calculate average of averages
					let sumOfAverages = 0;
					let countWithAverage = 0;
					
					filteredItems.forEach((it, idx) => {
						const row = document.createElement('div'); 
						row.style.borderBottom='1px solid var(--border)'; 
						row.style.padding='10px 8px';
						row.style.display='flex';
						row.style.justifyContent='space-between';
						row.style.alignItems='center';
						row.style.gap='12px';
						
						const info = document.createElement('div');
						info.style.flex='1';
						const when = new Date(it.date_iso || it.id || Date.now());
						const dateStr = when.toLocaleString('es-ES', { 
							year: 'numeric', 
							month: '2-digit', 
							day: '2-digit', 
							hour: '2-digit', 
							minute: '2-digit' 
						});
						
						info.innerHTML = `
							<div style="margin-bottom:4px;">
								<strong style="color:var(--primary);">${dateStr}</strong>
							</div>
							<div style="display:flex; gap:16px; flex-wrap:wrap; font-size:13px;">
								<span>üì¶ Cant: <strong>${it.qty_units||0}</strong></span>
								<span>‚è±Ô∏è Total: <strong>${fmtMs(it.total_elapsed_ms||0)}</strong></span>
								<span>üìä Prom/u: <strong>${fmtMs(it.avg_ms_per_unit||0)}</strong></span>
							</div>
						`;
						
						if (it.avg_ms_per_unit) {
							sumOfAverages += it.avg_ms_per_unit;
							countWithAverage++;
						}
						
						const deleteBtn = document.createElement('button');
						deleteBtn.className='press-btn';
						deleteBtn.textContent='üóëÔ∏è';
						deleteBtn.title='Eliminar';
						deleteBtn.style.fontSize='16px';
						deleteBtn.style.padding='6px 10px';
						deleteBtn.style.minWidth='unset';
						deleteBtn.addEventListener('click', () => {
							if (confirm('¬øEliminar este registro?')) {
								const hist = readHistory();
								const itemId = it.id || it.date_iso;
								const newHist = hist.filter(h => (h.id || h.date_iso) !== itemId);
								writeHistory(newHist);
								// Re-open the history popup
								if (pop.parentNode) pop.parentNode.removeChild(pop);
								histBtn.click();
							}
						});
						
						row.append(info, deleteBtn);
						list.appendChild(row);
					});
					
					// Add average of averages section
					if (countWithAverage > 0) {
						const avgOfAvg = Math.round(sumOfAverages / countWithAverage);
						const avgSection = document.createElement('div');
						avgSection.style.marginTop='16px';
						avgSection.style.padding='12px';
						avgSection.style.background='rgba(244, 166, 183, 0.15)';
						avgSection.style.borderRadius='8px';
						avgSection.style.textAlign='center';
						avgSection.style.fontWeight='600';
						avgSection.innerHTML = `
							üìà Promedio de todos los promedios: <strong style="color:var(--primary); font-size:18px;">${fmtMs(avgOfAvg)}</strong>
							<div style="font-size:12px; font-weight:400; margin-top:4px; opacity:0.8;">
								Basado en ${countWithAverage} registro${countWithAverage !== 1 ? 's' : ''}
							</div>
						`;
						list.appendChild(avgSection);
					}
				}
				
				const actions=document.createElement('div'); 
				actions.className='confirm-actions'; 
				const close=document.createElement('button'); 
				close.className='press-btn'; 
				close.textContent='Cerrar'; 
				actions.appendChild(close);
				
				function cleanup() {
					if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
					if (pop.parentNode) pop.parentNode.removeChild(pop);
				}
				
				pop.append(title, list, actions); 
				document.body.appendChild(overlay);
				document.body.appendChild(pop); 
				pop.classList.add('aladdin-pop');
				close.addEventListener('click', cleanup);
				overlay.addEventListener('click', cleanup);
			});
			
			saveBtn.addEventListener('click', async () => {
				const ms = compute();
				if (ms <= 0) {
					alert('No hay tiempo para guardar');
					return;
				}
				
				const qty = Number(qtyPerDessert) || 0;
				if (qty <= 0) {
					alert('No hay cantidad para calcular el promedio');
					return;
				}
				
				const saved = await saveTimerData();
				if (saved) {
					const avg = Math.round(ms / qty);
					alert(`‚úÖ Guardado!\n\nPostre: ${dessertName}\nPaso: ${stepName}\nCantidad: ${qty}\nTiempo total: ${fmtMs(ms)}\nPromedio por unidad: ${fmtMs(avg)}`);
				} else {
					alert('Error al guardar');
				}
			});
			
			playBtn.addEventListener('click', play); pauseBtn.addEventListener('click', pause); stopBtn.addEventListener('click', stop);
			render();
			return { element: wrap, getElapsedMs: () => compute(), reset: () => { stop(); }, addRow: (row) => { associatedRows.push(row); } };
		}

		function normalizeKey(name){ const k=(name||'').toString().trim().toLowerCase(); if (k.startsWith('arco')) return 'arco'; if (k.startsWith('melo')) return 'melo'; if (k.startsWith('mara')) return 'mara'; if (k.startsWith('oreo')) return 'oreo'; if (k.startsWith('nute')) return 'nute'; return k; }
		
		// Checkbox state management (temporary, in-memory only)
		let checkedState = {};
		function getCheckedState(){
			return checkedState;
		}
		function saveCheckedState(state){
			checkedState = state;
		}
		
		// Loading overlay management
		const loadingOverlay = document.getElementById('loading-overlay');
		const loadingText = document.getElementById('loading-text');
		const loadingSubtext = document.getElementById('loading-subtext');
		const progressBar = document.getElementById('progress-bar');
		
		function showLoading(message = 'Cargando recetas...') {
			loadingText.textContent = message;
			loadingOverlay.classList.add('active');
			progressBar.style.width = '0%';
			
			// Simulate realistic progress
			let progress = 0;
			const progressInterval = setInterval(() => {
				progress += Math.random() * 15;
				if (progress > 90) progress = 90;
				progressBar.style.width = `${progress}%`;
			}, 300);
			
			return () => {
				clearInterval(progressInterval);
				progressBar.style.width = '100%';
				setTimeout(() => {
					loadingOverlay.classList.remove('active');
				}, 300);
			};
		}
		
		function updateLoadingProgress(percent, text) {
			if (loadingOverlay.classList.contains('active')) {
				progressBar.style.width = `${percent}%`;
				if (text) loadingSubtext.textContent = text;
			}
		}
		
		async function load(){
			if (!start || !end) return;
			
			const hideLoading = showLoading('Cargando recetas...');
			
			rangeLabel.textContent = `${formatDay(start)} ‚Äî ${formatDay(end)}`;
			countLabel.textContent = 'Cargando‚Ä¶';
			cardsWrap.innerHTML = '';
			
			updateLoadingProgress(10, 'Cargando postres...');
			
			// Load desserts first
			try {
				desserts = await fetchJSON('/api/desserts');
			} catch {
				desserts = [
					{ id: 1, name: 'Arco', short_code: 'arco', sale_price: 8500 },
					{ id: 2, name: 'Melo', short_code: 'melo', sale_price: 9500 },
					{ id: 3, name: 'Mara', short_code: 'mara', sale_price: 10500 },
					{ id: 4, name: 'Oreo', short_code: 'oreo', sale_price: 10500 },
					{ id: 5, name: 'Nute', short_code: 'nute', sale_price: 13000 }
				];
			}
			
			// 1) Build counts by dessert from sales in range
			const sellers = await fetchJSON(withActor('/api/sellers'));
			countLabel.textContent = `Vendedores: ${sellers.length} ¬∑ Buscando d√≠as‚Ä¶`;
			const isoBetween = (iso, a, b) => iso >= a && iso <= b;
			async function mapLimit(items, limit, fn){ const out=[]; let idx=0; let running=0; let resolveAll; const done=new Promise(r=>resolveAll=r); function runNext(){ if(idx>=items.length && running===0) return resolveAll(); while(running<limit && idx<items.length){ const cur=items[idx++]; running++; Promise.resolve(fn(cur)).then(v=>{ out.push(v); running--; runNext(); }).catch(()=>{ running--; runNext(); }); } } runNext(); await done; return out; }
			const sellerDays = [];
			await mapLimit(sellers, 6, async (s) => {
				try {
					const days = await fetchJSON(withActor(`/api/days?seller_id=${encodeURIComponent(s.id)}`));
					for (const d of (days||[])) { const iso = String(d.day).slice(0,10); if (isoBetween(iso, start, end)) sellerDays.push({ seller: s, day: d }); }
				} catch {}
			});
			updateLoadingProgress(40, 'Buscando ventas...');
			countLabel.textContent = `D√≠as: ${sellerDays.length} ¬∑ Buscando ventas‚Ä¶`;
			
			// Initialize counts dynamically
			const counts = {};
			for (const d of desserts) {
				counts[d.short_code] = 0;
			}
			
			await mapLimit(sellerDays, 6, async ({ seller, day }) => {
				try {
					const params = new URLSearchParams({ seller_id: String(seller.id), sale_day_id: String(day.id) });
					const sales = await fetchJSON(withActor(`/api/sales?${params.toString()}`));
					for (const r of (sales || [])) {
						// Support both formats
						if (Array.isArray(r.items) && r.items.length > 0) {
							// New format
							for (const item of r.items) {
								const d = desserts.find(d => d.id === item.dessert_id || d.short_code === item.short_code);
								if (d) {
									counts[d.short_code] += Number(item.quantity || 0) || 0;
								}
							}
						} else {
							// Old format
							for (const d of desserts) {
								counts[d.short_code] += Number(r[`qty_${d.short_code}`] || 0) || 0;
							}
						}
					}
				} catch {}
			});
			
			// Store original counts
			originalCounts = { ...counts };
			editedCounts = {};
			
			const onCountChange = async () => {
				// Re-render all desserts when counts change
				const newRenderedDesserts = await renderAllDesserts();
				
				// Update total count label
				let totalDesserts = 0;
				for (const d of desserts) {
					const qty = editedCounts[d.short_code] !== undefined ? editedCounts[d.short_code] : (counts[d.short_code] || 0);
					totalDesserts += qty;
				}
				countLabel.textContent = `Postres: ${totalDesserts}`;
				
				// Re-setup navigation
				setupNavigation(newRenderedDesserts);
				
				// Re-render the counts view to update totals
				sumCountsView(counts, onCountChange);
			};
			
			updateLoadingProgress(60, 'Calculando recetas...');
			sumCountsView(counts, onCountChange);

			// 2) Fetch dessert names and map them to keys
			let dessertNames = [];
			try { dessertNames = await fetchJSON(withActor('/api/recipes')); } catch { dessertNames = []; }
			const byKey = new Map();
			for (const name of (dessertNames||[])) { const k = normalizeKey(name); if (!byKey.has(k)) byKey.set(k, name); }

			// 3) Render a card per dessert with count > 0
			const fmt1 = new Intl.NumberFormat('es-CO', { minimumFractionDigits: 1, maximumFractionDigits: 1 });
			
			async function renderDessert(keyLabel, label, qty, byKeyMap, formatter){
				if (!qty) return;
				const dessertName = byKeyMap.get(keyLabel) || label;
			let data = null; try { data = await fetchJSON(withActor(`/api/recipes?dessert=${encodeURIComponent(dessertName)}&include_extras=1`)); } catch { data = null; }
				if (!data) return;
				const card = document.createElement('div'); card.className = 'measure-card'; card.style.padding='12px'; card.style.border='1px solid rgba(0,0,0,0.15)'; card.style.borderRadius='10px'; card.style.boxShadow='0 8px 24px rgba(0,0,0,0.12)';
				const title = document.createElement('h3'); title.textContent = `${dessertName} √ó ${qty}`; title.style.textAlign='center'; title.style.fontSize='28px'; title.style.margin='4px 0 12px 0'; title.style.background='rgba(255, 105, 180, 0.18)'; title.style.padding='8px 6px'; title.style.borderRadius='8px'; card.appendChild(title);
			const session = { dessert: dessertName, qty, steps: [] };
			const checkedState = getCheckedState();
			for (const step of (Array.isArray(data.steps) ? data.steps : [])){
				const section = document.createElement('div'); section.className='measure-section'; section.style.margin='12px 0';
				const head = document.createElement('div'); head.style.display='flex'; head.style.alignItems='center'; head.style.justifyContent='space-between'; head.style.gap='8px';
				const sh = document.createElement('div'); sh.textContent = step.step_name || 'Paso'; sh.style.fontWeight='600'; sh.style.margin='0 0 6px 0'; sh.style.flex='1';
				const timer = buildTimerControls([], dessertName, step.step_name || 'Paso', section, qty); head.append(sh, timer.element);
				section.appendChild(head);
				const table = document.createElement('table'); table.style.width='100%'; table.style.tableLayout='fixed';
				const tbody = document.createElement('tbody');
				const stepRows = [];
                    for (const it of (step.items || [])){
					const tr = document.createElement('tr');
					
					const tdN = document.createElement('td'); tdN.textContent = it.ingredient; tdN.style.padding='8px 4px'; tdN.style.textAlign='left';
                        const per = Number(it.qty_per_unit || 0) || 0;
                        const adj = Number(it.adjustment || 0) || 0;
                        const total = (per * qty) + adj;
                        
                        // Quantity cell with click-to-edit functionality
                        const tdQ = document.createElement('td'); 
                        tdQ.style.textAlign='right'; 
                        tdQ.style.padding='5px 4px';
                        
                        // Container div for flex layout
                        const qtyContainer = document.createElement('div');
                        qtyContainer.style.display='flex';
                        qtyContainer.style.alignItems='center';
                        qtyContainer.style.gap='8px';
                        qtyContainer.style.justifyContent='flex-end';
                        
                        // Quantity display (clickable to edit)
                        const qtyDisplay = document.createElement('span');
                        qtyDisplay.textContent = formatter.format(total);
                        qtyDisplay.style.cursor = 'pointer';
                        qtyDisplay.style.padding = '4px 8px';
                        qtyDisplay.style.borderRadius = '4px';
                        qtyDisplay.style.minWidth = '60px';
                        qtyDisplay.style.display = 'inline-block';
                        qtyDisplay.style.textAlign = 'right';
                        qtyDisplay.title = 'Click para editar';
                        
                        // Hidden input for editing
                        const qtyInput = document.createElement('input');
                        qtyInput.type = 'number';
                        qtyInput.step = '0.1';
                        qtyInput.min = '0';
                        qtyInput.value = formatter.format(total);
                        qtyInput.className = 'input-cell';
                        qtyInput.style.width = '80px';
                        qtyInput.style.textAlign = 'right';
                        qtyInput.style.display = 'none';
                        qtyInput.dataset.original = formatter.format(total);
                        qtyInput.dataset.currentQty = formatter.format(total);
                        
                        // Show original if different
                        const originalSpan = document.createElement('span');
                        originalSpan.style.fontSize = '11px';
                        originalSpan.style.opacity = '0.6';
                        originalSpan.style.display = 'none';
                        originalSpan.style.whiteSpace = 'nowrap';
                        originalSpan.textContent = `(orig: ${formatter.format(total)})`;
                        
                        // Click to edit
                        qtyDisplay.addEventListener('click', () => {
                            qtyDisplay.style.display = 'none';
                            qtyInput.style.display = 'inline-block';
                            qtyInput.focus();
                            qtyInput.select();
                        });
                        
                        // Blur to save
                        qtyInput.addEventListener('blur', () => {
                            const newValue = parseFloat(qtyInput.value) || 0;
                            qtyInput.dataset.currentQty = newValue;
                            qtyDisplay.textContent = formatter.format(newValue);
                            qtyInput.style.display = 'none';
                            qtyDisplay.style.display = 'inline-block';
                            
                            // Show/hide original
                            const orig = parseFloat(qtyInput.dataset.original) || 0;
                            if (Math.abs(newValue - orig) > 0.01) {
                                originalSpan.style.display = 'inline';
                                qtyDisplay.style.background = 'rgba(255, 193, 7, 0.1)';
                            } else {
                                originalSpan.style.display = 'none';
                                qtyDisplay.style.background = 'transparent';
                            }
                        });
                        
                        // Enter to save
                        qtyInput.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter') {
                                qtyInput.blur();
                            }
                        });
                        
                        // Inventory discount button with "i" icon
                        const discountBtn = document.createElement('button');
                        discountBtn.className = 'press-btn';
                        discountBtn.textContent = 'i';
                        discountBtn.title = 'Descontar del inventario';
                        discountBtn.style.padding = '4px 10px';
                        discountBtn.style.fontSize = '14px';
                        discountBtn.style.fontWeight = 'bold';
                        discountBtn.style.fontStyle = 'italic';
                        discountBtn.style.minWidth = '32px';
                        discountBtn.style.borderRadius = '50%';
                        discountBtn.style.width = '32px';
                        discountBtn.style.height = '32px';
                        discountBtn.dataset.used = 'false';
                        
                        discountBtn.addEventListener('click', async () => {
                            if (discountBtn.dataset.used === 'true') return;
                            
                            const qtyToDiscount = parseFloat(qtyInput.dataset.currentQty) || 0;
                            if (qtyToDiscount <= 0) {
                                alert('La cantidad debe ser mayor a 0');
                                return;
                            }
                            
                            discountBtn.disabled = true;
                            discountBtn.textContent = '‚è≥';
                            discountBtn.style.fontStyle = 'normal';
                            
                            try {
                                const response = await fetch('/api/inventory', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        action: 'ajuste',
                                        ingredient: it.ingredient,
                                        qty: -qtyToDiscount,
                                        note: `Producci√≥n: ${dessertName}`,
                                        actor_name: actor || null
                                    })
                                });
                                
                                if (!response.ok) throw new Error('Error al actualizar inventario');
                                
                                // Mark as used
                                discountBtn.dataset.used = 'true';
                                discountBtn.style.background = 'var(--primary)';
                                discountBtn.style.color = 'white';
                                discountBtn.textContent = '‚úì';
                                discountBtn.title = 'Ya descontado';
                                
                                // Add row checked style
                                tr.classList.add('row-checked');
                                
                                // Show success popover
                                showInventoryPopover(discountBtn);
                                
                            } catch (error) {
                                console.error('Error:', error);
                                discountBtn.disabled = false;
                                discountBtn.textContent = 'i';
                                discountBtn.style.fontStyle = 'italic';
                                alert('Error al actualizar el inventario');
                            }
                        });
                        
                        qtyContainer.append(qtyDisplay, qtyInput, originalSpan, discountBtn);
                        tdQ.appendChild(qtyContainer);
					tr.append(tdN, tdQ);
					stepRows.push(tr);
					tbody.appendChild(tr);
				}
				// Associate header and rows with timer
				timer.addRow(head);
				for (const row of stepRows) {
					timer.addRow(row);
				}
				table.appendChild(tbody); section.appendChild(table); card.appendChild(section);
				session.steps.push({ name: step.step_name || 'Paso', timer });
				}
				// Extras - Hidden in this view (still needed for other functionality)
				// Uncomment below if you want to show extras again
				/*
				const extras = Array.isArray(data.extras) ? data.extras : [];
				if (extras.length){
					const section = document.createElement('div'); section.className='measure-section'; section.style.margin='12px 0';
					const sh = document.createElement('div'); sh.textContent = 'Extras'; sh.style.fontWeight='600'; sh.style.margin='0 0 6px 0'; section.appendChild(sh);
					const table = document.createElement('table'); table.style.width='100%'; table.style.tableLayout='fixed';
					const tbody = document.createElement('tbody');
					for (const ex of extras){
						const tr = document.createElement('tr');
						const itemKey = `${dessertName}:extras:${ex.ingredient}`.toLowerCase();
						const isChecked = !!checkedState[itemKey];
						if (isChecked) tr.classList.add('row-checked');
						
						// Checkbox column
						const tdCheck = document.createElement('td'); tdCheck.style.width='30px';
						const checkbox = document.createElement('input');
						checkbox.type = 'checkbox';
						checkbox.className = 'ingredient-checkbox';
						checkbox.checked = isChecked;
						checkbox.addEventListener('change', () => {
							const state = getCheckedState();
							if (checkbox.checked) {
								state[itemKey] = true;
								tr.classList.add('row-checked');
							} else {
								delete state[itemKey];
								tr.classList.remove('row-checked');
							}
							saveCheckedState(state);
						});
						tdCheck.appendChild(checkbox);
						
						const tdN = document.createElement('td'); tdN.textContent = ex.ingredient; tdN.style.padding='8px 4px'; tdN.style.textAlign='center';
						const tdQ = document.createElement('td'); tdQ.textContent = fmt1.format((Number(ex.qty_per_unit || 0) || 0) * qty); tdQ.style.textAlign='right'; tdQ.style.padding='5px 4px';
						tr.append(tdCheck, tdN, tdQ); tbody.appendChild(tr);
					}
					table.appendChild(tbody); section.appendChild(table); card.appendChild(section);
				}
				*/
				// Add ID to card for navigation
				card.id = `dessert-${keyLabel}`;
				cardsWrap.appendChild(card);
				sessions.push(session);
			}
			
			async function renderAllDesserts() {
				cardsWrap.innerHTML = '';
				sessions.length = 0;
				const renderedDesserts = [];
				
				for (const d of desserts) {
					const qty = editedCounts[d.short_code] !== undefined ? editedCounts[d.short_code] : (counts[d.short_code] || 0);
					if (qty > 0) {
						renderedDesserts.push(d);
						await renderDessert(d.short_code, d.name, qty, byKey, fmt1);
					}
				}
				
				return renderedDesserts;
			}

			// Global navigation container references
			let navContainer = null;
			let activeTimersContainerRef = null;
			
			function setupNavigation(renderedDesserts) {
				// Remove old navigation if exists
				if (navContainer && navContainer.parentNode) {
					navContainer.parentNode.removeChild(navContainer);
				}
				if (activeTimersContainerRef && activeTimersContainerRef.parentNode) {
					activeTimersContainerRef.parentNode.removeChild(activeTimersContainerRef);
				}
				
				if (renderedDesserts.length === 0) return;
				
				// Create floating navigation buttons
				navContainer = document.createElement('div');
				navContainer.className = 'dessert-nav-floating';
				navContainer.style.position = 'fixed';
				navContainer.style.left = '16px';
				navContainer.style.top = '50%';
				navContainer.style.transform = 'translateY(-50%)';
				navContainer.style.display = 'flex';
				navContainer.style.flexDirection = 'column';
				navContainer.style.gap = '8px';
				navContainer.style.zIndex = '100';
				
				const navButtons = [];
				const navButtonMap = new Map(); // Map dessert code to button
				
				for (const d of renderedDesserts) {
					const btn = document.createElement('button');
					btn.className = 'press-btn dessert-nav-btn';
					btn.textContent = d.name;
					btn.dataset.dessertCode = d.short_code;
					btn.style.minWidth = '80px';
					btn.style.fontSize = '13px';
					btn.style.padding = '8px 12px';
					btn.addEventListener('click', () => {
						// Remove active class from all buttons
						for (const navBtn of navButtons) {
							navBtn.classList.remove('active');
						}
						// Add active class to clicked button
						btn.classList.add('active');
						
						const card = document.getElementById(`dessert-${d.short_code}`);
						if (card) {
							card.scrollIntoView({ behavior: 'smooth', block: 'start' });
							// Add a visual highlight effect
							card.style.transition = 'box-shadow 0.3s ease';
							card.style.boxShadow = '0 8px 32px rgba(244, 166, 183, 0.6)';
							setTimeout(() => {
								card.style.boxShadow = '0 8px 24px rgba(0,0,0,0.12)';
							}, 1000);
						}
					});
					navButtons.push(btn);
					navButtonMap.set(d.short_code, btn);
					navContainer.appendChild(btn);
				}
				
				// Set first button as active by default
				if (navButtons.length > 0) {
					navButtons[0].classList.add('active');
				}
				
				document.body.appendChild(navContainer);
				
				// Create floating container for active timers (right side)
				activeTimersContainer = document.createElement('div');
				activeTimersContainerRef = activeTimersContainer;
				activeTimersContainer.className = 'active-timers-floating';
				activeTimersContainer.style.position = 'fixed';
				activeTimersContainer.style.right = '16px';
				activeTimersContainer.style.top = '50%';
				activeTimersContainer.style.transform = 'translateY(-50%)';
				activeTimersContainer.style.display = 'flex';
				activeTimersContainer.style.flexDirection = 'column';
				activeTimersContainer.style.gap = '8px';
				activeTimersContainer.style.zIndex = '100';
				document.body.appendChild(activeTimersContainer);
				
				// Setup Intersection Observer to auto-update active button based on scroll
				const observerOptions = {
					root: null,
					rootMargin: '-20% 0px -60% 0px', // Trigger when dessert is in upper 40% of viewport
					threshold: 0
				};
				
				const observerCallback = (entries) => {
					// Find the most visible entry
					let mostVisible = null;
					let maxRatio = 0;
					
					for (const entry of entries) {
						if (entry.isIntersecting && entry.intersectionRatio > maxRatio) {
							maxRatio = entry.intersectionRatio;
							mostVisible = entry;
						}
					}
					
					if (mostVisible) {
						const dessertId = mostVisible.target.id; // e.g., "dessert-arco"
						const dessertCode = dessertId.replace('dessert-', '');
						const activeBtn = navButtonMap.get(dessertCode);
						
						if (activeBtn && !activeBtn.classList.contains('active')) {
							// Remove active from all
							for (const navBtn of navButtons) {
								navBtn.classList.remove('active');
							}
							// Add to current
							activeBtn.classList.add('active');
						}
					}
				};
				
				const observer = new IntersectionObserver(observerCallback, observerOptions);
				
				// Observe all dessert cards
				for (const d of renderedDesserts) {
					const card = document.getElementById(`dessert-${d.short_code}`);
					if (card) {
						observer.observe(card);
					}
				}
			}
			
			// Render cards dynamically for all desserts with count > 0
			const renderedDesserts = await renderAllDesserts();
			
			let totalDesserts = 0;
			for (const d of desserts) {
				totalDesserts += counts[d.short_code] || 0;
			}
			countLabel.textContent = `Postres: ${totalDesserts}`;
			
			// Setup navigation
			updateLoadingProgress(85, 'Configurando navegaci\u00f3n...');
			setupNavigation(renderedDesserts);
			
			updateLoadingProgress(95, 'Finalizando...');
			
			// Hide loading overlay
			hideLoading();
			
			// Actions: save times & view history
			const actions = document.createElement('div'); actions.className = 'confirm-actions'; actions.style.marginTop='8px';
			const saveBtn = document.createElement('button'); saveBtn.className='press-btn btn-primary'; saveBtn.textContent='Guardar tiempos';
			const historyBtn = document.createElement('button'); historyBtn.className='press-btn'; historyBtn.textContent='Ver historial';
			actions.append(saveBtn, historyBtn); cardsWrap.parentElement.appendChild(actions);
			saveBtn.addEventListener('click', async () => {
				try {
					let saved = 0;
					const hist = readHistory();
					for (const sess of sessions) {
						const qty = Number(sess.qty || 0) || 0;
						const steps = [];
						let total = 0;
						for (const st of (sess.steps || [])) {
							const ms = Number(st.timer?.getElapsedMs?.() || 0) || 0;
							if (ms > 0) {
								const avg = qty > 0 ? Math.round(ms / qty) : 0;
								steps.push({ name: st.name || 'Paso', elapsed_ms: ms, qty_units: qty, avg_ms_per_unit: avg });
								total += ms;
							}
						}
						if (!steps.length) continue;
						// Save to server
						await fetch('/api/times', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ dessert: sess.dessert, steps, total_elapsed_ms: total, actor_name: null }) });
						// Save to local history
						hist.push({ id: new Date().toISOString(), date_iso: new Date().toISOString(), dessert: sess.dessert, qty_units: qty, total_elapsed_ms: total, steps });
						saved++;
					}
					writeHistory(hist);
					if (saved > 0) alert(`Tiempos guardados (${saved})`); else alert('No hay tiempos para guardar');
				} catch { alert('No se pudieron guardar los tiempos'); }
			});
			historyBtn.addEventListener('click', () => {
				const items = readHistory().slice(-30).reverse();
				const pop = document.createElement('div'); pop.className = 'confirm-popover'; pop.style.position='fixed'; pop.style.left=(window.innerWidth/2)+'px'; pop.style.top='12%'; pop.style.transform='translate(-50%,0)'; pop.style.zIndex='10000';
				const title = document.createElement('h4'); title.textContent = 'Historial de tiempos'; title.style.margin='0 0 8px 0';
				const list = document.createElement('div'); list.style.maxHeight='60vh'; list.style.overflow='auto'; list.style.minWidth='min(92vw,620px)';
				if (!items.length) { const empty=document.createElement('div'); empty.textContent='Sin registros'; list.appendChild(empty); }
				for (const it of items) {
					const row = document.createElement('div'); row.style.borderBottom='1px solid var(--border)'; row.style.padding='8px 4px';
					const when = new Date(it.date_iso || it.id || Date.now());
					const stepInfo = it.step_name ? ` ¬∑ Paso: ${it.step_name}` : '';
					const avgInfo = it.avg_ms_per_unit ? ` ¬∑ Prom/u: ${fmtMs(it.avg_ms_per_unit)}` : '';
					row.innerHTML = `<strong>${it.dessert}</strong>${stepInfo} ¬∑ ${when.toLocaleString()} ¬∑ Cant: ${it.qty_units||0} ¬∑ Total: ${fmtMs(it.total_elapsed_ms||0)}${avgInfo}`;
					list.appendChild(row);
				}
				const actions=document.createElement('div'); actions.className='confirm-actions'; const close=document.createElement('button'); close.className='press-btn'; close.textContent='Cerrar'; actions.appendChild(close);
				pop.append(title, list, actions); document.body.appendChild(pop); pop.classList.add('aladdin-pop');
				close.addEventListener('click', () => { if (pop.parentNode) pop.parentNode.removeChild(pop); });
			});
		}

		// Navigation
		backBtn.addEventListener('click', () => {
			const url = new URL('/sales-report.html', location.origin);
			if (start) url.searchParams.set('start', start);
			if (end) url.searchParams.set('end', end);
			if (actor) url.searchParams.set('actor', actor);
			location.href = url.toString();
		});
		changeBtn.addEventListener('click', (ev) => {
			openRangeCalendarPopover((range) => {
				if (!range || !range.start || !range.end) return;
				start = range.start; end = range.end;
				history.replaceState(null, '', `?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}${actor?`&actor=${encodeURIComponent(actor)}`:''}`);
				load();
			}, ev.clientX, ev.clientY);
		});

		if (!start || !end) {
			countLabel.textContent = 'Selecciona un rango de fechas';
			const cx = Math.round(window.innerWidth / 2);
			const cy = 120;
			openRangeCalendarPopover((range) => {
				if (!range || !range.start || !range.end) return;
			start = range.start; end = range.end;
			history.replaceState(null, '', `?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}${actor?`&actor=${encodeURIComponent(actor)}`:''}`);
				load();
			}, cx, cy);
		} else {
			load();
		}
	})();
	</script>
</body>
</html>



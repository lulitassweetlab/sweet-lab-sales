<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Reporte de Ventas</title>
	<link rel="stylesheet" href="/styles.css?v=2025-09-17-1" />
	<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
	<header class="app-header">
		<div class="header-row">
			<div class="header-left">
				<img src="/logo.png" alt="Lulitas Logo" class="app-logo" />
				<h1>Reporte de Ventas</h1>
			</div>
			<div class="header-actions">
				<button id="back-btn" class="press-btn">Volver</button>
			</div>
		</div>
	</header>

	<main class="sales-panel">
		<div class="panel-header">
			<h3 id="title">Consolidado</h3>
			<div class="panel-actions">
				<button id="change-range" class="press-btn">Cambiar fechas</button>
				<button id="export-excel" class="excel-btn press-btn btn-gold">â¤“ Generar Excel</button>
				<button id="ingredients-btn" class="press-btn">Ingredientes necesarios</button>
			</div>
		</div>
		<div class="panel-body">
			<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
				<strong id="range-label"></strong>
				<small id="count-label" style="opacity:.8"></small>
			</div>
			<div class="filters-row" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:6px 0 12px 0">
				<label style="display:flex; gap:6px; align-items:flex-start">
					<span style="line-height:28px;">Vendedores</span>
					<div id="seller-filter-group" class="seller-filter-group" style="display:flex; gap:8px; flex-wrap:wrap; min-width:220px; max-height:132px; overflow:auto; padding:8px; border:1px solid var(--border); border-radius:10px; background: var(--card);"></div>
				</label>
				<label style="display:flex; gap:6px; align-items:center">
					<span>Pago</span>
					<select id="pay-filter" class="input-cell" style="min-width:160px"></select>
				</label>
			</div>
			<div class="table-wrapper" id="report-wrapper">
				<table id="report-table">
					<thead>
						<tr>
							<th id="th-date" style="cursor:pointer">Fecha</th>
							<th id="th-seller" style="cursor:pointer">Vendedor</th>
							<th class="col-paid">$</th>
							<th id="th-pay" style="cursor:pointer">Pago</th>
							<th>Cliente</th>
							<th class="col-qty">Arco</th>
							<th class="col-qty">Melo</th>
							<th class="col-qty">Mara</th>
							<th class="col-qty">Oreo</th>
							<th class="col-qty">Nute</th>
							<th class="col-total">Total</th>
						</tr>
					</thead>
					<tbody id="report-tbody"></tbody>
				<tfoot>
					<tr class="report-spacer-row"><td colspan="11"></td></tr>
						<tr>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td class="label">Totales</td>
							<td class="col-qty" id="t-qa"></td>
							<td class="col-qty" id="t-qm"></td>
							<td class="col-qty" id="t-qma"></td>
							<td class="col-qty" id="t-qo"></td>
							<td class="col-qty" id="t-qn"></td>
							<td class="col-total" id="t-grand"></td>
						</tr>
						<tr>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td class="label">Total postres</td>
							<td class="col-qty"></td>
							<td class="col-qty"></td>
							<td class="col-qty"></td>
							<td class="col-qty"></td>
							<td class="col-qty"></td>
							<td class="col-total" id="t-sum-all"></td>
						</tr>
					</tfoot>
				</table>
			</div>
		</div>
	</main>

	<script type="module">
	(function(){
		const qs = new URLSearchParams(location.search);
		let start = (qs.get('start') || '').slice(0,10);
		let end = (qs.get('end') || '').slice(0,10);
		// Try to infer current actor from localStorage set by index page
		let actor = '';
		try { const saved = JSON.parse(localStorage.getItem('authUser')||'null'); actor = (saved?.name||saved?.username||'').toString(); } catch {}
		const rangeLabel = document.getElementById('range-label');
		const countLabel = document.getElementById('count-label');
		const tbody = document.getElementById('report-tbody');
		const tQaEl = document.getElementById('t-qa');
		const tQmEl = document.getElementById('t-qm');
		const tQmaEl = document.getElementById('t-qma');
		const tQoEl = document.getElementById('t-qo');
		const tQnEl = document.getElementById('t-qn');
		const tGrandEl = document.getElementById('t-grand');
		const tSumAllEl = document.getElementById('t-sum-all');
		const backBtn = document.getElementById('back-btn');
		const changeBtn = document.getElementById('change-range');
		const exportBtn = document.getElementById('export-excel');
		const ingredientsBtn = document.getElementById('ingredients-btn');
		const sellerFilter = document.getElementById('seller-filter');
		const payFilter = document.getElementById('pay-filter');
		const sellerFilterGroup = document.getElementById('seller-filter-group');
		const thDate = document.getElementById('th-date');
		const thSeller = document.getElementById('th-seller');
		const thPay = document.getElementById('th-pay');

		let dataset = [];
		let sellersList = [];
		let sortKey = 'date'; // 'date' | 'seller' | 'pay'
		let sortDir = 'asc'; // 'asc' | 'desc'

		function formatDay(iso){
			if (!iso) return '';
			const d = new Date(iso + 'T00:00:00Z');
			const months = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
			return `${d.getUTCDate()} ${months[d.getUTCMonth()]} ${d.getUTCFullYear()}`;
		}

		function payLabel(pm){
			return pm === 'efectivo' ? 'Efectivo' : pm === 'transf' ? 'Transf' : pm === 'marce' ? 'Marce' : pm === 'jorge' ? 'Jorge' : pm === 'jorgebank' ? 'JorgeBank' : pm === 'entregado' ? 'Entregado' : '-';
		}

		async function fetchJSON(u){ const r = await fetch(u); if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); }

		function withActor(url){
			try {
				const u = new URL(url, location.origin);
				if (actor) u.searchParams.set('actor', actor);
				return u.pathname + (u.search || '');
			} catch { return url + (url.includes('?') ? `&actor=${encodeURIComponent(actor)}` : `?actor=${encodeURIComponent(actor)}`); }
		}

		function populateFilters(){
			// Sellers
			if (sellerFilterGroup) {
				const prevSelected = getSelectedSellers();
				sellerFilterGroup.innerHTML = '';
				// Master checkbox
				const masterWrap = document.createElement('label'); masterWrap.style.display='inline-flex'; masterWrap.style.alignItems='center'; masterWrap.style.gap='6px';
				const master = document.createElement('input'); master.type='checkbox'; master.id='sf_all';
				const masterSpan = document.createElement('span'); masterSpan.textContent = 'Todos';
				masterWrap.appendChild(master); masterWrap.appendChild(masterSpan);
				sellerFilterGroup.appendChild(masterWrap);
				// Vendors
				for (const s of (sellersList||[])){
					const id = `sf_${(s.name||'').replace(/[^a-z0-9]+/gi,'_')}`;
					const wrap = document.createElement('label');
					wrap.style.display = 'inline-flex'; wrap.style.alignItems = 'center'; wrap.style.gap = '6px';
					const cb = document.createElement('input'); cb.type = 'checkbox'; cb.value = s.name || ''; cb.id = id;
					cb.checked = prevSelected.length ? prevSelected.includes(cb.value) : false;
					cb.addEventListener('change', () => { updateMasterCheckboxState(); render(); });
					const sp = document.createElement('span'); sp.textContent = s.name || '';
					wrap.appendChild(cb); wrap.appendChild(sp);
					sellerFilterGroup.appendChild(wrap);
				}
				function updateMasterCheckboxState(){
					const cbs = Array.from(sellerFilterGroup.querySelectorAll('input[type="checkbox"]')).filter(x => x.id !== 'sf_all');
					const checked = cbs.filter(x => x.checked).length;
					master.indeterminate = checked > 0 && checked < cbs.length;
					master.checked = checked > 0 && checked === cbs.length;
				}
				master.addEventListener('change', () => {
					const cbs = Array.from(sellerFilterGroup.querySelectorAll('input[type="checkbox"]')).filter(x => x.id !== 'sf_all');
					for (const cb of cbs) cb.checked = master.checked;
					updateMasterCheckboxState();
					render();
				});
				updateMasterCheckboxState();
			}
			// Pay methods
			payFilter.innerHTML = '';
			const optAllP = document.createElement('option'); optAllP.value = ''; optAllP.textContent = 'Todos'; payFilter.appendChild(optAllP);
			const payCodes = ['', 'efectivo', 'transf', 'marce', 'jorge', 'jorgebank', 'entregado'];
			for (const code of payCodes){ if (code==='') continue; const o=document.createElement('option'); o.value=code; o.textContent=payLabel(code); payFilter.appendChild(o); }
		}

		function getSelectedSellers(){
			if (sellerFilterGroup) {
				return Array.from(sellerFilterGroup.querySelectorAll('input[type="checkbox"]:checked')).map(i => i.value).filter(Boolean);
			}
			return [];
		}

		function getFilteredSortedData(){
			const selSellers = getSelectedSellers();
			const selPay = (payFilter.value || '').toString();
			let rows = dataset.filter(r => {
				if (selSellers.length && !selSellers.includes(r.sellerName)) return false;
				if (selPay && (r.pay_method || '') !== selPay) return false;
				return true;
			});
			const cmp = (a,b) => {
				let va = '', vb = '';
				if (sortKey === 'date') { va = a.date; vb = b.date; }
				else if (sortKey === 'seller') { va = (a.sellerName||'').toLowerCase(); vb = (b.sellerName||'').toLowerCase(); }
				else if (sortKey === 'pay') { va = (payLabel(a.pay_method||'')||'').toLowerCase(); vb = (payLabel(b.pay_method||'')||'').toLowerCase(); }
				if (va < vb) return sortDir === 'asc' ? -1 : 1;
				if (va > vb) return sortDir === 'asc' ? 1 : -1;
				return 0;
			};
			rows.sort(cmp);
			return rows;
		}

		function render(){
			const rows = getFilteredSortedData();
			tbody.innerHTML = '';
			let tQa = 0, tQm = 0, tQma = 0, tQo = 0, tQn = 0, tGrand = 0;
			for (const r of rows){
				const row = document.createElement('tr');
				row.innerHTML = `
					<td>${r.date}</td>
					<td>${r.sellerName}</td>
					<td>${r.is_paid ? 'âœ“' : ''}</td>
					<td>${payLabel(r.pay_method||'')}</td>
					<td>${r.client_name||''}</td>
					<td>${r.qa||''}</td>
					<td>${r.qm||''}</td>
					<td>${r.qma||''}</td>
					<td>${r.qo||''}</td>
					<td>${r.qn||''}</td>
					<td class="col-total">${r.tot||''}</td>`;
				tbody.appendChild(row);
				tQa += r.qa||0; tQm += r.qm||0; tQma += r.qma||0; tQo += r.qo||0; tQn += r.qn||0; tGrand += r.tot||0;
			}
			tQaEl.textContent = tQa || '';
			tQmEl.textContent = tQm || '';
			tQmaEl.textContent = tQma || '';
			tQoEl.textContent = tQo || '';
			tQnEl.textContent = tQn || '';
			tGrandEl.textContent = tGrand || '';
			const sumAll = (tQa||0)+(tQm||0)+(tQma||0)+(tQo||0)+(tQn||0);
			tSumAllEl.textContent = sumAll || '';
			countLabel.textContent = `Filas: ${rows.length}`;
		}

		async function load(){
			if (!start || !end) return;
			rangeLabel.textContent = `${formatDay(start)} â€” ${formatDay(end)}`;
			countLabel.textContent = 'Cargandoâ€¦';
			dataset = [];
			sellersList = await fetchJSON('/api/sellers');
			populateFilters();
			countLabel.textContent = `Vendedores: ${sellersList.length} Â· Buscando dÃ­asâ€¦`;
			const isoBetween = (iso, a, b) => iso >= a && iso <= b;
			// Concurrency helper
			async function mapLimit(items, limit, fn) {
				const out = []; let idx = 0; let running = 0; let resolveAll; const done = new Promise(r => resolveAll = r);
				function runNext(){
					if (idx >= items.length && running === 0) return resolveAll();
					while (running < limit && idx < items.length) {
						const cur = items[idx++]; running++;
						Promise.resolve(fn(cur)).then(v => { out.push(v); running--; runNext(); }).catch(() => { running--; runNext(); });
					}
				}
				runNext(); await done; return out;
			}
			// Gather days within range for each seller
			const sellerDays = [];
			await mapLimit(sellersList, 6, async (s) => {
				try {
				const days = await fetchJSON(withActor(`/api/days?seller_id=${encodeURIComponent(s.id)}`));
					for (const d of (days||[])) {
						const iso = String(d.day).slice(0,10);
						if (isoBetween(iso, start, end)) sellerDays.push({ seller: s, day: d });
					}
				} catch {}
			});
			countLabel.textContent = `DÃ­as: ${sellerDays.length} Â· Buscando ventasâ€¦`;
			// Gather sales for those days
			await mapLimit(sellerDays, 6, async ({ seller, day }) => {
				try {
					const params = new URLSearchParams({ seller_id: String(seller.id), sale_day_id: String(day.id) });
					const sales = await fetchJSON(withActor(`/api/sales?${params.toString()}`));
					for (const r of (sales || [])) {
						const qa = r.qty_arco || 0; const qm = r.qty_melo || 0; const qma = r.qty_mara || 0; const qo = r.qty_oreo || 0; const qn = r.qty_nute || 0; const tot = r.total_cents || 0;
						dataset.push({
							date: String(day.day).slice(0,10),
							sellerName: seller.name || '',
							is_paid: !!r.is_paid,
							pay_method: (r.pay_method || '') || '',
							client_name: r.client_name || '',
							qa, qm, qma, qo, qn, tot
						});
					}
				} catch {}
			});
			render();
		}

		function openCalendar(ev){
			openRangeCalendarPopover((range) => {
				if (!range || !range.start || !range.end) return;
				start = range.start; end = range.end;
				history.replaceState(null, '', `?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`);
				load();
			}, ev.clientX, ev.clientY, { preferUp: true });
		}

		exportBtn.addEventListener('click', () => {
			// Build Excel from filtered and sorted data currently visible
			const header = ['Fecha','Vendedor', '$', 'Pago', 'Cliente', 'Arco', 'Melo', 'Mara', 'Oreo', 'Nute', 'Total'];
			const rows = [header];
			let eQa=0,eQm=0,eQma=0,eQo=0,eQn=0,eGrand=0;
			const data = getFilteredSortedData();
			for (const r of data){
				rows.push([
					r.date,
					r.sellerName,
					r.is_paid ? 'âœ“' : '',
					payLabel(r.pay_method||''),
					r.client_name||'',
					r.qa||'', r.qm||'', r.qma||'', r.qo||'', r.qn||'', r.tot||''
				]);
				eQa += r.qa||0; eQm += r.qm||0; eQma += r.qma||0; eQo += r.qo||0; eQn += r.qn||0; eGrand += r.tot||0;
			}
			// Empty spacer row before totals (fixed 11 columns)
			rows.push(new Array(11).fill(''));
			// Totales row (fixed 11 columns)
			const totRow = new Array(11).fill('');
			totRow[4] = 'Totales';
			totRow[5] = eQa||''; totRow[6] = eQm||''; totRow[7] = eQma||''; totRow[8] = eQo||''; totRow[9] = eQn||''; totRow[10] = eGrand||'';
			rows.push(totRow);
			// Total postres row (fixed 11 columns)
			const sumAll = (eQa||0)+(eQm||0)+(eQma||0)+(eQo||0)+(eQn||0);
			const sumRow = new Array(11).fill('');
			sumRow[4] = 'Total postres';
			sumRow[10] = sumAll||'';
			rows.push(sumRow);
			const ws = XLSX.utils.aoa_to_sheet(rows);
			ws['!cols'] = [ {wch:10},{wch:18},{wch:3},{wch:10},{wch:24},{wch:6},{wch:6},{wch:6},{wch:6},{wch:6},{wch:10} ];
			const wb = XLSX.utils.book_new();
			XLSX.utils.book_append_sheet(wb, ws, 'Consolidado');
			XLSX.writeFile(wb, `Consolidado_${(start||'').replaceAll('-','')}_a_${(end||'').replaceAll('-','')}.xlsx`);
		});

		ingredientsBtn.addEventListener('click', () => {
			const url = new URL('/ingredients.html', location.origin);
			if (start) url.searchParams.set('start', start);
			if (end) url.searchParams.set('end', end);
			location.href = url.toString();
		});

		backBtn.addEventListener('click', () => { location.href = '/'; });
		changeBtn.addEventListener('click', openCalendar);
		// sellerFilter removed (replaced by checkboxes)
		payFilter.addEventListener('change', () => render());
		function toggleSort(key){
			if (sortKey === key){ sortDir = (sortDir === 'asc') ? 'desc' : 'asc'; }
			else { sortKey = key; sortDir = 'asc'; }
			render();
		}
		thDate?.addEventListener('click', () => toggleSort('date'));
		thSeller?.addEventListener('click', () => toggleSort('seller'));
		thPay?.addEventListener('click', () => toggleSort('pay'));

		// Lightweight embed of openRangeCalendarPopover if not present
		if (typeof window.openRangeCalendarPopover !== 'function') {
			window.openRangeCalendarPopover = function(onPickedRange, anchorX, anchorY, opts){
				const pop = document.createElement('div'); pop.className = 'date-popover'; pop.style.position = 'fixed'; const baseX = anchorX||window.innerWidth/2; const baseY = anchorY||window.innerHeight/2; pop.style.left = baseX+'px'; pop.style.top=(baseY+8)+'px'; pop.style.transform='translate(-50%,0)'; pop.style.zIndex='1000';
				const months = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre']; let view = new Date(); view.setDate(1); let startIso=null, endIso=null;
				const header=document.createElement('div'); header.className='date-popover-header'; const prev=document.createElement('button'); prev.className='date-nav'; prev.textContent='â€¹'; const label=document.createElement('div'); label.className='date-label'; const next=document.createElement('button'); next.className='date-nav'; next.textContent='â€º'; header.append(prev,label,next);
				const grid=document.createElement('div'); grid.className='date-grid'; const weekdays=['L','M','X','J','V','S','D']; const wk=document.createElement('div'); wk.className='date-weekdays'; for (const w of weekdays){ const c=document.createElement('div'); c.textContent=w; wk.appendChild(c);} 
				function isoUTC(y,m,d){ return new Date(Date.UTC(y,m,d)).toISOString().slice(0,10); }
				function isBetween(x,a,b){ return x>=a && x<=b; }
				function render(){ label.textContent = months[view.getMonth()] + ' ' + view.getFullYear(); grid.innerHTML=''; const year=view.getFullYear(); const month=view.getMonth(); const firstDay=(new Date(Date.UTC(year,month,1)).getUTCDay()+6)%7; const daysInMonth=new Date(Date.UTC(year,month+1,0)).getUTCDate(); for (let i=0;i<firstDay;i++){ const cell=document.createElement('button'); cell.className='date-cell disabled'; cell.disabled=true; grid.appendChild(cell);} for (let d=1; d<=daysInMonth; d++){ const iso=isoUTC(year,month,d); const cell=document.createElement('button'); let cls='date-cell'; if (startIso && !endIso && iso===startIso) cls+=' range-start selected'; if (startIso && endIso){ if (iso===startIso) cls+=' range-start selected'; else if (iso===endIso) cls+=' range-end selected'; else if (isBetween(iso,startIso,endIso)) cls+=' in-range'; } cell.className=cls; cell.textContent=String(d); cell.addEventListener('click',()=>{ if(!startIso){ startIso=iso; endIso=null; render(); return; } if(!endIso){ if(iso<startIso){ endIso=startIso; startIso=iso; } else { endIso=iso; } render(); return; } startIso=iso; endIso=null; render(); }); grid.appendChild(cell);} }
				function cleanup(){ document.removeEventListener('mousedown', outside, true); document.removeEventListener('touchstart', outside, true); if(pop.parentNode) pop.parentNode.removeChild(pop);} function outside(ev){ if(!pop.contains(ev.target)) cleanup(); }
				prev.addEventListener('click',()=>{ view.setMonth(view.getMonth()-1); render(); }); next.addEventListener('click',()=>{ view.setMonth(view.getMonth()+1); render(); });
				const actions=document.createElement('div'); actions.style.display='flex'; actions.style.justifyContent='space-between'; actions.style.marginTop='8px'; const clearBtn=document.createElement('button'); clearBtn.className='date-nav'; clearBtn.textContent='Limpiar'; const genBtn=document.createElement('button'); genBtn.className='date-nav'; genBtn.textContent='Generar'; genBtn.disabled=true; clearBtn.addEventListener('click',()=>{ startIso=null; endIso=null; genBtn.disabled=true; render(); }); genBtn.addEventListener('click',()=>{ if(startIso && endIso && typeof onPickedRange==='function'){ cleanup(); onPickedRange({ start:startIso, end:endIso }); } }); actions.append(clearBtn, genBtn);
				const origRender = render; render = function(){ origRender(); genBtn.disabled = !(startIso && endIso); };
				pop.append(header, wk, grid, actions); document.body.appendChild(pop); pop.classList.add('aladdin-pop');
				document.addEventListener('mousedown', outside, true); document.addEventListener('touchstart', outside, true); render();
			};
		}

		load();
	})();
	</script>
</body>
</html>


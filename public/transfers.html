<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Transferencias - Comprobantes</title>
	<link rel="stylesheet" href="/styles.css?v=2025-09-17-1" />
</head>
<body>
	<header class="app-header">
		<div class="header-row">
			<div class="header-left">
				<img src="/logo.png" alt="Lulitas Logo" class="app-logo" />
				<h1>Transferencias</h1>
			</div>
			<div class="header-actions">
				<button id="back-btn" class="press-btn">Volver</button>
			</div>
		</div>
	</header>

	<main class="transfers-container">
		<div class="transfers-header">
			<div>
				<strong id="range-label"></strong>
				<div id="count-label" style="opacity:.8; font-size:12px"></div>
			</div>
			<div style="display:flex; gap:8px; align-items:center;">
				<button id="user-filter-btn" class="press-btn">Filtrar usuarios</button>
				<button id="amount-filter-btn" class="press-btn">Filtrar valor</button>
				<button id="payment-date-filter-btn" class="press-btn">Fecha pago: <span id="payment-date-filter-label">Todas</span></button>
				<button id="change-range" class="press-btn">Cambiar fechas</button>
			</div>
		</div>
		<div id="grid" class="transfers-grid"></div>
		<div id="empty" class="transfers-empty" style="display:none">No hay comprobantes en este rango</div>
	</main>

	<script type="module">
	(function(){
		// Read current user for role-based payment options and audit actor name
			let currentUser = null;
		try { const saved = localStorage.getItem('authUser'); if (saved) currentUser = JSON.parse(saved); } catch {}
		const qs = new URLSearchParams(location.search);
		let start = (qs.get('start') || '').slice(0,10);
		let end = (qs.get('end') || '').slice(0,10);
		const rangeLabel = document.getElementById('range-label');
		const countLabel = document.getElementById('count-label');
		const grid = document.getElementById('grid');
		const empty = document.getElementById('empty');
		const backBtn = document.getElementById('back-btn');
		const changeBtn = document.getElementById('change-range');
		const userFilterBtn = document.getElementById('user-filter-btn');
		const amountFilterBtn = document.getElementById('amount-filter-btn');
		const paymentDateFilterBtn = document.getElementById('payment-date-filter-btn');
		const paymentDateFilterLabel = document.getElementById('payment-date-filter-label');
		let selectedUsers = new Set(); // Set of seller IDs
		let allSellers = [];
		let minAmount = null;
		let maxAmount = null;
		let selectedPaymentDates = []; // array of YYYY-MM-DD strings

		function buildPaySelector(sale){
			const container = document.createElement('div');
			// Use col-paid wrapper so existing CSS icons apply
			const col = document.createElement('div'); col.className = 'col-paid';
			const wrap = document.createElement('span'); wrap.className = 'pay-wrap';
			const sel = document.createElement('select'); sel.className = 'input-cell pay-select';
			// Hide native select; we open custom menu on click
			sel.style.display = 'none';
			const current = (sale.pay_method || '').replace(/\.$/, '');
			const isMarcela = String(currentUser?.name || '').toLowerCase() === 'marcela';
			const isJorge = String(currentUser?.name || '').toLowerCase() === 'jorge';
			const opts = [ { v: '', label: '-' }, { v: 'efectivo', label: '' }, { v: 'entregado', label: '' } ];
			if (isMarcela) opts.push({ v: 'marce', label: '' });
			if (!isMarcela && current === 'marce') opts.push({ v: 'marce', label: '' });
			if (isJorge) opts.push({ v: 'jorge', label: '' });
			if (!isJorge && current === 'jorge') opts.push({ v: 'jorge', label: '' });
			opts.push({ v: 'transf', label: '' });
			if (isJorge) opts.push({ v: 'jorgebank', label: '' });
			if (!isJorge && current === 'jorgebank') opts.push({ v: 'jorgebank', label: '' });
			for (const o of opts) {
				const opt = document.createElement('option');
				opt.value = o.v; opt.textContent = o.label;
				if (!isMarcela && o.v === 'marce') opt.disabled = true;
				if (!isJorge && o.v === 'jorge') opt.disabled = true;
				if (current === o.v) opt.selected = true;
				sel.appendChild(opt);
			}
			function applyPayClass(){
				wrap.classList.remove('placeholder','method-efectivo','method-transf','method-marce','method-jorge','method-jorgebank','method-entregado');
				const val = sel.value;
				if (!val) wrap.classList.add('placeholder');
				else if (val === 'efectivo') wrap.classList.add('method-efectivo');
				else if (val === 'entregado') wrap.classList.add('method-entregado');
				else if (val === 'transf') wrap.classList.add('method-transf');
				else if (val === 'marce') wrap.classList.add('method-marce');
				else if (val === 'jorge') wrap.classList.add('method-jorge');
				else if (val === 'jorgebank') wrap.classList.add('method-jorgebank');
			}
			applyPayClass();
            wrap.addEventListener('click', (e) => {
				e.stopPropagation();
				const rect = wrap.getBoundingClientRect();
                openPayMenu(wrap, sel, rect.left + rect.width/2, rect.bottom, sale);
			});
			wrap.tabIndex = 0;
            wrap.addEventListener('keydown', (e) => {
				if (e.key === 'Enter' || e.key === ' ') {
					e.preventDefault();
					const rect = wrap.getBoundingClientRect();
                    openPayMenu(wrap, sel, rect.left + rect.width/2, rect.bottom, sale);
				}
			});
			sel.addEventListener('change', async () => {
				// Persist to backend using the same endpoint as sales table
				const payload = {
					id: Number(sale.id),
					client_name: (sale.client_name || ''),
					qty_arco: Number(sale.qty_arco||0),
					qty_melo: Number(sale.qty_melo||0),
					qty_mara: Number(sale.qty_mara||0),
					qty_oreo: Number(sale.qty_oreo||0),
					qty_nute: Number(sale.qty_nute||0),
					is_paid: !!sale.is_paid,
					pay_method: sel.value || null,
					_actor_name: currentUser?.name || ''
				};
				try {
					await fetch('/api/sales', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
					// Reflect locally so UI stays in sync
					sale.pay_method = sel.value || null;
				} catch {}
				applyPayClass();
			});
			wrap.appendChild(sel);
			col.appendChild(wrap);
			container.appendChild(col);
			return container;
		}

        function openPayMenu(anchorEl, selectEl, clickX, clickY, sale) {
			const rect = anchorEl.getBoundingClientRect();
			const menu = document.createElement('div');
			menu.className = 'pay-menu';
			menu.style.position = 'fixed';
			menu.style.transform = 'translateX(-50%)';
			menu.style.zIndex = '1000';
			const items = [ { v: 'efectivo', cls: 'menu-efectivo' }, { v: 'entregado', cls: 'menu-entregado' } ];
			if (String(currentUser?.name || '').toLowerCase() === 'marcela') items.push({ v: 'marce', cls: 'menu-marce' });
			const isJorgeUser = String(currentUser?.name || '').toLowerCase() === 'jorge';
			if (isJorgeUser) {
				items.push({ v: 'jorge', cls: 'menu-jorge' });
				items.push({ v: 'jorgebank', cls: 'menu-jorgebank' });
			} else if ((selectEl.value || '') === 'jorgebank') {
				items.push({ v: 'jorgebank', cls: 'menu-jorgebank' });
			}
			items.push({ v: '', cls: 'menu-clear' }, { v: 'transf', cls: 'menu-transf' });
			for (const it of items) {
				const btn = document.createElement('button');
				btn.type = 'button';
				btn.className = 'pay-menu-item ' + it.cls;
				if (it.v === '') btn.textContent = '-';
				btn.addEventListener('click', (e) => {
					e.stopPropagation();
					selectEl.value = it.v;
					selectEl.dispatchEvent(new Event('change'));
                    cleanup();
                    // If jorgebank selected, open payment date popover centered
                    if (it.v === 'jorgebank' && sale && typeof openPaymentDateDialogTransfer === 'function') {
                        try { openPaymentDateDialogTransfer(sale); } catch {}
                    }
				});
				menu.appendChild(btn);
			}
			menu.style.left = '0px';
			menu.style.top = '0px';
			menu.style.visibility = 'hidden';
			menu.style.pointerEvents = 'none';
			document.body.appendChild(menu);
			const dashBtn = menu.querySelector('.menu-clear');
			const menuRect = menu.getBoundingClientRect();
			const dashRect = dashBtn ? dashBtn.getBoundingClientRect() : menuRect;
			const anchorCx = (typeof clickX === 'number') ? clickX : (rect.left + rect.width / 2);
			const anchorCy = (typeof clickY === 'number') ? clickY : (rect.top + rect.height / 2);
			const offsetYWithinMenu = (dashRect.top - menuRect.top) + (dashRect.height / 2);
			let left = anchorCx;
			let top = anchorCy - offsetYWithinMenu;
			const half = menu.offsetWidth / 2;
			left = Math.min(Math.max(left, half + 6), window.innerWidth - half - 6);
			top = Math.max(6, Math.min(top, window.innerHeight - menu.offsetHeight - 6));
			menu.style.left = left + 'px';
			menu.style.top = top + 'px';
			menu.style.visibility = '';
			menu.style.pointerEvents = '';
			function outside(e) { if (!menu.contains(e.target)) cleanup(); }
			function cleanup() {
				document.removeEventListener('mousedown', outside, true);
				document.removeEventListener('touchstart', outside, true);
				if (menu.parentNode) menu.parentNode.removeChild(menu);
			}

        // Payment date dialog for transfers: centered and full view
        function openPaymentDateDialogTransfer(sale){
            if (!sale || !sale.id) return;
            const pop = document.createElement('div');
            pop.className = 'payment-date-popover';
            pop.style.position = 'fixed';
            pop.style.zIndex = '1000';

            // Title
            const title = document.createElement('div');
            title.className = 'payment-date-title';
            title.textContent = 'Fecha de pago';

            // Inline calendar
            const calendarContainer = document.createElement('div');
            calendarContainer.className = 'inline-calendar';

            const today = new Date();
            let initialDate = new Date();
            const savedDate = sale.payment_date;
            if (savedDate) {
                try {
                    const dateStr = typeof savedDate === 'string' ? savedDate.slice(0,10) : String(savedDate).slice(0,10);
                    const parsed = new Date(dateStr + 'T00:00:00');
                    if (!isNaN(parsed.getTime())) initialDate = parsed;
                } catch {}
            }
            let currentMonth = initialDate.getMonth();
            let currentYear = initialDate.getFullYear();
            let selectedDate = new Date(initialDate);

            const monthNames = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
            const calendarHeader = document.createElement('div');
            calendarHeader.className = 'calendar-header';
            const prevBtn = document.createElement('button'); prevBtn.className = 'calendar-nav-btn'; prevBtn.type='button'; prevBtn.innerHTML='◀';
            const monthLabel = document.createElement('span'); monthLabel.className = 'calendar-month-label'; monthLabel.textContent = `${monthNames[currentMonth]} ${currentYear}`;
            const nextBtn = document.createElement('button'); nextBtn.className = 'calendar-nav-btn'; nextBtn.type='button'; nextBtn.innerHTML='▶';
            calendarHeader.append(prevBtn, monthLabel, nextBtn);

            const calendarGrid = document.createElement('div');
            calendarGrid.className = 'calendar-grid';
            function renderCalendar(){
                calendarGrid.innerHTML = '';
                monthLabel.textContent = `${monthNames[currentMonth]} ${currentYear}`;
                const dayNames = ['D','L','M','M','J','V','S'];
                for (const d of dayNames){ const h=document.createElement('div'); h.className='calendar-day-header'; h.textContent=d; calendarGrid.appendChild(h); }
                const firstDay = new Date(currentYear, currentMonth, 1).getDay();
                const daysInMonth = new Date(currentYear, currentMonth+1, 0).getDate();
                for (let i=0;i<firstDay;i++){ const e=document.createElement('div'); e.className='calendar-day empty'; calendarGrid.appendChild(e); }
                for (let day=1; day<=daysInMonth; day++){
                    const cell=document.createElement('div'); cell.className='calendar-day'; cell.textContent=day;
                    const cellDate = new Date(currentYear, currentMonth, day);
                    if (cellDate.toDateString() === today.toDateString()) cell.classList.add('today');
                    if (selectedDate && selectedDate.getDate()===day && selectedDate.getMonth()===currentMonth && selectedDate.getFullYear()===currentYear) {
                        cell.classList.add('selected');
                    }
                    cell.addEventListener('click', ()=>{
                        calendarGrid.querySelectorAll('.calendar-day').forEach(d=>d.classList.remove('selected'));
                        cell.classList.add('selected');
                        selectedDate = new Date(currentYear, currentMonth, day);
                    });
                    calendarGrid.appendChild(cell);
                }
            }
            prevBtn.addEventListener('click', (e)=>{ e.preventDefault(); currentMonth--; if(currentMonth<0){ currentMonth=11; currentYear--; } renderCalendar(); });
            nextBtn.addEventListener('click', (e)=>{ e.preventDefault(); currentMonth++; if(currentMonth>11){ currentMonth=0; currentYear++; } renderCalendar(); });
            renderCalendar();
            calendarContainer.append(calendarHeader, calendarGrid);

            const methodLabel = document.createElement('div');
            methodLabel.className = 'payment-date-label';
            methodLabel.textContent = 'Fuente de pago:';
            methodLabel.style.marginTop = '14px';
            const methodsContainer = document.createElement('div');
            methodsContainer.className = 'payment-methods-container';
            const methods = [
                { value: 'bancolombia', label: 'Bancolombia' },
                { value: 'nequi', label: 'Nequi' },
                { value: 'efectivo_marcela', label: 'Efectivo Marcela' },
                { value: 'efectivo_aleja', label: 'Efectivo Aleja' },
                { value: 'bancolombia_aleja', label: 'Bancolombia Aleja' },
                { value: 'otro', label: 'Otro' }
            ];
            const previousSource = sale.payment_source;
            for (const m of methods){
                const b = document.createElement('button');
                b.type = 'button'; b.className='payment-method-btn'; b.textContent = m.label; b.dataset.value = m.value;
                if (previousSource && (
                    m.label === previousSource ||
                    m.label.toLowerCase() === String(previousSource).toLowerCase() ||
                    m.value === String(previousSource).toLowerCase()
                )) { b.classList.add('selected'); }
                b.addEventListener('click', async ()=>{
                    // Disable while saving
                    methodsContainer.querySelectorAll('button').forEach(x=>x.disabled=true);
                    try {
                        const paymentDate = selectedDate.toISOString().split('T')[0];
                        const paymentSource = m.label;
                        const payload = {
                            id: Number(sale.id),
                            client_name: sale.client_name || '',
                            qty_arco: Number(sale.qty_arco||0),
                            qty_melo: Number(sale.qty_melo||0),
                            qty_mara: Number(sale.qty_mara||0),
                            qty_oreo: Number(sale.qty_oreo||0),
                            qty_nute: Number(sale.qty_nute||0),
                            is_paid: !!sale.is_paid,
                            pay_method: sale.pay_method || null,
                            payment_date: paymentDate,
                            payment_source: paymentSource,
                            _actor_name: currentUser?.name || ''
                        };
                        await fetch('/api/sales', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        sale.payment_date = paymentDate;
                        sale.payment_source = paymentSource;
                        cleanup();
                    } catch (err) {
                        console.error('Error guardando fecha de pago:', err);
                        methodsContainer.querySelectorAll('button').forEach(x=>x.disabled=false);
                    }
                });
                methodsContainer.appendChild(b);
            }

            pop.append(title, calendarContainer, methodLabel, methodsContainer);
            document.body.appendChild(pop);

            // Center in viewport and keep fully visible
            requestAnimationFrame(()=>{
                const r = pop.getBoundingClientRect();
                const vw = window.innerWidth, vh = window.innerHeight;
                const pad = 16;
                let left = (vw - r.width)/2; if (left < pad) left = pad; if (left + r.width > vw - pad) left = vw - r.width - pad;
                let top = (vh - r.height)/2; if (top < pad) top = pad; if (top + r.height > vh - pad) top = vh - r.height - pad;
                pop.style.left = left + 'px';
                pop.style.top = top + 'px';
                pop.style.transform = 'none';
            });

            function outside(ev){ if (!pop.contains(ev.target)) cleanup(); }
            function cleanup(){
                document.removeEventListener('mousedown', outside, true);
                document.removeEventListener('touchstart', outside, true);
                if (pop.parentNode) pop.parentNode.removeChild(pop);
            }
            setTimeout(()=>{
                document.addEventListener('mousedown', outside, true);
                document.addEventListener('touchstart', outside, true);
            },0);
        }
			setTimeout(() => {
				document.addEventListener('mousedown', outside, true);
				document.addEventListener('touchstart', outside, true);
			}, 0);
		}

		function formatDay(iso){
			if (!iso) return '';
			const d = new Date(iso + 'T00:00:00Z');
			const months = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
			return `${d.getUTCDate()} ${months[d.getUTCMonth()]} ${d.getUTCFullYear()}`;
		}

			async function load(){
			if (!start || !end) return;
			rangeLabel.textContent = `${formatDay(start)} — ${formatDay(end)}`;
			grid.innerHTML = '';
			empty.style.display = 'none';
			countLabel.textContent = 'Cargando…';
				const isoBetween = (iso, a, b) => iso >= a && iso <= b;
				const fetchJSON = async (u) => {
					const headers = {};
					if (currentUser?.name) headers['X-Actor-Name'] = String(currentUser.name);
					const r = await fetch(u, { headers });
					if (!r.ok) throw new Error(`HTTP ${r.status}`);
					return r.json();
				};
				const sellers = await fetchJSON('/api/sellers?include_archived=1');
			// Filter out archived sellers and store for filter menu
			allSellers = sellers.filter(s => !s.is_archived);
			let found = 0;
			countLabel.textContent = `Vendedores: ${sellers.length} · Buscando días…`;
			// Concurrency limiter
			async function mapLimit(items, limit, fn) {
				const out = []; let idx = 0; let running = 0; let resolveAll; const done = new Promise(r => resolveAll = r);
				function runNext(){
					if (idx >= items.length && running === 0) return resolveAll();
					while (running < limit && idx < items.length) {
						const cur = items[idx++]; running++;
						Promise.resolve(fn(cur)).then(v => { out.push(v); running--; runNext(); }).catch(() => { running--; runNext(); });
					}
				}
				runNext(); await done; return out;
			}
			// Gather days within range for each seller
			const sellerDays = [];
			// Filter sellers by selected users if applicable
			const filteredSellers = selectedUsers.size > 0 
				? allSellers.filter(s => selectedUsers.has(String(s.id)))
				: allSellers;
				await mapLimit(filteredSellers, 6, async (s) => {
				try {
						const days = await fetchJSON(`/api/days?seller_id=${encodeURIComponent(s.id)}&include_archived=1`);
					for (const d of (days||[])) {
						const iso = String(d.day).slice(0,10);
						if (isoBetween(iso, start, end)) sellerDays.push({ seller: s, day: d });
					}
				} catch {}
			});
			countLabel.textContent = `Días: ${sellerDays.length} · Buscando ventas…`;
			// Gather sales for those days
			const daySales = [];
				await mapLimit(sellerDays, 6, async ({ seller, day }) => {
				try {
						const params = new URLSearchParams({ seller_id: String(seller.id), sale_day_id: String(day.id) });
						const sales = await fetchJSON(`/api/sales?${params.toString()}`);
					for (const row of (sales||[])) daySales.push({ seller, day, sale: row });
				} catch {}
			});
			countLabel.textContent = `Ventas: ${daySales.length} · Buscando comprobantes…`;
			// For each sale, fetch its receipt (if any) and render immediately
			await mapLimit(daySales, 8, async ({ seller, day, sale }) => {
				try {
					const recs = await fetchJSON(`/api/sales?receipt_for=${encodeURIComponent(sale.id)}`);
					// Apply amount filter
					const saleAmount = Number(sale.total_cents || 0);
					if (minAmount !== null && saleAmount < minAmount) return;
					if (maxAmount !== null && saleAmount > maxAmount) return;
					
					// Show ALL receipts for this sale, not just the first one
					if (Array.isArray(recs) && recs.length) {
						for (const r of recs) {
							// Apply payment date filter per receipt
							const receiptPayDate = r.payment_date ? String(r.payment_date).slice(0,10) : '';
							if (selectedPaymentDates.length > 0 && (!receiptPayDate || !selectedPaymentDates.includes(receiptPayDate))) continue;
							
							const card = document.createElement('div'); card.className = 'transfer-card';
							const img = document.createElement('img'); img.alt = 'Comprobante'; img.src = r.image_base64; img.addEventListener('click', () => openLightbox(r.image_base64, r.note_text || ''));
							const meta = document.createElement('div'); meta.className = 'transfer-meta';
							if (receiptPayDate) meta.dataset.paymentDate = receiptPayDate; // mark for filtering
							
							// Payment selector showing receipt's pay_method (not sale's)
							// Create a mini sale object for the selector with receipt's pay_method
							const receiptSale = { ...sale, pay_method: r.pay_method || sale.pay_method };
							const paySelector = buildPaySelector(receiptSale);
							const payOverlay = document.createElement('div'); payOverlay.className = 'transfer-pay'; payOverlay.appendChild(paySelector);
							
							const l1 = document.createElement('div'); l1.className = 'line'; l1.innerHTML = `<span>${(seller.name||'').toString()}</span><span>${String(day.day).slice(0,10)}</span>`;
							const l2 = document.createElement('div'); l2.className = 'line';
							const clientEl = document.createElement('span'); clientEl.className = 'transfer-client'; clientEl.textContent = (sale.client_name||'').toString();
							clientEl.title = 'Ir al pedido en ventas';
							clientEl.addEventListener('click', () => {
								try {
									const payload = { sellerId: seller.id, dayIso: String(day.day).slice(0,10), clientName: sale.client_name||'' };
									localStorage.setItem('pendingFocus', JSON.stringify(payload));
									window.open('/', '_blank');
								} catch { window.open('/', '_blank'); }
							});
							const amountEl = document.createElement('span'); amountEl.textContent = String(sale.total_cents||0);
							l2.append(clientEl, amountEl);
							
							const note = document.createElement('div'); note.className = 'note'; 
							// Show receipt note if exists, otherwise empty
							note.textContent = (r.note_text||'').toString();
							
							// Add indicator if this is one of multiple receipts
							if (recs.length > 1) {
								const multiIndicator = document.createElement('div');
								multiIndicator.style.fontSize = '11px';
								multiIndicator.style.opacity = '0.7';
								multiIndicator.style.marginTop = '4px';
								multiIndicator.textContent = `Comprobante ${recs.indexOf(r) + 1} de ${recs.length}`;
								meta.append(l1, l2, note, multiIndicator);
							} else {
								meta.append(l1, l2, note);
							}
							
							card.append(payOverlay, img, meta);
							grid.appendChild(card);
							found++;
							countLabel.textContent = `Comprobantes: ${found} · Ventas revisadas: ${daySales.length}`;
						}
					}
				} catch {}
			});
			if (!found) { empty.style.display = ''; countLabel.textContent = `Sin comprobantes · ${start} — ${end}`; }
		}

		backBtn.addEventListener('click', () => { location.href = '/'; });
		changeBtn.addEventListener('click', (ev) => {
			openRangeCalendarPopover((range) => {
				if (!range || !range.start || !range.end) return;
				start = range.start; end = range.end;
				history.replaceState(null, '', `?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`);
				load();
			}, ev.clientX, ev.clientY, { preferUp: true });
		});
		
		userFilterBtn.addEventListener('click', (ev) => {
			openUserFilterMenu(ev.clientX, ev.clientY);
		});

		amountFilterBtn.addEventListener('click', (ev) => {
			openAmountFilterMenu(ev.clientX, ev.clientY);
		});

		paymentDateFilterBtn.addEventListener('click', (ev) => {
			openPaymentDateFilterMenu(ev.clientX, ev.clientY);
		});

		function openUserFilterMenu(anchorX, anchorY) {
			const menu = document.createElement('div');
			menu.className = 'pay-menu';
			menu.style.position = 'fixed';
			menu.style.left = anchorX + 'px';
			menu.style.top = anchorY + 'px';
			menu.style.transform = 'translateX(-50%)';
			menu.style.zIndex = '1000';
			menu.style.maxHeight = '400px';
			menu.style.overflowY = 'auto';
			menu.style.padding = '8px';
			menu.style.minWidth = '200px';

			// "Todos" checkbox
			const allWrap = document.createElement('label');
			allWrap.style.display = 'flex';
			allWrap.style.alignItems = 'center';
			allWrap.style.gap = '8px';
			allWrap.style.padding = '4px 8px';
			allWrap.style.cursor = 'pointer';
			allWrap.style.borderBottom = '1px solid rgba(0,0,0,0.1)';
			allWrap.style.marginBottom = '4px';
			const allCheck = document.createElement('input');
			allCheck.type = 'checkbox';
			allCheck.checked = selectedUsers.size === 0;
			const allLabel = document.createElement('span');
			allLabel.textContent = 'Todos los usuarios';
			allLabel.style.fontWeight = '600';
			allWrap.append(allCheck, allLabel);
			
			allCheck.addEventListener('change', () => {
				if (allCheck.checked) {
					selectedUsers.clear();
					// Uncheck all individual checkboxes
					menu.querySelectorAll('input[type="checkbox"]').forEach(cb => {
						if (cb !== allCheck) cb.checked = false;
					});
				}
			});

			menu.appendChild(allWrap);

			// Individual seller checkboxes
			for (const seller of allSellers) {
				const wrap = document.createElement('label');
				wrap.style.display = 'flex';
				wrap.style.alignItems = 'center';
				wrap.style.gap = '8px';
				wrap.style.padding = '4px 8px';
				wrap.style.cursor = 'pointer';
				wrap.style.borderRadius = '4px';
				wrap.addEventListener('mouseenter', () => {
					wrap.style.backgroundColor = 'rgba(0,0,0,0.05)';
				});
				wrap.addEventListener('mouseleave', () => {
					wrap.style.backgroundColor = '';
				});

				const checkbox = document.createElement('input');
				checkbox.type = 'checkbox';
				checkbox.checked = selectedUsers.has(String(seller.id));
				checkbox.dataset.sellerId = String(seller.id);

				const label = document.createElement('span');
				label.textContent = String(seller.name || '');

				checkbox.addEventListener('change', () => {
					if (checkbox.checked) {
						selectedUsers.add(String(seller.id));
						allCheck.checked = false;
					} else {
						selectedUsers.delete(String(seller.id));
						if (selectedUsers.size === 0) {
							allCheck.checked = true;
						}
					}
				});

				wrap.append(checkbox, label);
				menu.appendChild(wrap);
			}

			// Apply button
			const actions = document.createElement('div');
			actions.style.display = 'flex';
			actions.style.gap = '8px';
			actions.style.marginTop = '8px';
			actions.style.paddingTop = '8px';
			actions.style.borderTop = '1px solid rgba(0,0,0,0.1)';
			
			const applyBtn = document.createElement('button');
			applyBtn.className = 'press-btn btn-primary';
			applyBtn.textContent = 'Aplicar';
			applyBtn.style.flex = '1';
			applyBtn.addEventListener('click', () => {
				cleanup();
				load();
			});

			const cancelBtn = document.createElement('button');
			cancelBtn.className = 'press-btn';
			cancelBtn.textContent = 'Cancelar';
			cancelBtn.style.flex = '1';
			cancelBtn.addEventListener('click', cleanup);

			actions.append(cancelBtn, applyBtn);
			menu.appendChild(actions);

			document.body.appendChild(menu);

			// Position adjustment to keep in viewport
			const rect = menu.getBoundingClientRect();
			let left = anchorX;
			let top = anchorY + 8;
			
			if (left + rect.width / 2 > window.innerWidth - 10) {
				left = window.innerWidth - rect.width / 2 - 10;
			}
			if (left - rect.width / 2 < 10) {
				left = rect.width / 2 + 10;
			}
			if (top + rect.height > window.innerHeight - 10) {
				top = anchorY - rect.height - 8;
			}

			menu.style.left = left + 'px';
			menu.style.top = top + 'px';

			function outside(e) {
				if (!menu.contains(e.target)) cleanup();
			}
			function cleanup() {
				document.removeEventListener('mousedown', outside, true);
				document.removeEventListener('touchstart', outside, true);
				if (menu.parentNode) menu.parentNode.removeChild(menu);
			}
			setTimeout(() => {
				document.addEventListener('mousedown', outside, true);
				document.addEventListener('touchstart', outside, true);
			}, 0);
		}

		function openAmountFilterMenu(anchorX, anchorY) {
			const menu = document.createElement('div');
			menu.className = 'pay-menu';
			menu.style.position = 'fixed';
			menu.style.left = anchorX + 'px';
			menu.style.top = anchorY + 'px';
			menu.style.transform = 'translateX(-50%)';
			menu.style.zIndex = '1000';
			menu.style.padding = '16px';
			menu.style.minWidth = '280px';

			const title = document.createElement('div');
			title.textContent = 'Filtrar por valor del pedido';
			title.style.fontWeight = '600';
			title.style.marginBottom = '12px';
			title.style.fontSize = '14px';
			menu.appendChild(title);

			// Min amount input
			const minWrap = document.createElement('div');
			minWrap.style.marginBottom = '12px';
			const minLabel = document.createElement('label');
			minLabel.textContent = 'Valor mínimo:';
			minLabel.style.display = 'block';
			minLabel.style.fontSize = '12px';
			minLabel.style.marginBottom = '4px';
			minLabel.style.opacity = '0.8';
			const minInput = document.createElement('input');
			minInput.type = 'number';
			minInput.placeholder = 'Sin mínimo';
			minInput.value = minAmount !== null ? String(minAmount) : '';
			minInput.style.width = '100%';
			minInput.style.padding = '8px';
			minInput.style.border = '1px solid rgba(0,0,0,0.2)';
			minInput.style.borderRadius = '4px';
			minInput.style.fontSize = '14px';
			minWrap.append(minLabel, minInput);
			menu.appendChild(minWrap);

			// Max amount input
			const maxWrap = document.createElement('div');
			maxWrap.style.marginBottom = '12px';
			const maxLabel = document.createElement('label');
			maxLabel.textContent = 'Valor máximo:';
			maxLabel.style.display = 'block';
			maxLabel.style.fontSize = '12px';
			maxLabel.style.marginBottom = '4px';
			maxLabel.style.opacity = '0.8';
			const maxInput = document.createElement('input');
			maxInput.type = 'number';
			maxInput.placeholder = 'Sin máximo';
			maxInput.value = maxAmount !== null ? String(maxAmount) : '';
			maxInput.style.width = '100%';
			maxInput.style.padding = '8px';
			maxInput.style.border = '1px solid rgba(0,0,0,0.2)';
			maxInput.style.borderRadius = '4px';
			maxInput.style.fontSize = '14px';
			maxWrap.append(maxLabel, maxInput);
			menu.appendChild(maxWrap);

			// Action buttons
			const actions = document.createElement('div');
			actions.style.display = 'flex';
			actions.style.gap = '8px';
			actions.style.marginTop = '8px';
			actions.style.paddingTop = '12px';
			actions.style.borderTop = '1px solid rgba(0,0,0,0.1)';

			const clearBtn = document.createElement('button');
			clearBtn.className = 'press-btn';
			clearBtn.textContent = 'Limpiar';
			clearBtn.style.flex = '1';
			clearBtn.addEventListener('click', () => {
				minAmount = null;
				maxAmount = null;
				cleanup();
				load();
			});

			const applyBtn = document.createElement('button');
			applyBtn.className = 'press-btn btn-primary';
			applyBtn.textContent = 'Aplicar';
			applyBtn.style.flex = '1';
			applyBtn.addEventListener('click', () => {
				const minVal = minInput.value.trim();
				const maxVal = maxInput.value.trim();
				minAmount = minVal ? Number(minVal) : null;
				maxAmount = maxVal ? Number(maxVal) : null;
				cleanup();
				load();
			});

			const cancelBtn = document.createElement('button');
			cancelBtn.className = 'press-btn';
			cancelBtn.textContent = 'Cancelar';
			cancelBtn.style.flex = '1';
			cancelBtn.addEventListener('click', cleanup);

			actions.append(cancelBtn, clearBtn, applyBtn);
			menu.appendChild(actions);

			document.body.appendChild(menu);

			// Position adjustment to keep in viewport
			const rect = menu.getBoundingClientRect();
			let left = anchorX;
			let top = anchorY + 8;
			
			if (left + rect.width / 2 > window.innerWidth - 10) {
				left = window.innerWidth - rect.width / 2 - 10;
			}
			if (left - rect.width / 2 < 10) {
				left = rect.width / 2 + 10;
			}
			if (top + rect.height > window.innerHeight - 10) {
				top = anchorY - rect.height - 8;
			}

			menu.style.left = left + 'px';
			menu.style.top = top + 'px';

			// Auto-focus first input
			setTimeout(() => minInput.focus(), 100);

			function outside(e) {
				if (!menu.contains(e.target)) cleanup();
			}
			function cleanup() {
				document.removeEventListener('mousedown', outside, true);
				document.removeEventListener('touchstart', outside, true);
				if (menu.parentNode) menu.parentNode.removeChild(menu);
			}
			setTimeout(() => {
				document.addEventListener('mousedown', outside, true);
				document.addEventListener('touchstart', outside, true);
			}, 0);
		}

		function openPaymentDateFilterMenu(anchorX, anchorY) {
			// Gather payment dates from currently loaded cards (within current filters except payment-date itself)
			const dateSet = new Set();
			const cards = grid.querySelectorAll('.transfer-card .transfer-meta');
			cards.forEach(meta => {
				const d = meta?.dataset?.paymentDate || '';
				if (d) dateSet.add(String(d).slice(0,10));
			});
			const uniqueDates = Array.from(dateSet).sort((a,b) => b.localeCompare(a));

			const menu = document.createElement('div');
			menu.className = 'pay-menu';
			menu.style.position = 'fixed';
			menu.style.left = anchorX + 'px';
			menu.style.top = anchorY + 'px';
			menu.style.transform = 'translateX(-50%)';
			menu.style.zIndex = '1000';
			menu.style.maxHeight = '320px';
			menu.style.overflowY = 'auto';
			menu.style.padding = '8px';
			menu.style.minWidth = '200px';

			// All option
			const allWrap = document.createElement('label');
			allWrap.style.display = 'flex';
			allWrap.style.alignItems = 'center';
			allWrap.style.gap = '8px';
			allWrap.style.padding = '4px 8px';
			allWrap.style.cursor = 'pointer';
			allWrap.style.borderBottom = '1px solid rgba(0,0,0,0.1)';
			allWrap.style.marginBottom = '6px';
			const allCheck = document.createElement('input');
			allCheck.type = 'checkbox';
			allCheck.checked = selectedPaymentDates.length === 0;
			const allLabel = document.createElement('span');
			allLabel.textContent = 'Todas';
			allLabel.style.fontWeight = '600';
			allWrap.append(allCheck, allLabel);
			allCheck.addEventListener('change', () => {
				if (allCheck.checked) {
					selectedPaymentDates = [];
					paymentDateFilterLabel.textContent = 'Todas';
					applyPaymentDateFilter();
					cleanup();
				}
			});
			menu.appendChild(allWrap);

			// Individual date checkboxes
			for (const d of uniqueDates) {
				const wrap = document.createElement('label');
				wrap.style.display = 'flex';
				wrap.style.alignItems = 'center';
				wrap.style.gap = '8px';
				wrap.style.padding = '4px 8px';
				wrap.style.cursor = 'pointer';
				wrap.style.borderRadius = '4px';
				wrap.addEventListener('mouseenter', () => { wrap.style.backgroundColor = 'rgba(0,0,0,0.05)'; });
				wrap.addEventListener('mouseleave', () => { wrap.style.backgroundColor = ''; });
				const cb = document.createElement('input');
				cb.type = 'checkbox';
				cb.checked = selectedPaymentDates.includes(d);
				const label = document.createElement('span');
				label.textContent = String(d);
				wrap.append(cb, label);
				cb.addEventListener('change', () => {
					if (cb.checked) {
						if (!selectedPaymentDates.includes(d)) selectedPaymentDates.push(d);
					} else {
						selectedPaymentDates = selectedPaymentDates.filter(x => x !== d);
					}
					updatePaymentDateFilterLabel();
					applyPaymentDateFilter();
				});
				menu.appendChild(wrap);
			}

			document.body.appendChild(menu);
			// Keep in viewport
			const rect = menu.getBoundingClientRect();
			let left = anchorX; let top = anchorY + 8;
			if (left + rect.width / 2 > window.innerWidth - 10) left = window.innerWidth - rect.width / 2 - 10;
			if (left - rect.width / 2 < 10) left = rect.width / 2 + 10;
			if (top + rect.height > window.innerHeight - 10) top = anchorY - rect.height - 8;
			menu.style.left = left + 'px';
			menu.style.top = top + 'px';

			function outside(e) { if (!menu.contains(e.target)) cleanup(); }
			function cleanup(){ document.removeEventListener('mousedown', outside, true); document.removeEventListener('touchstart', outside, true); if (menu.parentNode) menu.parentNode.removeChild(menu); }
			setTimeout(() => { document.addEventListener('mousedown', outside, true); document.addEventListener('touchstart', outside, true); }, 0);
		}

		function updatePaymentDateFilterLabel(){
			if (selectedPaymentDates.length === 0) { paymentDateFilterLabel.textContent = 'Todas'; return; }
			if (selectedPaymentDates.length === 1) { paymentDateFilterLabel.textContent = selectedPaymentDates[0]; return; }
			paymentDateFilterLabel.textContent = `${selectedPaymentDates.length} fechas`;
		}

		function applyPaymentDateFilter(){
			// Re-render by re-running load to respect all filters (users, amount)
			load();
		}

		// Lightweight embed of openRangeCalendarPopover from app.js if not present
		if (typeof window.openRangeCalendarPopover !== 'function') {
			window.openRangeCalendarPopover = function(onPickedRange, anchorX, anchorY, opts){
				const pop = document.createElement('div'); pop.className = 'date-popover'; pop.style.position = 'fixed'; const baseX = anchorX||window.innerWidth/2; const baseY = anchorY||window.innerHeight/2; pop.style.left = baseX+'px'; pop.style.top=(baseY+8)+'px'; pop.style.transform='translate(-50%,0)'; pop.style.zIndex='1000';
				const months = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre']; let view = new Date(); view.setDate(1); let startIso=null, endIso=null;
				const header=document.createElement('div'); header.className='date-popover-header'; const prev=document.createElement('button'); prev.className='date-nav'; prev.textContent='‹'; const label=document.createElement('div'); label.className='date-label'; const next=document.createElement('button'); next.className='date-nav'; next.textContent='›'; header.append(prev,label,next);
				const grid=document.createElement('div'); grid.className='date-grid'; const weekdays=['L','M','X','J','V','S','D']; const wk=document.createElement('div'); wk.className='date-weekdays'; for (const w of weekdays){ const c=document.createElement('div'); c.textContent=w; wk.appendChild(c);} 
				function isoUTC(y,m,d){ return new Date(Date.UTC(y,m,d)).toISOString().slice(0,10); }
				function isBetween(x,a,b){ return x>=a && x<=b; }
				function render(){ label.textContent = months[view.getMonth()] + ' ' + view.getFullYear(); grid.innerHTML=''; const year=view.getFullYear(); const month=view.getMonth(); const firstDay=(new Date(Date.UTC(year,month,1)).getUTCDay()+6)%7; const daysInMonth=new Date(Date.UTC(year,month+1,0)).getUTCDate(); for (let i=0;i<firstDay;i++){ const cell=document.createElement('button'); cell.className='date-cell disabled'; cell.disabled=true; grid.appendChild(cell);} for (let d=1; d<=daysInMonth; d++){ const iso=isoUTC(year,month,d); const cell=document.createElement('button'); let cls='date-cell'; if (startIso && !endIso && iso===startIso) cls+=' range-start selected'; if (startIso && endIso){ if (iso===startIso) cls+=' range-start selected'; else if (iso===endIso) cls+=' range-end selected'; else if (isBetween(iso,startIso,endIso)) cls+=' in-range'; } cell.className=cls; cell.textContent=String(d); cell.addEventListener('click',()=>{ if(!startIso){ startIso=iso; endIso=null; render(); return; } if(!endIso){ if(iso<startIso){ endIso=startIso; startIso=iso; } else { endIso=iso; } render(); return; } startIso=iso; endIso=null; render(); }); grid.appendChild(cell);} }
				function cleanup(){ document.removeEventListener('mousedown', outside, true); document.removeEventListener('touchstart', outside, true); if(pop.parentNode) pop.parentNode.removeChild(pop);} function outside(ev){ if(!pop.contains(ev.target)) cleanup(); }
				prev.addEventListener('click',()=>{ view.setMonth(view.getMonth()-1); render(); }); next.addEventListener('click',()=>{ view.setMonth(view.getMonth()+1); render(); });
				const actions=document.createElement('div'); actions.style.display='flex'; actions.style.justifyContent='space-between'; actions.style.marginTop='8px'; const clearBtn=document.createElement('button'); clearBtn.className='date-nav'; clearBtn.textContent='Limpiar'; const genBtn=document.createElement('button'); genBtn.className='date-nav'; genBtn.textContent='Generar'; genBtn.disabled=true; clearBtn.addEventListener('click',()=>{ startIso=null; endIso=null; genBtn.disabled=true; render(); }); genBtn.addEventListener('click',()=>{ if(startIso && endIso && typeof onPickedRange==='function'){ cleanup(); onPickedRange({ start:startIso, end:endIso }); } }); actions.append(clearBtn, genBtn);
				const origRender = render; render = function(){ origRender(); genBtn.disabled = !(startIso && endIso); };
				pop.append(header, wk, grid, actions); document.body.appendChild(pop); pop.classList.add('aladdin-pop');
				document.addEventListener('mousedown', outside, true); document.addEventListener('touchstart', outside, true); render();
			};
		}

		function openLightbox(src, noteText){
			const backdrop = document.createElement('div'); backdrop.className = 'lightbox-backdrop';
			const box = document.createElement('div'); box.className = 'lightbox';
			const imgContainer = document.createElement('div'); imgContainer.className = 'lightbox-img-container';
			const img = document.createElement('img'); img.src = src; img.alt = 'Comprobante';
			imgContainer.appendChild(img);
			const actions = document.createElement('div'); actions.className = 'lightbox-actions';
			const closeBtn = document.createElement('button'); closeBtn.className = 'press-btn'; closeBtn.textContent = 'Cerrar';
			const downBtn = document.createElement('button'); downBtn.className = 'press-btn'; downBtn.textContent = 'Descargar';
			closeBtn.addEventListener('click', cleanup);
			downBtn.addEventListener('click', () => {
				const a = document.createElement('a'); a.href = src; a.download = `comprobante_${Date.now()}.jpg`; document.body.appendChild(a); a.click(); a.remove();
			});
			function outside(e){ if (!box.contains(e.target)) cleanup(); }
			function cleanup(){ document.removeEventListener('mousedown', outside, true); if (backdrop.parentNode) backdrop.parentNode.removeChild(backdrop); }
			actions.append(closeBtn, downBtn); 
			box.appendChild(imgContainer);
			if (noteText && noteText.trim()) {
				const noteContainer = document.createElement('div'); 
				noteContainer.className = 'lightbox-note';
				noteContainer.textContent = noteText;
				box.appendChild(noteContainer);
			}
			box.appendChild(actions);
			backdrop.appendChild(box); 
			document.body.appendChild(backdrop);
			setTimeout(() => document.addEventListener('mousedown', outside, true), 0);
		}

		load();
	})();
	</script>
</body>
</html>

